import{u as le}from"./use-menu-CupLMQve.js";import{_ as oe,e as ae,c as _,b as i,d as a,r as p,F as G,A as ne,z as ie,g as y,i as de,H as h,G as w,o as u,a as e,J as r,x as T,I as B,q as d}from"./index-u6IXU-LR.js";import{U as re}from"./UploadOutlined-Cy_IfkRA.js";const ue=ae({components:{UploadOutlined:re},setup(){le().onSelectedKeys(["creator-documents-template"]);const s=ne(),t=ie(),$=y(!1),q=y([]),E={authorization:"authorization-text"},k=y([]),V=y([]),C=y(),f=y(),v=y(!1),g=y({name:"",document_type_id:null,description:""}),F=y({file:null});de(async()=>{await s.fetchDocumentTemplates(),k.value=s.document_templates,await s.fetchDocumentTypes(),V.value=s.document_types});const N={name:[{required:!0,message:"Vui lòng nhập tên mẫu văn bản"},{max:100,message:"Tên mẫu văn bản không được quá 100 ký tự"}],document_type_id:[{required:!0,message:"Vui lòng chọn loại văn bản"}]},S={file:[{required:!0,message:"Vui lòng chọn file PDF",trigger:"blur"}]},D=(l,o)=>o.label.toLowerCase().indexOf(l.toLowerCase())>=0,z=()=>{$.value=!0};function R({onSuccess:l}){setTimeout(()=>{l("ok")},0)}function I(l){const o=l.type==="application/pdf";return o||h.error("Bạn chỉ có thể upload file PDF!"),o}function A(l){let o;if(l.originFileObj)o=l.originFileObj;else if(l.url){window.open(l.url,"_blank");return}const m=URL.createObjectURL(o);window.open(m,"_blank")}const j=l=>{var o;F.file=l.fileList.length>0?l.fileList[0]:null,(o=f.value)==null||o.validateFields(["file"])},O=async({file:l,documentTemplateId:o})=>{try{const m=new FormData;return m.append("upload_file",l),m.append("document_template_id",o),{status:200,message:"File uploaded successfully",data:(await w.post("/api/document-templates/upload-file",m,{headers:{"Content-Type":"multipart/form-data"}})).data}}catch{return{status:500,message:"Lỗi khi upload file"}}},n=async l=>{try{const o=await w.post("/api/notifications/all-admins",l);o.status===201?console.log("Notification sent successfully:",o.data):console.error("Failed to send notification:",o)}catch(o){console.error("Error sending notification:",o)}},M=async()=>{try{await C.value.validateFields(),await f.value.validateFields(["file"]),v.value=!0;const l=t.role==="admin"?"active":"pending",o={...g.value,created_by:t.user.id,document_type_id:g.value.document_type_id,status:l};console.log("New Template Data:",o);const m=await w.post("/api/document-templates",o);if(m.status!==201)throw new Error("Failed to create document template");const P=F.file.originFileObj,se=m.data.document_template.id;if((await O({file:P,documentTemplateId:se})).status!==200)throw new Error("Failed to upload file");await n({notification_category_id:1,from_user_id:t.user.id,title:"Mẫu văn bản mới",content:`Đề xuất mẫu văn bản "${o.name}".`}),h.success("Thêm mẫu văn bản thành công!"),k.value.push(o),g.value={name:"",document_type_id:null,description:""},F.value={file:null},$.value=!1}catch(l){console.error("Validation failed:",l),h.error("Đã xảy ra lỗi khi thêm mẫu văn bản. Vui lòng kiểm tra lại thông tin.")}finally{v.value=!1}},c=y(!1),U=y(null),b=y(null),L=async(l,o)=>{console.log("Viewing details for:",l),c.value=!0,b.value=o;try{if(v.value=!0,c.value=!0,l.creator&&l.document_type)U.value=l;else{const m=await w.get(`/api/document-templates/${l.id}`);U.value=m.data.document_template}}catch(m){console.error("Error loading template details:",m),h.error("Không thể tải thông tin chi tiết")}finally{v.value=!1}},J=(l,o)=>({onClick:()=>{L(l,o)},style:{cursor:"pointer"}}),X=l=>({active:"green",pending:"orange",inactive:"red"})[l]||"default",Q=l=>({active:"Được sử dụng",pending:"Chờ duyệt",inactive:"Tạm ngừng sử dụng"})[l]||l,W=l=>l?l.split("/").pop()||l:"",Y=l=>{if(!l)return"";const o=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(l)/Math.log(1024));return Math.round(l/Math.pow(1024,m)*100)/100+" "+o[m]},Z=async l=>{if(l.file_path){const o=`${K}/documents/${l.file_path}`;await w.get(`/api/document-templates/${l.id}/download`),window.open(o,"_blank"),k.value[b.value].downloaded+=1}else h.warning("Không có file để xem")},x=l=>l?new Date(l).toLocaleString("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",K="https://tminh.id.vn",H=y(""),ee=async l=>{try{const o=await w.get(`/api/document-templates/${l.id}/download`);H.value=o.data.download_url,await w.get(`/documents/${H.value}`)}catch{h.error("Không thể tải file")}},te=l=>l>100||l==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${l}`;return{apiUrl:K,document_templates:k,document_types:V,columns:[{title:"Tên văn bản mẫu",dataIndex:"name",key:"name",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center"},{title:"Mô tả",dataIndex:"description",key:"description",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Người tạo",dataIndex:"created_by",key:"created_by",width:150,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"}],templateModalVisible:$,upload_files:q,headers:E,rules:N,uploadRules:S,formRef:C,uploadFormRef:f,formData:g,uploadData:F,loading:v,filterOption:D,showModalAddTemplate:z,handleCustomRequest:R,beforeUpload:I,handlePreview:A,handleFileChange:j,handleAddTemplate:M,customRow:J,detailModalVisible:c,selectedTemplate:U,viewDetail:L,getStatusColor:X,getStatusText:Q,previewFile:Z,getFileName:W,formatFileSize:Y,formatDateTime:x,fetchFileUrl:ee,getAvatarUrl:(l,o)=>l?`${K}/images/avatars/${l}`:te(o),handleLikeTemplate:async l=>{try{v.value=!0,(await w.post(`/api/document-templates/${l.id}/like`)).status===200?(l.liked+=1,l.userHasLike=!0,h.success("Đã thích mẫu văn bản này")):h.error("Không thể thích mẫu văn bản này")}catch(o){console.error("Error liking template:",o),h.error("Đã xảy ra lỗi khi thích mẫu văn bản")}finally{v.value=!1}},handleUnikeTemplate:async l=>{try{v.value=!0,(await w.post(`/api/document-templates/${l.id}/unlike`)).status===200?(l.liked-=1,l.userHasLike=!1,h.success("Đã bỏ thích mẫu văn bản này")):h.error("Không thể bỏ thích mẫu văn bản này")}catch(o){console.error("Error unliking template:",o),h.error("Đã xảy ra lỗi khi bỏ thích mẫu văn bản")}finally{v.value=!1}},onRefresh:async()=>{v.value=!0;try{await s.fetchDocumentTemplates(!0),k.value=s.document_templates,k.value=k.value.filter(l=>l.status==="active"||l.creator.id===t.user.id),h.success("Đã làm mới danh sách mẫu văn bản")}catch(l){console.error("Error refreshing templates:",l),h.error("Không thể làm mới danh sách mẫu văn bản")}finally{v.value=!1}}}}}),ce={class:"row mb-3"},me={class:"col-12"},pe={class:"row g-2"},fe={class:"col-12 col-md-4"},ve={class:"col-12 col-md-8"},he={class:"row g-2"},ye={class:"col-6 col-md-3"},ge={class:"col-6 col-md-3"},_e={class:"col-6 col-md-1 d-flex align-items-center justify-content-end"},be={class:"col-6 col-md-1 d-flex align-items-center justify-content-end"},we={class:"row mb-3 d-flex justify-content-end"},ke={class:"col-3"},Te={class:"row"},Ce={class:"col-12"},Fe={class:""},De={class:""},Ue={key:3},Me={class:"row d-flex justify-content-end g-2"},Le={class:"row"},$e={class:"col-12"},Ve={class:"row"},Re={class:"col-12"},Ae={class:"row d-flex justify-content-end g-2"},Be={key:0},Ne={key:0,class:"template-detail"},Se={class:"row mb-3"},ze={class:"col-12"},Ie={class:"text-primary mb-2"},je={class:"row mb-3"},Oe={class:"col-6"},Ke={class:"info-item"},qe={class:"mt-1"},Ee={class:"col-6"},He={class:"info-item"},Pe={class:"mt-1"},Ge={class:"row mb-3"},Je={class:"col-12"},Xe={class:"info-item"},Qe={class:"mt-2 p-3 bg-light rounded"},We={key:0,class:"mb-0"},Ye={key:1,class:"mb-0 text-muted"},Ze={class:"row mb-3"},xe={class:"col-12"},et={class:"info-item"},tt={class:"mt-2"},st={key:0,class:"file-item d-flex align-items-center justify-content-between p-3 border rounded bg-white"},lt={class:"d-flex align-items-center"},ot={class:"fw-medium"},at={class:"text-muted"},nt={class:"file-actions"},it={key:1,class:"text-muted text-center p-3 border rounded bg-light"},dt={class:"row mb-3"},rt={class:"col-6"},ut={class:"stat-card text-center p-3 border rounded bg-primary bg-opacity-10"},ct={class:"stat-number text-primary fs-4 fw-bold"},mt={class:"col-6"},pt={class:"stat-card text-center p-3 border rounded bg-opacity-10",style:{"background-color":"rgba(247, 82, 123, 0.3)"}},ft={class:"stat-number fs-4 fw-bold",style:{color:"#f7527b"}},vt={class:"row"},ht={class:"col-12"},yt={class:"creator-info p-3 border rounded bg-light"},gt={class:"row align-items-center"},_t={class:"col-auto"},bt={class:"col"},wt={class:"fw-medium"},kt={class:"text-muted"},Tt={key:1,class:"text-center py-5"};function Ct(s,t,$,q,E,k){const V=p("a-input-search"),C=p("a-select"),f=p("a-button"),v=p("a-tooltip"),g=p("a-tag"),F=p("a-table"),N=p("a-card"),S=p("a-input"),D=p("a-form-item"),z=p("a-textarea"),R=p("a-form"),I=p("a-upload"),A=p("a-modal"),j=p("a-avatar"),O=p("a-spin");return u(),_(G,null,[i(N,{title:"",style:{width:"100%"}},{default:a(()=>[t[20]||(t[20]=e("h2",{class:"fw-bold mb-3"},"Mẫu Văn Bản",-1)),e("div",ce,[e("div",me,[e("div",pe,[e("div",fe,[i(V,{placeholder:"Tìm kiếm","allow-clear":"","enter-button":"",class:"w-100"})]),e("div",ve,[e("div",he,[e("div",ye,[i(C,{value:s.status_id,"onUpdate:value":t[0]||(t[0]=n=>s.status_id=n),"show-search":"",placeholder:"Trạng thái",options:s.documents_status,"filter-option":s.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",ge,[i(C,{value:s.type_id,"onUpdate:value":t[1]||(t[1]=n=>s.type_id=n),"show-search":"",placeholder:"Loại văn bản",options:s.documents_type,"filter-option":s.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",_e,[i(f,{type:"primary",class:"w-100 w-md-auto"},{default:a(()=>t[13]||(t[13]=[e("i",{class:"fa-solid fa-filter"},null,-1)])),_:1})]),e("div",be,[i(f,{type:"default",class:"w-100 w-md-auto",onClick:s.onRefresh},{default:a(()=>t[14]||(t[14]=[e("i",{class:"fa-solid fa-rotate"},null,-1)])),_:1},8,["onClick"])])])])])])]),e("div",we,[e("div",ke,[i(f,{type:"primary",class:"w-100 w-md-auto",onClick:s.showModalAddTemplate},{default:a(()=>t[15]||(t[15]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),r(" Thêm mẫu mới ")])),_:1},8,["onClick"])])]),e("div",Te,[e("div",Ce,[i(F,{dataSource:s.document_templates,columns:s.columns,scroll:{x:576},bordered:"",customRow:s.customRow},{bodyCell:a(({column:n,index:M,record:c})=>[n.key==="type"?(u(),T(v,{key:0},{title:a(()=>[e("span",Fe,d(c.document_type.description),1)]),default:a(()=>[e("span",null,d(c.document_type.name),1)]),_:2},1024)):B("",!0),n.key==="status"?(u(),_(G,{key:1},[c.status==="active"?(u(),T(g,{key:0,color:"green"},{default:a(()=>t[16]||(t[16]=[r(d("Hoạt động"))])),_:1})):c.status==="pending"?(u(),T(g,{key:1,color:"orange"},{default:a(()=>t[17]||(t[17]=[r(d("Chờ duyệt"))])),_:1})):c.status==="inactive"?(u(),T(g,{key:2,color:"red"},{default:a(()=>t[18]||(t[18]=[r(d("Không hoạt động"))])),_:1})):c.status==="reject"?(u(),T(g,{key:3,color:"volcano"},{default:a(()=>t[19]||(t[19]=[r(d("Bị từ chối"))])),_:1})):B("",!0)],64)):n.key==="created_by"?(u(),T(v,{key:2},{title:a(()=>[e("span",De,d(c.creator.position_title),1)]),default:a(()=>[e("span",null,d(c.creator.name),1)]),_:2},1024)):n.key==="created_at"?(u(),_("span",Ue,d(s.formatDateTime(c.created_at)),1)):B("",!0)]),_:1},8,["dataSource","columns","customRow"])])])]),_:1}),i(A,{open:s.templateModalVisible,"onUpdate:open":t[7]||(t[7]=n=>s.templateModalVisible=n),width:"500px",centered:"","z-index":1003},{title:a(()=>t[21]||(t[21]=[e("span",{class:"fw-bold"},"Thêm mẫu mới",-1)])),footer:a(()=>[e("div",Me,[i(f,{type:"primary",class:"col-3",onClick:s.handleAddTemplate,loading:s.loading},{default:a(()=>t[22]||(t[22]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),r(" Thêm mới ")])),_:1},8,["onClick","loading"]),i(f,{type:"default",class:"col-2",onClick:t[2]||(t[2]=n=>s.templateModalVisible=!1)},{default:a(()=>t[23]||(t[23]=[e("i",{class:"fa-solid fa-xmark me-2"},null,-1),r(" Đóng ")])),_:1})])]),default:a(()=>[e("div",Le,[e("div",$e,[i(R,{ref:"formRef",model:s.formData,rules:s.rules,layout:"vertical"},{default:a(()=>[i(D,{label:"Tên mẫu văn bản",name:"name","has-feedback":""},{default:a(()=>[i(S,{value:s.formData.name,"onUpdate:value":t[3]||(t[3]=n=>s.formData.name=n),"allow-clear":"",placeholder:"Nhập tên mẫu văn bản"},null,8,["value"])]),_:1}),i(D,{label:"Loại văn bản",name:"document_type_id","has-feedback":""},{default:a(()=>[i(C,{value:s.formData.document_type_id,"onUpdate:value":t[4]||(t[4]=n=>s.formData.document_type_id=n),"show-search":"",placeholder:"Chọn loại văn bản",options:s.document_types,"filter-option":s.filterOption,"allow-clear":"","list-height":200,"dropdown-style":{position:"fixed",zIndex:1e4,background:"white",border:"1px solid #ccc"}},null,8,["value","options","filter-option"])]),_:1}),i(D,{label:"Mô tả",name:"description"},{default:a(()=>[i(z,{value:s.formData.description,"onUpdate:value":t[5]||(t[5]=n=>s.formData.description=n),rows:"4",placeholder:"Nhập mô tả cho mẫu văn bản"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])])]),e("div",Ve,[e("div",Re,[t[25]||(t[25]=e("h6",null,"Tệp tin đính kèm",-1)),i(R,{ref:"uploadFormRef",model:s.uploadData,rules:s.uploadRules},{default:a(()=>[i(D,{name:"file"},{default:a(()=>[i(I,{"file-list":s.uploadData.file,"onUpdate:fileList":t[6]||(t[6]=n=>s.uploadData.file=n),name:"file",accept:".pdf",headers:s.headers,"show-upload-list":!0,"custom-request":s.handleCustomRequest,"before-upload":s.beforeUpload,"max-count":1,onPreview:s.handlePreview,onChange:s.handleFileChange},{default:a(()=>[i(f,null,{default:a(()=>t[24]||(t[24]=[e("span",null,[e("i",{class:"bi bi-upload me-2"}),r("Chọn file PDF ")],-1)])),_:1})]),_:1},8,["file-list","headers","custom-request","before-upload","onPreview","onChange"])]),_:1})]),_:1},8,["model","rules"])])])]),_:1},8,["open"]),i(A,{open:s.detailModalVisible,"onUpdate:open":t[12]||(t[12]=n=>s.detailModalVisible=n),width:"600px",centered:"","z-index":1003},{title:a(()=>t[26]||(t[26]=[e("span",{class:"fw-bold"},"Chi tiết mẫu văn bản",-1)])),footer:a(()=>[e("div",Ae,[s.selectedTemplate.status==="active"?(u(),_("div",Be,[s.selectedTemplate.userHasLike?(u(),T(f,{key:1,type:"primary",class:"col-3",style:{"background-color":"rgba(247, 82, 123, 0.3)",color:"#f7527b"},onClick:t[9]||(t[9]=n=>s.handleUnikeTemplate(s.selectedTemplate))},{default:a(()=>t[28]||(t[28]=[e("i",{class:"fas fa-heart me-2"},null,-1),r("Bỏ thích ")])),_:1})):(u(),T(f,{key:0,type:"primary",class:"col-3",style:{"background-color":"rgba(247, 82, 123, 0.3)"},onClick:t[8]||(t[8]=n=>s.handleLikeTemplate(s.selectedTemplate))},{default:a(()=>t[27]||(t[27]=[e("i",{class:"fa-regular fa-heart me-2"},null,-1),r("Thích ")])),_:1}))])):B("",!0),i(f,{type:"primary",class:"col-3",onClick:t[10]||(t[10]=n=>s.detailModalVisible=!1)},{default:a(()=>t[29]||(t[29]=[e("i",{class:"fa-solid fa-check me-2"},null,-1),r(" Đóng ")])),_:1})])]),default:a(()=>{var n,M,c,U;return[s.selectedTemplate?(u(),_("div",Ne,[e("div",Se,[e("div",ze,[e("h5",Ie,[t[30]||(t[30]=e("i",{class:"fa-solid fa-file-text me-2"},null,-1)),r(" "+d(s.selectedTemplate.name),1)])])]),e("div",je,[e("div",Oe,[e("div",Ke,[t[31]||(t[31]=e("label",{class:"fw-bold text-muted"},"Loại văn bản:",-1)),e("div",qe,[i(g,{class:"px-2 py-1"},{default:a(()=>{var b;return[r(d((b=s.selectedTemplate.document_type)==null?void 0:b.name),1)]}),_:1})])])]),e("div",Ee,[e("div",He,[t[32]||(t[32]=e("label",{class:"fw-bold text-muted"},"Trạng thái:",-1)),e("div",Pe,[i(g,{color:s.getStatusColor(s.selectedTemplate.status),class:"px-2 py-1"},{default:a(()=>[r(d(s.getStatusText(s.selectedTemplate.status)),1)]),_:1},8,["color"])])])])]),e("div",Ge,[e("div",Je,[e("div",Xe,[t[34]||(t[34]=e("label",{class:"fw-bold text-muted"},"Mô tả:",-1)),e("div",Qe,[s.selectedTemplate.description?(u(),_("p",We,d(s.selectedTemplate.description),1)):(u(),_("p",Ye,t[33]||(t[33]=[e("i",null,"Chưa có mô tả",-1)])))])])])]),e("div",Ze,[e("div",xe,[e("div",et,[t[38]||(t[38]=e("label",{class:"fw-bold text-muted"},"File đính kèm:",-1)),e("div",tt,[s.selectedTemplate.file_path?(u(),_("div",st,[e("div",lt,[t[35]||(t[35]=e("i",{class:"fa-solid fa-file-pdf text-danger me-2 fs-4"},null,-1)),e("div",null,[e("div",ot,d(s.getFileName(s.selectedTemplate.file_path)),1),e("small",at,d(s.formatFileSize(s.selectedTemplate.file_size)),1)])]),e("div",nt,[i(f,{type:"link",size:"small",onClick:t[11]||(t[11]=b=>s.previewFile(s.selectedTemplate)),class:"me-2"},{default:a(()=>t[36]||(t[36]=[e("i",{class:"fa-solid fa-eye me-1"},null,-1),r(" Xem ")])),_:1})])])):(u(),_("div",it,t[37]||(t[37]=[e("i",{class:"fa-solid fa-file-slash me-2"},null,-1),r(" Không có file đính kèm ")])))])])])]),e("div",dt,[e("div",rt,[e("div",ut,[e("div",ct,d(s.selectedTemplate.downloaded||0),1),t[39]||(t[39]=e("div",{class:"stat-label text-muted"},[e("span",{class:"text-primary"},[e("i",{class:"fa-solid fa-eye me-1"}),r(" Lượt xem ")])],-1))])]),e("div",mt,[e("div",pt,[e("div",ft,d(s.selectedTemplate.liked||0),1),t[40]||(t[40]=e("div",{class:"stat-label text-muted"},[e("span",{style:{color:"#f7527b"}},[e("i",{class:"fa-solid fa-heart me-1"}),r(" Lượt thích ")])],-1))])])]),e("div",vt,[e("div",ht,[e("div",yt,[e("div",gt,[e("div",_t,[i(j,{src:s.getAvatarUrl((n=s.selectedTemplate.creator)==null?void 0:n.avatar,(M=s.selectedTemplate.creator)==null?void 0:M.id),size:40,class:"me-3"},{default:a(()=>{var b,L;return[r(d((L=(b=s.selectedTemplate.creator)==null?void 0:b.name)==null?void 0:L.charAt(0)),1)]}),_:1},8,["src"])]),e("div",bt,[e("div",wt,[e("span",null,d((c=s.selectedTemplate.creator)==null?void 0:c.name)+" - "+d((U=s.selectedTemplate.creator)==null?void 0:U.full_name_with_role),1)]),e("small",kt," Tạo lúc: "+d(s.formatDateTime(s.selectedTemplate.created_at)),1)])])])])])])):(u(),_("div",Tt,[i(O,{size:"large"}),t[41]||(t[41]=e("div",{class:"mt-3 text-muted"},"Đang tải thông tin...",-1))]))]}),_:1},8,["open"])],64)}const Bt=oe(ue,[["render",Ct]]);export{Bt as default};
