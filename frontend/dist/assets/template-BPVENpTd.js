import{u as ie}from"./use-menu-PhBV_0w2.js";import{_ as de,e as re,c as w,b as i,d as a,r as f,F as W,A as ue,z as ce,g,i as me,H as c,G as _,o as m,a as e,N as u,x as T,I as P,q as d}from"./index-C78nIXCd.js";import{U as pe}from"./UploadOutlined-DQCP5nhD.js";const fe=re({components:{UploadOutlined:pe},setup(){ie().onSelectedKeys(["approver-documents-template"]);const o=ue(),t=ce(),$=g(!1),H=g([]),G={authorization:"authorization-text"},b=g([]),V=g([]),C=g(),h=g(),v=g(!1),y=g({name:"",document_type_id:null,description:""}),F=g({file:null});me(async()=>{await o.fetchDocumentTemplates(),b.value=o.document_templates,b.value=b.value.filter(s=>s.status==="active"||s.creator.id===t.user.id),await o.fetchDocumentTypes(),V.value=o.document_types});const N={name:[{required:!0,message:"Vui lòng nhập tên mẫu văn bản"},{max:100,message:"Tên mẫu văn bản không được quá 100 ký tự"}],document_type_id:[{required:!0,message:"Vui lòng chọn loại văn bản"}]},R={file:[{required:!0,message:"Vui lòng chọn file PDF",trigger:"blur"}]},U=(s,l)=>l.label.toLowerCase().indexOf(s.toLowerCase())>=0,B=()=>{$.value=!0};function L({onSuccess:s}){setTimeout(()=>{s("ok")},0)}function z(s){const l=s.type==="application/pdf";return l||c.error("Bạn chỉ có thể upload file PDF!"),l}function S(s){let l;if(s.originFileObj)l=s.originFileObj;else if(s.url){window.open(s.url,"_blank");return}const r=URL.createObjectURL(l);window.open(r,"_blank")}const j=s=>{var l;F.file=s.fileList.length>0?s.fileList[0]:null,(l=h.value)==null||l.validateFields(["file"])},O=async({file:s,documentTemplateId:l})=>{try{const r=new FormData;return r.append("upload_file",s),r.append("document_template_id",l),{status:200,message:"File uploaded successfully",data:(await _.post("/api/document-templates/upload-file",r,{headers:{"Content-Type":"multipart/form-data"}})).data}}catch{return{status:500,message:"Lỗi khi upload file"}}},n=async()=>{try{await C.value.validateFields(),await h.value.validateFields(["file"]),v.value=!0;const s=t.role==="admin"?"active":"pending",l={...y.value,created_by:t.user.id,document_type_id:y.value.document_type_id,status:s};console.log("New Template Data:",l);const r=await _.post("/api/document-templates",l);if(r.status!==201)throw new Error("Failed to create document template");const E=F.file.originFileObj,I=r.data.document_template.id;if((await O({file:E,documentTemplateId:I})).status!==200)throw new Error("Failed to upload file");c.success("Thêm mẫu văn bản thành công!"),b.value.push(l),y.value={name:"",document_type_id:null,description:""},F.value={file:null},$.value=!1}catch(s){console.error("Validation failed:",s),c.error("Đã xảy ra lỗi khi thêm mẫu văn bản. Vui lòng kiểm tra lại thông tin.")}finally{v.value=!1}},M=async s=>{try{const l=await _.post("/api/notifications",s);l.status===201?console.log("Notification sent successfully:",l.data):console.error("Failed to send notification:",l)}catch(l){console.error("Error sending notification:",l)}},p=async(s,l)=>{try{v.value=!0;const r=s.status;if((await _.post(`/api/document-templates/${s.id}/change-status`,{status:l})).status===200){r==="pending"?(await M({notification_category_id:1,from_user_id:t.user.id,receiver_id:s.creator.id,title:`Mẫu văn bản "${s.name}" của bạn đã được chấp thuận`,content:`Mẫu văn bản "${s.name}" đã được chấp thuận và có thể sử dụng.`}),c.success(`Mẫu văn bản "${s.name}" đã được chấp thuận để sử dụng.`)):l==="active"?c.success(`Mẫu văn bản "${s.name}" đã có thể kích hoạt.`):l==="inactive"&&c.success(`Mẫu văn bản "${s.name}" đã tạm ngừng sử dụng.`);const I=b.value.findIndex(Q=>Q.id===s.id);I!==-1&&(b.value[I].status=l)}else c.error("Đã xảy ra lỗi khi thay đổi trạng thái mẫu văn bản.")}catch(r){console.error("Error changing status:",r),c.error("Không thể thay đổi trạng thái mẫu văn bản. Vui lòng thử lại sau.")}finally{v.value=!1}},A=s=>{console.log("Showing confirm active for:",s),p(s,"active")},k=s=>{console.log("Showing confirm inactive for:",s),p(s,"inactive")},D=g(!1),K=g(null),x=g(null),X=async(s,l)=>{console.log("Viewing details for:",s),D.value=!0,x.value=l;try{if(v.value=!0,D.value=!0,s.creator&&s.document_type)K.value=s;else{const r=await _.get(`/api/document-templates/${s.id}`);K.value=r.data.document_template}}catch(r){console.error("Error loading template details:",r),c.error("Không thể tải thông tin chi tiết")}finally{v.value=!1}},Y=(s,l)=>({onClick:()=>{X(s,l)},style:{cursor:"pointer"}}),Z=s=>({active:"green",pending:"orange",inactive:"red"})[s]||"default",ee=s=>({active:"Được sử dụng",pending:"Chờ duyệt",inactive:"Tạm ngừng sử dụng"})[s]||s,te=s=>s?s.split("/").pop()||s:"",se=s=>{if(!s)return"";const l=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(s)/Math.log(1024));return Math.round(s/Math.pow(1024,r)*100)/100+" "+l[r]},q="https://tminh.id.vn",oe=async s=>{if(s.file_path){const l=`${q}/documents/${s.file_path}`;await _.get(`/api/document-templates/${s.id}/download`),window.open(l,"_blank"),b.value[x.value].downloaded+=1}else c.warning("Không có file để xem")},le=s=>s?new Date(s).toLocaleString("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",J=g(""),ae=async s=>{try{const l=await _.get(`/api/document-templates/${s.id}/download`);J.value=l.data.download_url,await _.get(`/documents/${J.value}`)}catch{c.error("Không thể tải file")}},ne=s=>s>100||s==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${s}`;return{apiUrl:q,document_templates:b,document_types:V,columns:[{title:"Tên văn bản mẫu",dataIndex:"name",key:"name",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center"},{title:"Mô tả",dataIndex:"description",key:"description",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Người tạo",dataIndex:"created_by",key:"created_by",width:150,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"}],templateModalVisible:$,upload_files:H,headers:G,rules:N,uploadRules:R,formRef:C,uploadFormRef:h,formData:y,uploadData:F,loading:v,filterOption:U,showModalAddTemplate:B,handleCustomRequest:L,beforeUpload:z,handlePreview:S,handleFileChange:j,handleAddTemplate:n,showConfirmActive:A,showConfirmInactive:k,customRow:Y,detailModalVisible:D,selectedTemplate:K,viewDetail:X,getStatusColor:Z,getStatusText:ee,previewFile:oe,getFileName:te,formatFileSize:se,formatDateTime:le,fetchFileUrl:ae,getAvatarUrl:(s,l)=>s?`${q}/images/avatars/${s}`:ne(l),handleLikeTemplate:async s=>{try{v.value=!0,(await _.post(`/api/document-templates/${s.id}/like`)).status===200?(s.liked+=1,c.success("Đã thích mẫu văn bản này")):c.error("Không thể thích mẫu văn bản này")}catch(l){console.error("Error liking template:",l),c.error("Đã xảy ra lỗi khi thích mẫu văn bản")}finally{v.value=!1}},handleUnikeTemplate:async s=>{try{v.value=!0,(await _.post(`/api/document-templates/${s.id}/unlike`)).status===200?(s.liked-=1,c.success("Đã bỏ thích mẫu văn bản này")):c.error("Không thể bỏ thích mẫu văn bản này")}catch(l){console.error("Error unliking template:",l),c.error("Đã xảy ra lỗi khi bỏ thích mẫu văn bản")}finally{v.value=!1}}}}}),ve={class:"row mb-3"},he={class:"col-12"},ge={class:"row g-2"},ye={class:"col-12 col-md-4"},_e={class:"col-12 col-md-8"},be={class:"row g-2"},we={class:"col-6 col-md-3"},ke={class:"col-6 col-md-3"},Te={class:"col-6 col-md-1 d-flex align-items-center justify-content-end"},Ce={class:"row mb-3 d-flex justify-content-end"},Fe={class:"col-3"},Ue={class:"row"},De={class:"col-12"},Me={class:""},$e={class:""},Ve={key:3},Le={class:"row d-flex justify-content-end g-2"},Se={class:"row"},Ae={class:"col-12"},Ie={class:"row"},Ne={class:"col-12"},Re={class:"row d-flex justify-content-end g-2"},Be={key:0,class:"template-detail"},ze={class:"row mb-3"},je={class:"col-12"},Oe={class:"text-primary mb-2"},Ke={class:"row mb-3"},qe={class:"col-6"},Ee={class:"info-item"},Pe={class:"mt-1"},He={class:"col-6"},Ge={class:"info-item"},xe={class:"mt-1"},Xe={class:"row mb-3"},Je={class:"col-12"},Qe={class:"info-item"},We={class:"mt-2 p-3 bg-light rounded"},Ye={key:0,class:"mb-0"},Ze={key:1,class:"mb-0 text-muted"},et={class:"row mb-3"},tt={class:"col-12"},st={class:"info-item"},ot={class:"mt-2"},lt={key:0,class:"file-item d-flex align-items-center justify-content-between p-3 border rounded bg-white"},at={class:"d-flex align-items-center"},nt={class:"fw-medium"},it={class:"text-muted"},dt={class:"file-actions"},rt={key:1,class:"text-muted text-center p-3 border rounded bg-light"},ut={class:"row mb-3"},ct={class:"col-6"},mt={class:"stat-card text-center p-3 border rounded bg-primary bg-opacity-10"},pt={class:"stat-number text-primary fs-4 fw-bold"},ft={class:"col-6"},vt={class:"stat-card text-center p-3 border rounded bg-opacity-10",style:{"background-color":"rgba(247, 82, 123, 0.3)"}},ht={class:"stat-number fs-4 fw-bold",style:{color:"#f7527b"}},gt={class:"row"},yt={class:"col-12"},_t={class:"creator-info p-3 border rounded bg-light"},bt={class:"row align-items-center"},wt={class:"col-auto"},kt={class:"col"},Tt={class:"fw-medium"},Ct={class:"text-muted"},Ft={key:1,class:"text-center py-5"};function Ut(o,t,$,H,G,b){const V=f("a-input-search"),C=f("a-select"),h=f("a-button"),v=f("a-tooltip"),y=f("a-tag"),F=f("a-table"),N=f("a-card"),R=f("a-input"),U=f("a-form-item"),B=f("a-textarea"),L=f("a-form"),z=f("a-upload"),S=f("a-modal"),j=f("a-avatar"),O=f("a-spin");return m(),w(W,null,[i(N,{title:"",style:{width:"100%"}},{default:a(()=>[t[19]||(t[19]=e("h2",{class:"fw-bold mb-3"},"Mẫu Văn Bản",-1)),e("div",ve,[e("div",he,[e("div",ge,[e("div",ye,[i(V,{placeholder:"Tìm kiếm","allow-clear":"","enter-button":"",class:"w-100"})]),e("div",_e,[e("div",be,[e("div",we,[i(C,{value:o.status_id,"onUpdate:value":t[0]||(t[0]=n=>o.status_id=n),"show-search":"",placeholder:"Trạng thái",options:o.documents_status,"filter-option":o.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",ke,[i(C,{value:o.type_id,"onUpdate:value":t[1]||(t[1]=n=>o.type_id=n),"show-search":"",placeholder:"Loại văn bản",options:o.documents_type,"filter-option":o.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",Te,[i(h,{type:"primary",class:"w-100 w-md-auto"},{default:a(()=>t[13]||(t[13]=[e("i",{class:"fa-solid fa-filter"},null,-1)])),_:1})])])])])])]),e("div",Ce,[e("div",Fe,[i(h,{type:"primary",class:"w-100 w-md-auto",onClick:o.showModalAddTemplate},{default:a(()=>t[14]||(t[14]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),u(" Thêm mẫu mới ")])),_:1},8,["onClick"])])]),e("div",Ue,[e("div",De,[i(F,{dataSource:o.document_templates,columns:o.columns,scroll:{x:576},bordered:"",customRow:o.customRow},{bodyCell:a(({column:n,index:M,record:p})=>[n.key==="type"?(m(),T(v,{key:0},{title:a(()=>[e("span",Me,d(p.document_type.description),1)]),default:a(()=>[e("span",null,d(p.document_type.name),1)]),_:2},1024)):P("",!0),n.key==="status"?(m(),w(W,{key:1},[p.status==="active"?(m(),T(y,{key:0,color:"green"},{default:a(()=>t[15]||(t[15]=[u(d("Hoạt động"))])),_:1})):p.status==="pending"?(m(),T(y,{key:1,color:"orange"},{default:a(()=>t[16]||(t[16]=[u(d("Chờ duyệt"))])),_:1})):p.status==="inactive"?(m(),T(y,{key:2,color:"red"},{default:a(()=>t[17]||(t[17]=[u(d("Không hoạt động"))])),_:1})):p.status==="reject"?(m(),T(y,{key:3,color:"volcano"},{default:a(()=>t[18]||(t[18]=[u(d("Bị từ chối"))])),_:1})):P("",!0)],64)):n.key==="created_by"?(m(),T(v,{key:2},{title:a(()=>[e("span",$e,d(p.creator.position_title),1)]),default:a(()=>[e("span",null,d(p.creator.name),1)]),_:2},1024)):n.key==="created_at"?(m(),w("span",Ve,d(o.formatDateTime(p.created_at)),1)):P("",!0)]),_:1},8,["dataSource","columns","customRow"])])])]),_:1}),i(S,{open:o.templateModalVisible,"onUpdate:open":t[7]||(t[7]=n=>o.templateModalVisible=n),width:"500px",centered:"","z-index":1003},{title:a(()=>t[20]||(t[20]=[e("span",{class:"fw-bold"},"Thêm mẫu mới",-1)])),footer:a(()=>[e("div",Le,[i(h,{type:"primary",class:"col-3",onClick:o.handleAddTemplate,loading:o.loading},{default:a(()=>t[21]||(t[21]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),u(" Thêm mới ")])),_:1},8,["onClick","loading"]),i(h,{type:"default",class:"col-2",onClick:t[2]||(t[2]=n=>o.templateModalVisible=!1)},{default:a(()=>t[22]||(t[22]=[e("i",{class:"fa-solid fa-xmark me-2"},null,-1),u(" Đóng ")])),_:1})])]),default:a(()=>[e("div",Se,[e("div",Ae,[i(L,{ref:"formRef",model:o.formData,rules:o.rules,layout:"vertical"},{default:a(()=>[i(U,{label:"Tên mẫu văn bản",name:"name","has-feedback":""},{default:a(()=>[i(R,{value:o.formData.name,"onUpdate:value":t[3]||(t[3]=n=>o.formData.name=n),"allow-clear":"",placeholder:"Nhập tên mẫu văn bản"},null,8,["value"])]),_:1}),i(U,{label:"Loại văn bản",name:"document_type_id","has-feedback":""},{default:a(()=>[i(C,{value:o.formData.document_type_id,"onUpdate:value":t[4]||(t[4]=n=>o.formData.document_type_id=n),"show-search":"",placeholder:"Chọn loại văn bản",options:o.document_types,"filter-option":o.filterOption,"allow-clear":"","list-height":200,"dropdown-style":{position:"fixed",zIndex:1e4,background:"white",border:"1px solid #ccc"}},null,8,["value","options","filter-option"])]),_:1}),i(U,{label:"Mô tả",name:"description"},{default:a(()=>[i(B,{value:o.formData.description,"onUpdate:value":t[5]||(t[5]=n=>o.formData.description=n),rows:"4",placeholder:"Nhập mô tả cho mẫu văn bản"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])])]),e("div",Ie,[e("div",Ne,[t[24]||(t[24]=e("h6",null,"Tệp tin đính kèm",-1)),i(L,{ref:"uploadFormRef",model:o.uploadData,rules:o.uploadRules},{default:a(()=>[i(U,{name:"file"},{default:a(()=>[i(z,{"file-list":o.uploadData.file,"onUpdate:fileList":t[6]||(t[6]=n=>o.uploadData.file=n),name:"file",accept:".pdf",headers:o.headers,"show-upload-list":!0,"custom-request":o.handleCustomRequest,"before-upload":o.beforeUpload,"max-count":1,onPreview:o.handlePreview,onChange:o.handleFileChange},{default:a(()=>[i(h,null,{default:a(()=>t[23]||(t[23]=[e("span",null,[e("i",{class:"bi bi-upload me-2"}),u("Chọn file PDF ")],-1)])),_:1})]),_:1},8,["file-list","headers","custom-request","before-upload","onPreview","onChange"])]),_:1})]),_:1},8,["model","rules"])])])]),_:1},8,["open"]),i(S,{open:o.detailModalVisible,"onUpdate:open":t[12]||(t[12]=n=>o.detailModalVisible=n),width:"600px",centered:"","z-index":1003},{title:a(()=>t[25]||(t[25]=[e("span",{class:"fw-bold"},"Chi tiết mẫu văn bản",-1)])),footer:a(()=>[e("div",Re,[o.selectedTemplate.userHasLike?(m(),T(h,{key:1,type:"primary",class:"col-3 bg-success",onClick:t[9]||(t[9]=n=>o.handleUnikeTemplate(o.selectedTemplate))},{default:a(()=>t[27]||(t[27]=[e("i",{class:"fas fa-heart me-2"},null,-1),u("Bỏ thích ")])),_:1})):(m(),T(h,{key:0,type:"primary",class:"col-3 bg-success",onClick:t[8]||(t[8]=n=>o.handleLikeTemplate(o.selectedTemplate))},{default:a(()=>t[26]||(t[26]=[e("i",{class:"fas fa-heart me-2"},null,-1),u("Thích ")])),_:1})),i(h,{type:"primary",class:"col-3",onClick:t[10]||(t[10]=n=>o.detailModalVisible=!1)},{default:a(()=>t[28]||(t[28]=[e("i",{class:"fa-solid fa-check me-2"},null,-1),u(" Đóng ")])),_:1})])]),default:a(()=>{var n,M,p,A;return[o.selectedTemplate?(m(),w("div",Be,[e("div",ze,[e("div",je,[e("h5",Oe,[t[29]||(t[29]=e("i",{class:"fa-solid fa-file-text me-2"},null,-1)),u(" "+d(o.selectedTemplate.name),1)])])]),e("div",Ke,[e("div",qe,[e("div",Ee,[t[30]||(t[30]=e("label",{class:"fw-bold text-muted"},"Loại văn bản:",-1)),e("div",Pe,[i(y,{class:"px-2 py-1"},{default:a(()=>{var k;return[u(d((k=o.selectedTemplate.document_type)==null?void 0:k.name),1)]}),_:1})])])]),e("div",He,[e("div",Ge,[t[31]||(t[31]=e("label",{class:"fw-bold text-muted"},"Trạng thái:",-1)),e("div",xe,[i(y,{color:o.getStatusColor(o.selectedTemplate.status),class:"px-2 py-1"},{default:a(()=>[u(d(o.getStatusText(o.selectedTemplate.status)),1)]),_:1},8,["color"])])])])]),e("div",Xe,[e("div",Je,[e("div",Qe,[t[33]||(t[33]=e("label",{class:"fw-bold text-muted"},"Mô tả:",-1)),e("div",We,[o.selectedTemplate.description?(m(),w("p",Ye,d(o.selectedTemplate.description),1)):(m(),w("p",Ze,t[32]||(t[32]=[e("i",null,"Chưa có mô tả",-1)])))])])])]),e("div",et,[e("div",tt,[e("div",st,[t[37]||(t[37]=e("label",{class:"fw-bold text-muted"},"File đính kèm:",-1)),e("div",ot,[o.selectedTemplate.file_path?(m(),w("div",lt,[e("div",at,[t[34]||(t[34]=e("i",{class:"fa-solid fa-file-pdf text-danger me-2 fs-4"},null,-1)),e("div",null,[e("div",nt,d(o.getFileName(o.selectedTemplate.file_path)),1),e("small",it,d(o.formatFileSize(o.selectedTemplate.file_size)),1)])]),e("div",dt,[i(h,{type:"link",size:"small",onClick:t[11]||(t[11]=k=>o.previewFile(o.selectedTemplate)),class:"me-2"},{default:a(()=>t[35]||(t[35]=[e("i",{class:"fa-solid fa-eye me-1"},null,-1),u(" Xem ")])),_:1})])])):(m(),w("div",rt,t[36]||(t[36]=[e("i",{class:"fa-solid fa-file-slash me-2"},null,-1),u(" Không có file đính kèm ")])))])])])]),e("div",ut,[e("div",ct,[e("div",mt,[e("div",pt,d(o.selectedTemplate.downloaded||0),1),t[38]||(t[38]=e("div",{class:"stat-label text-muted"},[e("span",{class:"text-primary"},[e("i",{class:"fa-solid fa-eye me-1"}),u(" Lượt xem ")])],-1))])]),e("div",ft,[e("div",vt,[e("div",ht,d(o.selectedTemplate.liked||0),1),t[39]||(t[39]=e("div",{class:"stat-label text-muted"},[e("span",{style:{color:"#f7527b"}},[e("i",{class:"fa-solid fa-heart me-1"}),u(" Lượt thích ")])],-1))])])]),e("div",gt,[e("div",yt,[e("div",_t,[e("div",bt,[e("div",wt,[i(j,{src:o.getAvatarUrl((n=o.selectedTemplate.creator)==null?void 0:n.avatar,(M=o.selectedTemplate.creator)==null?void 0:M.id),size:40,class:"me-3"},{default:a(()=>{var k,D;return[u(d((D=(k=o.selectedTemplate.creator)==null?void 0:k.name)==null?void 0:D.charAt(0)),1)]}),_:1},8,["src"])]),e("div",kt,[e("div",Tt,[e("span",null,d((p=o.selectedTemplate.creator)==null?void 0:p.name)+" - "+d((A=o.selectedTemplate.creator)==null?void 0:A.full_name_with_role),1)]),e("small",Ct," Tạo lúc: "+d(o.formatDateTime(o.selectedTemplate.created_at)),1)])])])])])])):(m(),w("div",Ft,[i(O,{size:"large"}),t[40]||(t[40]=e("div",{class:"mt-3 text-muted"},"Đang tải thông tin...",-1))]))]}),_:1},8,["open"])],64)}const It=de(fe,[["render",Ut]]);export{It as default};
