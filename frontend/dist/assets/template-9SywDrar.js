import{u as oe}from"./use-menu-D-IdInQM.js";import{_ as le,e as ae,c as g,b as n,d as a,r as m,F as x,A as ne,z as ie,g as f,i as de,H as F,G as w,o as p,a as e,N as r,x as D,I as O,q as d}from"./index-BOdPGqQO.js";import{U as re}from"./UploadOutlined-BsgcjnJf.js";const ue=ae({components:{UploadOutlined:re},setup(){oe().onSelectedKeys(["creator-documents-template"]);const s=ne(),t=ie(),$=f(!1),q=f([]),K={authorization:"authorization-text"},U=f([]),A=f([]),b=f(),v=f(),y=f(!1),_=f({name:"",document_type_id:null,description:""}),k=f({file:null});de(async()=>{await s.fetchDocumentTemplates(),U.value=s.document_templates,await s.fetchDocumentTypes(),A.value=s.document_types});const R={name:[{required:!0,message:"Vui lòng nhập tên mẫu văn bản"},{max:100,message:"Tên mẫu văn bản không được quá 100 ký tự"}],document_type_id:[{required:!0,message:"Vui lòng chọn loại văn bản"}]},S={file:[{required:!0,message:"Vui lòng chọn file PDF",trigger:"blur"}]},T=(o,l)=>l.label.toLowerCase().indexOf(o.toLowerCase())>=0,z=()=>{$.value=!0};function L({onSuccess:o}){setTimeout(()=>{o("ok")},0)}function B(o){const l=o.type==="application/pdf";return l||F.error("Bạn chỉ có thể upload file PDF!"),l}function N(o){let l;if(o.originFileObj)l=o.originFileObj;else if(o.url){window.open(o.url,"_blank");return}const c=URL.createObjectURL(l);window.open(c,"_blank")}const I=o=>{var l;k.file=o.fileList.length>0?o.fileList[0]:null,(l=v.value)==null||l.validateFields(["file"])},j=async({file:o,documentTemplateId:l})=>{try{const c=new FormData;return c.append("upload_file",o),c.append("document_template_id",l),{status:200,message:"File uploaded successfully",data:(await w.post("/api/document-templates/upload-file",c,{headers:{"Content-Type":"multipart/form-data"}})).data}}catch{return{status:500,message:"Lỗi khi upload file"}}},i=async o=>{try{const l=await w.post("/api/notifications/all-admins",o);l.status===201?console.log("Notification sent successfully:",l.data):console.error("Failed to send notification:",l)}catch(l){console.error("Error sending notification:",l)}},M=async()=>{try{await b.value.validateFields(),await v.value.validateFields(["file"]),y.value=!0;const o=t.role==="admin"?"active":"pending",l={..._.value,created_by:t.user.id,document_type_id:_.value.document_type_id,status:o};console.log("New Template Data:",l);const c=await w.post("/api/document-templates",l);if(c.status!==201)throw new Error("Failed to create document template");const H=k.file.originFileObj,se=c.data.document_template.id;if((await j({file:H,documentTemplateId:se})).status!==200)throw new Error("Failed to upload file");await i({notification_category_id:1,from_user_id:t.user.id,title:"Mẫu văn bản mới",content:`Đề xuất mẫu văn bản "${l.name}".`}),F.success("Thêm mẫu văn bản thành công!"),U.value.push(l),_.value={name:"",document_type_id:null,description:""},k.value={file:null},$.value=!1}catch(o){console.error("Validation failed:",o),F.error("Đã xảy ra lỗi khi thêm mẫu văn bản. Vui lòng kiểm tra lại thông tin.")}finally{y.value=!1}},u=f(!1),C=f(null),h=f(null),V=async(o,l)=>{console.log("Viewing details for:",o),u.value=!0,h.value=l;try{if(y.value=!0,u.value=!0,o.creator&&o.document_type)C.value=o;else{const c=await w.get(`/api/document-templates/${o.id}`);C.value=c.data.document_template}}catch(c){console.error("Error loading template details:",c),F.error("Không thể tải thông tin chi tiết")}finally{y.value=!1}},G=(o,l)=>({onClick:()=>{V(o,l)},style:{cursor:"pointer"}}),X=o=>({active:"green",pending:"orange",inactive:"red"})[o]||"default",J=o=>({active:"Được sử dụng",pending:"Chờ duyệt",inactive:"Tạm ngừng sử dụng"})[o]||o,Q=o=>o?o.split("/").pop()||o:"",W=o=>{if(!o)return"";const l=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(o)/Math.log(1024));return Math.round(o/Math.pow(1024,c)*100)/100+" "+l[c]},Y=async o=>{if(o.file_path){const l=`${apiUrl}/documents/${o.file_path}`;await w.get(`/api/document-templates/${o.id}/download`),window.open(l,"_blank"),U.value[h.value].downloaded+=1}else F.warning("Không có file để xem")},Z=o=>o?new Date(o).toLocaleString("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",P=f(""),ee=async o=>{try{const l=await w.get(`/api/document-templates/${o.id}/download`);P.value=l.data.download_url,await w.get(`/documents/${P.value}`)}catch{F.error("Không thể tải file")}},te=o=>o>100||o==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${o}`,E="https://tminh.id.vn";return{apiUrl:E,document_templates:U,document_types:A,columns:[{title:"Tên văn bản mẫu",dataIndex:"name",key:"name",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center"},{title:"Mô tả",dataIndex:"description",key:"description",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Người tạo",dataIndex:"created_by",key:"created_by",width:150,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"}],templateModalVisible:$,upload_files:q,headers:K,rules:R,uploadRules:S,formRef:b,uploadFormRef:v,formData:_,uploadData:k,loading:y,filterOption:T,showModalAddTemplate:z,handleCustomRequest:L,beforeUpload:B,handlePreview:N,handleFileChange:I,handleAddTemplate:M,customRow:G,detailModalVisible:u,selectedTemplate:C,viewDetail:V,getStatusColor:X,getStatusText:J,previewFile:Y,getFileName:Q,formatFileSize:W,formatDateTime:Z,fetchFileUrl:ee,getAvatarUrl:(o,l)=>o?`${E}/images/avatars/${o}`:te(l)}}}),ce={class:"row mb-3"},me={class:"col-12"},pe={class:"row g-2"},fe={class:"col-12 col-md-4"},ve={class:"col-12 col-md-8"},_e={class:"row g-2"},he={class:"col-6 col-md-3"},ge={class:"col-6 col-md-3"},ye={class:"col-6 col-md-1 d-flex align-items-center justify-content-end"},we={class:"row mb-3 d-flex justify-content-end"},be={class:"col-3"},ke={class:"row"},Te={class:"col-12"},Ce={class:""},Fe={class:""},De={key:3},Ue={class:"row d-flex justify-content-end g-2"},Me={class:"row"},Ve={class:"col-12"},$e={class:"row"},Ae={class:"col-12"},Le={class:"row d-flex justify-content-end g-2"},Ne={key:0,class:"template-detail"},Re={class:"row mb-3"},Se={class:"col-12"},ze={class:"text-primary mb-2"},Be={class:"row mb-3"},Ie={class:"col-6"},je={class:"info-item"},Oe={class:"mt-1"},qe={class:"col-6"},Ke={class:"info-item"},Pe={class:"mt-1"},Ee={class:"row mb-3"},He={class:"col-12"},xe={class:"info-item"},Ge={class:"mt-2 p-3 bg-light rounded"},Xe={key:0,class:"mb-0"},Je={key:1,class:"mb-0 text-muted"},Qe={class:"row mb-3"},We={class:"col-12"},Ye={class:"info-item"},Ze={class:"mt-2"},et={key:0,class:"file-item d-flex align-items-center justify-content-between p-3 border rounded bg-white"},tt={class:"d-flex align-items-center"},st={class:"fw-medium"},ot={class:"text-muted"},lt={class:"file-actions"},at={key:1,class:"text-muted text-center p-3 border rounded bg-light"},nt={class:"row mb-3"},it={class:"col-6"},dt={class:"stat-card text-center p-3 border rounded bg-primary bg-opacity-10"},rt={class:"stat-number text-primary fs-4 fw-bold"},ut={class:"col-6"},ct={class:"stat-card text-center p-3 border rounded bg-opacity-10",style:{"background-color":"rgba(247, 82, 123, 0.3)"}},mt={class:"stat-number fs-4 fw-bold",style:{color:"#f7527b"}},pt={class:"row"},ft={class:"col-12"},vt={class:"creator-info p-3 border rounded bg-light"},_t={class:"row align-items-center"},ht={class:"col-auto"},gt={class:"col"},yt={class:"fw-medium"},wt={class:"text-muted"},bt={key:1,class:"text-center py-5"};function kt(s,t,$,q,K,U){const A=m("a-input-search"),b=m("a-select"),v=m("a-button"),y=m("a-tooltip"),_=m("a-tag"),k=m("a-table"),R=m("a-card"),S=m("a-input"),T=m("a-form-item"),z=m("a-textarea"),L=m("a-form"),B=m("a-upload"),N=m("a-modal"),I=m("a-avatar"),j=m("a-spin");return p(),g(x,null,[n(R,{title:"",style:{width:"100%"}},{default:a(()=>[t[17]||(t[17]=e("h2",{class:"fw-bold mb-3"},"Mẫu Văn Bản",-1)),e("div",ce,[e("div",me,[e("div",pe,[e("div",fe,[n(A,{placeholder:"Tìm kiếm","allow-clear":"","enter-button":"",class:"w-100"})]),e("div",ve,[e("div",_e,[e("div",he,[n(b,{value:s.status_id,"onUpdate:value":t[0]||(t[0]=i=>s.status_id=i),"show-search":"",placeholder:"Trạng thái",options:s.documents_status,"filter-option":s.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",ge,[n(b,{value:s.type_id,"onUpdate:value":t[1]||(t[1]=i=>s.type_id=i),"show-search":"",placeholder:"Loại văn bản",options:s.documents_type,"filter-option":s.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",ye,[n(v,{type:"primary",class:"w-100 w-md-auto"},{default:a(()=>t[11]||(t[11]=[e("i",{class:"fa-solid fa-filter"},null,-1)])),_:1})])])])])])]),e("div",we,[e("div",be,[n(v,{type:"primary",class:"w-100 w-md-auto",onClick:s.showModalAddTemplate},{default:a(()=>t[12]||(t[12]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),r(" Thêm mẫu mới ")])),_:1},8,["onClick"])])]),e("div",ke,[e("div",Te,[n(k,{dataSource:s.document_templates,columns:s.columns,scroll:{x:576},bordered:"",customRow:s.customRow},{bodyCell:a(({column:i,index:M,record:u})=>[i.key==="type"?(p(),D(y,{key:0},{title:a(()=>[e("span",Ce,d(u.document_type.description),1)]),default:a(()=>[e("span",null,d(u.document_type.name),1)]),_:2},1024)):O("",!0),i.key==="status"?(p(),g(x,{key:1},[u.status==="active"?(p(),D(_,{key:0,color:"green"},{default:a(()=>t[13]||(t[13]=[r(d("Hoạt động"))])),_:1})):u.status==="pending"?(p(),D(_,{key:1,color:"orange"},{default:a(()=>t[14]||(t[14]=[r(d("Chờ duyệt"))])),_:1})):u.status==="inactive"?(p(),D(_,{key:2,color:"red"},{default:a(()=>t[15]||(t[15]=[r(d("Không hoạt động"))])),_:1})):u.status==="reject"?(p(),D(_,{key:3,color:"volcano"},{default:a(()=>t[16]||(t[16]=[r(d("Bị từ chối"))])),_:1})):O("",!0)],64)):i.key==="created_by"?(p(),D(y,{key:2},{title:a(()=>[e("span",Fe,d(u.creator.position_title),1)]),default:a(()=>[e("span",null,d(u.creator.name),1)]),_:2},1024)):i.key==="created_at"?(p(),g("span",De,d(s.formatDateTime(u.created_at)),1)):O("",!0)]),_:1},8,["dataSource","columns","customRow"])])])]),_:1}),n(N,{open:s.templateModalVisible,"onUpdate:open":t[7]||(t[7]=i=>s.templateModalVisible=i),width:"500px",centered:"","z-index":1003},{title:a(()=>t[18]||(t[18]=[e("span",{class:"fw-bold"},"Thêm mẫu mới",-1)])),footer:a(()=>[e("div",Ue,[n(v,{type:"primary",class:"col-3",onClick:s.handleAddTemplate,loading:s.loading},{default:a(()=>t[19]||(t[19]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),r(" Thêm mới ")])),_:1},8,["onClick","loading"]),n(v,{type:"default",class:"col-2",onClick:t[2]||(t[2]=i=>s.templateModalVisible=!1)},{default:a(()=>t[20]||(t[20]=[e("i",{class:"fa-solid fa-xmark me-2"},null,-1),r(" Đóng ")])),_:1})])]),default:a(()=>[e("div",Me,[e("div",Ve,[n(L,{ref:"formRef",model:s.formData,rules:s.rules,layout:"vertical"},{default:a(()=>[n(T,{label:"Tên mẫu văn bản",name:"name","has-feedback":""},{default:a(()=>[n(S,{value:s.formData.name,"onUpdate:value":t[3]||(t[3]=i=>s.formData.name=i),"allow-clear":"",placeholder:"Nhập tên mẫu văn bản"},null,8,["value"])]),_:1}),n(T,{label:"Loại văn bản",name:"document_type_id","has-feedback":""},{default:a(()=>[n(b,{value:s.formData.document_type_id,"onUpdate:value":t[4]||(t[4]=i=>s.formData.document_type_id=i),"show-search":"",placeholder:"Chọn loại văn bản",options:s.document_types,"filter-option":s.filterOption,"allow-clear":"","list-height":200,"dropdown-style":{position:"fixed",zIndex:1e4,background:"white",border:"1px solid #ccc"}},null,8,["value","options","filter-option"])]),_:1}),n(T,{label:"Mô tả",name:"description"},{default:a(()=>[n(z,{value:s.formData.description,"onUpdate:value":t[5]||(t[5]=i=>s.formData.description=i),rows:"4",placeholder:"Nhập mô tả cho mẫu văn bản"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])])]),e("div",$e,[e("div",Ae,[t[22]||(t[22]=e("h6",null,"Tệp tin đính kèm",-1)),n(L,{ref:"uploadFormRef",model:s.uploadData,rules:s.uploadRules},{default:a(()=>[n(T,{name:"file"},{default:a(()=>[n(B,{"file-list":s.uploadData.file,"onUpdate:fileList":t[6]||(t[6]=i=>s.uploadData.file=i),name:"file",accept:".pdf",headers:s.headers,"show-upload-list":!0,"custom-request":s.handleCustomRequest,"before-upload":s.beforeUpload,"max-count":1,onPreview:s.handlePreview,onChange:s.handleFileChange},{default:a(()=>[n(v,null,{default:a(()=>t[21]||(t[21]=[e("span",null,[e("i",{class:"bi bi-upload me-2"}),r("Chọn file PDF ")],-1)])),_:1})]),_:1},8,["file-list","headers","custom-request","before-upload","onPreview","onChange"])]),_:1})]),_:1},8,["model","rules"])])])]),_:1},8,["open"]),n(N,{open:s.detailModalVisible,"onUpdate:open":t[10]||(t[10]=i=>s.detailModalVisible=i),width:"600px",centered:"","z-index":1003},{title:a(()=>t[23]||(t[23]=[e("span",{class:"fw-bold"},"Chi tiết mẫu văn bản",-1)])),footer:a(()=>[e("div",Le,[n(v,{type:"primary",class:"col-3",onClick:t[8]||(t[8]=i=>s.detailModalVisible=!1)},{default:a(()=>t[24]||(t[24]=[e("i",{class:"fa-solid fa-check me-2"},null,-1),r(" Đóng ")])),_:1})])]),default:a(()=>{var i,M,u,C;return[s.selectedTemplate?(p(),g("div",Ne,[e("div",Re,[e("div",Se,[e("h5",ze,[t[25]||(t[25]=e("i",{class:"fa-solid fa-file-text me-2"},null,-1)),r(" "+d(s.selectedTemplate.name),1)])])]),e("div",Be,[e("div",Ie,[e("div",je,[t[26]||(t[26]=e("label",{class:"fw-bold text-muted"},"Loại văn bản:",-1)),e("div",Oe,[n(_,{class:"px-2 py-1"},{default:a(()=>{var h;return[r(d((h=s.selectedTemplate.document_type)==null?void 0:h.name),1)]}),_:1})])])]),e("div",qe,[e("div",Ke,[t[27]||(t[27]=e("label",{class:"fw-bold text-muted"},"Trạng thái:",-1)),e("div",Pe,[n(_,{color:s.getStatusColor(s.selectedTemplate.status),class:"px-2 py-1"},{default:a(()=>[r(d(s.getStatusText(s.selectedTemplate.status)),1)]),_:1},8,["color"])])])])]),e("div",Ee,[e("div",He,[e("div",xe,[t[29]||(t[29]=e("label",{class:"fw-bold text-muted"},"Mô tả:",-1)),e("div",Ge,[s.selectedTemplate.description?(p(),g("p",Xe,d(s.selectedTemplate.description),1)):(p(),g("p",Je,t[28]||(t[28]=[e("i",null,"Chưa có mô tả",-1)])))])])])]),e("div",Qe,[e("div",We,[e("div",Ye,[t[33]||(t[33]=e("label",{class:"fw-bold text-muted"},"File đính kèm:",-1)),e("div",Ze,[s.selectedTemplate.file_path?(p(),g("div",et,[e("div",tt,[t[30]||(t[30]=e("i",{class:"fa-solid fa-file-pdf text-danger me-2 fs-4"},null,-1)),e("div",null,[e("div",st,d(s.getFileName(s.selectedTemplate.file_path)),1),e("small",ot,d(s.formatFileSize(s.selectedTemplate.file_size)),1)])]),e("div",lt,[n(v,{type:"link",size:"small",onClick:t[9]||(t[9]=h=>s.previewFile(s.selectedTemplate)),class:"me-2"},{default:a(()=>t[31]||(t[31]=[e("i",{class:"fa-solid fa-eye me-1"},null,-1),r(" Xem ")])),_:1})])])):(p(),g("div",at,t[32]||(t[32]=[e("i",{class:"fa-solid fa-file-slash me-2"},null,-1),r(" Không có file đính kèm ")])))])])])]),e("div",nt,[e("div",it,[e("div",dt,[e("div",rt,d(s.selectedTemplate.downloaded||0),1),t[34]||(t[34]=e("div",{class:"stat-label text-muted"},[e("span",{class:"text-primary"},[e("i",{class:"fa-solid fa-eye me-1"}),r(" Lượt xem ")])],-1))])]),e("div",ut,[e("div",ct,[e("div",mt,d(s.selectedTemplate.liked||0),1),t[35]||(t[35]=e("div",{class:"stat-label text-muted"},[e("span",{style:{color:"#f7527b"}},[e("i",{class:"fa-solid fa-heart me-1"}),r(" Lượt thích ")])],-1))])])]),e("div",pt,[e("div",ft,[e("div",vt,[e("div",_t,[e("div",ht,[n(I,{src:s.getAvatarUrl((i=s.selectedTemplate.creator)==null?void 0:i.avatar,(M=s.selectedTemplate.creator)==null?void 0:M.id),size:40,class:"me-3"},{default:a(()=>{var h,V;return[r(d((V=(h=s.selectedTemplate.creator)==null?void 0:h.name)==null?void 0:V.charAt(0)),1)]}),_:1},8,["src"])]),e("div",gt,[e("div",yt,[e("span",null,d((u=s.selectedTemplate.creator)==null?void 0:u.name)+" - "+d((C=s.selectedTemplate.creator)==null?void 0:C.full_name_with_role),1)]),e("small",wt," Tạo lúc: "+d(s.formatDateTime(s.selectedTemplate.created_at)),1)])])])])])])):(p(),g("div",bt,[n(j,{size:"large"}),t[36]||(t[36]=e("div",{class:"mt-3 text-muted"},"Đang tải thông tin...",-1))]))]}),_:1},8,["open"])],64)}const Vt=le(ue,[["render",kt]]);export{Vt as default};
