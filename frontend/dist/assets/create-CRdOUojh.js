import{_ as j,e as A,c as v,a as e,N as f,b as r,r as y,p as B,I as N,F as I,u as U,d as c,V as X,z as P,g as C,i as W,C as E,H as d,M as O,W as z,D as K,G as R,o as b,q}from"./index-C1QRfrb-.js";import{u as G}from"./use-menu-DskxiNIv.js";import{u as J}from"./department-store-CXkw-4FN.js";import{M as Q,D as Y,P as Z}from"./PlusCircleOutlined-DWYfzljJ.js";const ee=A({components:{PlusCircleOutlined:Z,DownCircleOutlined:Y,MinusCircleOutlined:Q,CloseCircleOutlined:X},setup(){const n=K(),D=P().user,S=J();G().onSelectedKeys(["admin-approval-flows-create"]);const h=C(""),T=C(""),s=C([{step:1,multichoice:!1,department_id:null}]),_=C([]);W(async()=>{await S.fetchDepartmentsCanApprove(),_.value=S.departments_can_approve});const x=E(()=>_.value.filter(a=>a.group!=="Khác")),p=(a,i)=>i.label.toLowerCase().indexOf(a.toLowerCase())>=0;function w(a,i){const u={step:a+1,multichoice:!1,department_id:null};s.value.splice(i+1,0,u);const l=u.step;for(let k=i+2;k<s.value.length;++k)s.value[k].step>=l&&(s.value[k].step+=1);L(),d.success("Đã thêm cấp duyệt mới")}function o(a,i){return i===s.value.length-1?!1:s.value[i+1].step===a}function m(a,i){s.value[i].multichoice=!0;const u={step:a,department_id:null,multichoice:!0};s.value.splice(i+1,0,u);for(let l=0;l<s.value.length;++l)s.value[l].step==a&&(s.value[l].multichoice=!0);d.success("Đã thêm cấp duyệt song song")}function g(a){const i=s.value[a].step;s.value.splice(a,1);for(let l=a;l<s.value.length&&s.value[l].step!=i;++l)s.value[l].step-=1;const u=new Map;for(let l of s.value)u.has(l.step)?u.set(l.step,u.get(l.step)+1):u.set(l.step,1);for(let l=0;l<s.value.length;++l)u.get(s.value[l].step)>1?s.value[l].multichoice=!0:s.value[l].multichoice=!1;d.success("Đã xóa cấp duyệt")}function V(){O.confirm({title:"Xác nhận reset luồng",icon:r(z),content:"Bạn có chắc chắn muốn xóa toàn bộ luồng và bắt đầu lại?",okText:"Đồng ý",cancelText:"Hủy",onOk(){s.value=[{step:1,department_id:null,multichoice:!1}],d.success("Đã reset luồng phê duyệt")}})}function M(){if(!h.value.trim())return d.error("Vui lòng nhập tên luồng mẫu"),!1;if(s.value[0].department_id===null)return d.error("Vui lòng chọn ít nhất một đơn vị phê duyệt"),!1;for(let a of s.value)if(!a.department_id)return d.error("Vui lòng chọn đơn vị cho tất cả các cấp duyệt"),!1;return!0}async function $(){const a={name:h.value,description:T.value,created_by:D.id,process:s.value.length,steps:s.value};console.log("Template data: "+JSON.stringify(a,null,2));try{const i=await R.post("/api/flow-templates",a);d.success("Tạo luồng mẫu thành công"),n.push({name:"admin-approval-flows-template"})}catch(i){d.error("Lỗi khi tạo luồng mẫu"),console.error("Lỗi:",i)}}function F(){M()&&O.confirm({title:"Xác nhận tạo luồng mẫu",icon:r(z),content:`Bạn có chắc chắn muốn tạo luồng mẫu "${h.value}"?`,okText:"Đồng ý",cancelText:"Hủy",onOk(){$()}})}function H(){n.push({name:"admin-workflow-templates"})}function L(){new Audio("/sounds/meow.mp3").play()}return{workflow_name:h,workflow_description:T,current_flow_step:s,listDepartmentsForNewFlow:x,filterOption:p,addStep:w,checkIfAfterHasSameStep:o,addSameStep:m,removeStep:g,resetWorkflow:V,handleSaveTemplate:F,handleCancel:H}}}),te={class:"container py-2 card"},se={class:"card shadow-sm mb-4"},le={class:"card-body"},ne={class:"row mb-3"},ae={class:"col-sm-9"},oe={class:"row mb-3"},ie={class:"col-sm-9"},re={class:"card shadow-sm mb-4"},ce={class:"card-body"},ue={class:"workflow-steps"},de={class:"d-flex justify-content-between align-items-center mb-3"},pe={class:"step-header"},me={class:"badge bg-primary fs-6 px-3 py-2"},fe={key:0,class:"badge bg-warning ms-2"},ge={class:"row"},ve={class:"col-12 col-lg-8 mb-3 mb-md-0"},be={class:"col-lg-4 align-self-lg-end justify-content-lg-center d-flex col-12 align-items-center justify-content-center mt-3 mt-lg-0"},he={class:"d-flex flex-wrap gap-2 justify-content-lg-end"},we={key:0,class:"text-center mt-3"},ye={key:0,class:"text-end mb-4"},_e={class:"d-flex justify-content-center gap-3 pt-4 border-top"};function ke(n,t,D,S,h,T){const s=y("a-input"),_=y("a-textarea"),x=y("a-select"),p=y("a-button"),w=y("a-tooltip");return b(),v("div",te,[t[20]||(t[20]=e("div",{class:"d-flex justify-content-between align-items-center mb-4"},[e("div",null,[e("h1",{class:""}," Tạo luồng phê duyệt mẫu "),e("span",{class:"text-secondary"},"Thiết lập luồng phê duyệt có thể tái sử dụng cho các văn bản")])],-1)),e("div",se,[t[4]||(t[4]=e("div",{class:"card-header bg-primary text-white"},[e("h5",{class:"mb-0"},[e("i",{class:"bi bi-info-circle me-2"}),f(" Thông tin luồng mẫu ")])],-1)),e("div",le,[e("div",ne,[t[2]||(t[2]=e("div",{class:"col-sm-3 text-start mb-2 mb-sm-0 align-self-center"},[e("label",{class:"form-label fw-semibold"},[e("span",{class:"text-danger me-1"},"*"),e("span",null,"Tên luồng mẫu:")])],-1)),e("div",ae,[r(s,{value:n.workflow_name,"onUpdate:value":t[0]||(t[0]=o=>n.workflow_name=o),placeholder:"VD: Luồng phê duyệt hoạt động sinh viên cấp khoa","allow-clear":"",size:"large"},null,8,["value"])])]),e("div",oe,[t[3]||(t[3]=e("div",{class:"col-sm-3 text-start mb-2 mb-sm-0 align-self-center"},[e("label",{class:"form-label fw-semibold"},[e("span",null,"Mô tả luồng:")])],-1)),e("div",ie,[r(_,{value:n.workflow_description,"onUpdate:value":t[1]||(t[1]=o=>n.workflow_description=o),placeholder:"Mô tả chi tiết về luồng phê duyệt này được sử dụng cho mục đích gì...",rows:3,"show-count":"","allow-clear":"",maxlength:500,size:"large"},null,8,["value"])])])])]),e("div",re,[t[19]||(t[19]=e("div",{class:"card-header bg-success text-white"},[e("h5",{class:"mb-0"},[e("i",{class:"bi bi-flow-chart me-2"}),f(" Cấu hình luồng phê duyệt ")])],-1)),e("div",ce,[t[18]||(t[18]=B('<div class="alert alert-info border-0 mb-4" data-v-e8546cf2><h6 class="alert-heading fw-bold" data-v-e8546cf2><i class="bi bi-lightbulb me-2" data-v-e8546cf2></i> Hướng dẫn tạo luồng: </h6><ul class="mb-0 small" data-v-e8546cf2><li data-v-e8546cf2><strong data-v-e8546cf2>Nút xanh lá:</strong> Thêm cấp duyệt tiếp theo</li><li data-v-e8546cf2><strong data-v-e8546cf2>Nút vàng:</strong> Thêm cấp duyệt đồng cấp (song song)</li><li data-v-e8546cf2><strong data-v-e8546cf2>Nút đỏ:</strong> Xóa cấp duyệt</li><li data-v-e8546cf2><strong data-v-e8546cf2>Chú ý:</strong><ul data-v-e8546cf2><li data-v-e8546cf2>Ở cấp duyệt song song, chỉ có thể thêm cấp mới ở hàng cuối</li><li data-v-e8546cf2>Phải chọn xong đơn vị mới được xử lý thêm, xóa</li></ul></li></ul></div>',1)),e("div",ue,[(b(!0),v(I,null,U(n.current_flow_step,(o,m)=>(b(),v("div",{key:m,class:"step-card mb-4 p-4 border rounded-3 bg-light"},[e("div",de,[e("div",pe,[e("span",me,[t[5]||(t[5]=e("i",{class:"bi bi-bookmark me-1"},null,-1)),f(" Cấp duyệt "+q(o.step),1)]),o.multichoice?(b(),v("span",fe,t[6]||(t[6]=[e("i",{class:"bi bi-arrows-expand me-1"},null,-1),f(" Song song ")]))):N("",!0)])]),e("div",ge,[e("div",ve,[t[7]||(t[7]=e("label",{class:"form-label fw-semibold text-primary"},[e("i",{class:"bi bi-building me-1"}),f(" Đơn vị phê duyệt: ")],-1)),r(x,{value:o.department_id,"onUpdate:value":g=>o.department_id=g,style:{width:"100%"},options:n.listDepartmentsForNewFlow,placeholder:"Chọn đơn vị phê duyệt",size:"large","show-search":"","filter-option":n.filterOption,"allow-clear":""},null,8,["value","onUpdate:value","options","filter-option"])]),e("div",be,[e("div",he,[r(w,{title:"Thêm cấp duyệt sau cấp hiện tại"},{default:c(()=>[r(p,{type:"primary",disabled:!o.department_id||n.checkIfAfterHasSameStep(o.step,m),onClick:g=>n.addStep(o.step,m),class:"bg-success border-success",size:"large"},{default:c(()=>t[8]||(t[8]=[e("i",{class:"bi bi-plus-circle"},null,-1)])),_:2},1032,["disabled","onClick"])]),_:2},1024),r(w,{title:"Thêm cấp duyệt đồng cấp (song song)"},{default:c(()=>[r(p,{type:"primary",disabled:!o.department_id,onClick:g=>n.addSameStep(o.step,m),class:"bg-warning border-warning",size:"large"},{default:c(()=>t[9]||(t[9]=[e("i",{class:"bi bi-arrow-down-circle"},null,-1)])),_:2},1032,["disabled","onClick"])]),_:2},1024),r(w,{title:"Xóa cấp duyệt này"},{default:c(()=>[r(p,{type:"primary",disabled:n.current_flow_step.length<=1,onClick:g=>n.removeStep(m),class:"bg-danger border-danger",size:"large"},{default:c(()=>t[10]||(t[10]=[e("i",{class:"bi bi-dash-circle"},null,-1)])),_:2},1032,["disabled","onClick"])]),_:2},1024)])])]),m<n.current_flow_step.length-1?(b(),v("div",we,t[11]||(t[11]=[e("i",{class:"bi bi-arrow-down fs-3 text-primary"},null,-1)]))):N("",!0)]))),128))]),n.current_flow_step.length>1?(b(),v("div",ye,[r(p,{type:"primary",onClick:n.resetWorkflow,class:"bg-danger border-danger",size:"large"},{icon:c(()=>t[12]||(t[12]=[e("i",{class:"bi bi-arrow-clockwise me-2"},null,-1)])),default:c(()=>[t[13]||(t[13]=f(" Reset toàn bộ "))]),_:1},8,["onClick"])])):N("",!0),e("div",_e,[r(p,{type:"primary",onClick:n.handleSaveTemplate,size:"large",class:"px-4 py-2"},{icon:c(()=>t[14]||(t[14]=[e("i",{class:"bi bi-floppy me-2"},null,-1)])),default:c(()=>[t[15]||(t[15]=f(" Lưu luồng mẫu "))]),_:1},8,["onClick"]),r(p,{onClick:n.handleCancel,size:"large",class:"px-4 py-2"},{icon:c(()=>t[16]||(t[16]=[e("i",{class:"bi bi-x-circle me-2"},null,-1)])),default:c(()=>[t[17]||(t[17]=f(" Hủy bỏ "))]),_:1},8,["onClick"])])])])])}const Ne=j(ee,[["render",ke],["__scopeId","data-v-e8546cf2"]]);export{Ne as default};
