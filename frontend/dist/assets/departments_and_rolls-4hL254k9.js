import{u as ue}from"./use-menu-vCLX-e5I.js";import{u as Y}from"./use-register-DrPzXFFz.js";import{b as n,O as pe,_ as me,P as ge,Q as ve,c as Q,a as f,d as o,r as i,g as p,i as he,C as E,B as K,H as w,G as fe,o as C,N as c,x as z,I as Z,q as J,F as _e,u as be}from"./index-qeq2zkB_.js";var ye={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M257.7 752c2 0 4-.2 6-.5L431.9 722c2-.4 3.9-1.3 5.3-2.8l423.9-423.9a9.96 9.96 0 000-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2a33.5 33.5 0 009.4 29.8c6.6 6.4 14.9 9.9 23.8 9.9zm67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z"}}]},name:"edit",theme:"outlined"};function $(g){for(var t=1;t<arguments.length;t++){var s=arguments[t]!=null?Object(arguments[t]):{},e=Object.keys(s);typeof Object.getOwnPropertySymbols=="function"&&(e=e.concat(Object.getOwnPropertySymbols(s).filter(function(_){return Object.getOwnPropertyDescriptor(s,_).enumerable}))),e.forEach(function(_){we(g,_,s[_])})}return g}function we(g,t,s){return t in g?Object.defineProperty(g,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):g[t]=s,g}var G=function(t,s){var e=$({},t,s.attrs);return n(pe,$({},e,{icon:ye}),null)};G.displayName="EditOutlined";G.inheritAttrs=!1;const Ce={components:{PlusOutlined:ve,EditOutlined:G,DeleteOutlined:ge},setup(){ue().onSelectedKeys(["admin-users-departments-and-rolls"]);const g=Y(),t=p("departments"),s=p([{id:1,name:"Phòng Công nghệ thông tin",description:"Quản lý hệ thống công nghệ thông tin của trường",status:"active",createdAt:"2024-01-15"},{id:2,name:"Phòng Đào tạo",description:"Quản lý hoạt động đào tạo và giảng dạy",status:"active",createdAt:"2024-01-10"},{id:3,name:"Phòng Tài chính - Kế toán",description:"Quản lý tài chính và kế toán của trường",status:"inactive",createdAt:"2024-01-05"}]),e=p([{id:1,name:"Quản trị viên hệ thống",description:"Có toàn quyền quản lý hệ thống",permissions:["read","write","update","delete","approve"],status:"active",createdAt:"2024-01-15"},{id:2,name:"Cán bộ phê duyệt",description:"Có quyền phê duyệt văn bản",permissions:["read","approve"],status:"active",createdAt:"2024-01-12"},{id:3,name:"Người đề xuất",description:"Có quyền tạo và gửi đề xuất",permissions:["read","write"],status:"active",createdAt:"2024-01-08"}]);he(async()=>{await g.fetchRegisterForm(),s.value=g.departments,e.value=g.rolls});const _=p(""),L=p(""),j=p(!1),x=p(!1),O=E(()=>_.value?s.value.filter(a=>a.name.toLowerCase().includes(_.value.toLowerCase())||a.description.toLowerCase().includes(_.value.toLowerCase())):s.value),U=E(()=>L.value?e.value.filter(a=>a.name.toLowerCase().includes(L.value.toLowerCase())||a.description.toLowerCase().includes(L.value.toLowerCase())):e.value),V=[{title:"Tên phòng ban",dataIndex:"label",key:"label",sorter:(a,r)=>a.label.localeCompare(r.label),customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Mô tả",dataIndex:"description",key:"description",customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Trạng thái",dataIndex:"status",key:"status",width:120,align:"center"},{title:"Số người dùng",dataIndex:"number_of_users",key:"userCount",width:150,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"createdAt",width:120,sorter:(a,r)=>{const d=a.created_at.split(" ")[1].split("/").reverse().join("-")+" "+a.created_at.split(" ")[0],I=r.created_at.split(" ")[1].split("/").reverse().join("-")+" "+r.created_at.split(" ")[0];return d.localeCompare(I)},align:"center"},{title:"Thao tác",key:"actions",width:120,align:"center"}],q=[{title:"Tên vai trò",dataIndex:"label",key:"label",sorter:!0,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Mô tả",dataIndex:"description",key:"description",customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Thứ bậc",dataIndex:"level",key:"level",align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:120,sorter:(a,r)=>{const d=a.created_at.split(" ")[1].split("/").reverse().join("-")+" "+a.created_at.split(" ")[0],I=r.created_at.split(" ")[1].split("/").reverse().join("-")+" "+r.created_at.split(" ")[0];return d.localeCompare(I)},align:"center"},{title:"Thao tác",key:"actions",width:120,align:"center"}],T=K({current:1,pageSize:10,total:E(()=>O.value.length),showSizeChanger:!0,showQuickJumper:!0,showTotal:(a,r)=>`${r[0]}-${r[1]} của ${a} mục`,position:["bottomCenter"]}),R=K({current:1,pageSize:10,total:E(()=>U.value.length),showSizeChanger:!0,showQuickJumper:!0,showTotal:(a,r)=>`${r[0]}-${r[1]} của ${a} mục`}),M=p(!1),D=p(!1),P=p(""),k=p(""),m=p(!1),h=p(!1),N=p(),u=p([]),A={authorization:"authorization-text"},F=p(),b=K({id:null,name:"",description:"Mô tả ngắn về phòng ban",phone:"",location:"",can_approve:!1,group:"other"}),y=K({id:null,name:"",description:"Mô tả ngắn về vai trò",permissions:[],status:"active"}),B={name:[{required:!0,message:"Vui lòng nhập tên phòng ban",trigger:"blur"}],description:[{required:!1}],phone:[{required:!1},{pattern:/^[0-9]{10}$/,message:"Số điện thoại phải có đúng 10 chữ số",trigger:"blur"}]},H={name:[{required:!0,message:"Vui lòng nhập tên vai trò",trigger:"blur"}],description:[{required:!1}]},l=()=>{T.current=1},v=()=>{R.current=1},S=a=>{T.current=a.current,T.pageSize=a.pageSize},ee=a=>{R.current=a.current,R.pageSize=a.pageSize},te=()=>{P.value="Thêm phòng ban mới",m.value=!1,M.value=!0},ne=()=>{k.value="Thêm vai trò mới",h.value=!1,D.value=!0},ae=a=>{P.value="Chỉnh sửa phòng ban",m.value=!0,Object.assign(b,a),M.value=!0},oe=a=>{k.value="Chỉnh sửa vai trò",h.value=!0,Object.assign(y,a),D.value=!0},le=async({file:a,departmentId:r})=>{try{const d=new FormData;d.append("upload_file",a),d.append("department_id",r);const I=await fe.post("/api/departments/upload-image",d,{headers:{"Content-Type":"multipart/form-data"}});w.success("Upload avatar thành công"),I.success===!1&&console.log("err: "+I.errors)}catch(d){console.error("Lỗi khi upload avatar: "+d.message)}},re=async()=>{var a;try{if(await N.value.validate(),m.value){const r=s.value.findIndex(d=>d.id===b.id);r!==-1&&(s.value[r]={...b},w.success("Cập nhật phòng ban thành công"))}else{const r={...b},d=await Y().addDepartment(r);console.log("Phòng mới: "+d),await le({file:(a=u.value[0])==null?void 0:a.originFileObj,departmentId:d}),w.success("Thêm phòng ban thành công")}X()}catch(r){console.error("Validation failed:",r)}},ie=async()=>{try{if(await F.value.validate(),h.value){const a=e.value.findIndex(r=>r.id===y.id);a!==-1&&(e.value[a]={...y},w.success("Cập nhật vai trò thành công"))}else{const a={...y,id:Date.now(),createdAt:new Date().toISOString().split("T")[0]};e.value.push(a),w.success("Thêm vai trò thành công")}W()}catch(a){console.error("Validation failed:",a)}},se=a=>{const r=s.value.findIndex(d=>d.id===a);r!==-1&&(s.value.splice(r,1),w.success("Xóa phòng ban thành công"))},de=a=>{const r=e.value.findIndex(d=>d.id===a);r!==-1&&(e.value.splice(r,1),w.success("Xóa vai trò thành công"))},X=()=>{var a;M.value=!1,(a=N.value)==null||a.resetFields(),Object.assign(b,{id:null,name:"",description:"",status:"active",phone:"",location:"",can_approve:!1,group:"other",imageUrl:"",upload_files:[]})},W=()=>{var a;D.value=!1,(a=F.value)==null||a.resetFields(),Object.assign(y,{id:null,name:"",description:"",permissions:[],status:"active"})};function ce({onSuccess:a}){setTimeout(()=>{a("ok")},0)}return{activeTab:t,departments:s,roles:e,upload_files:u,headers:A,departmentSearch:_,roleSearch:L,departmentLoading:j,roleLoading:x,filteredDepartments:O,filteredRoles:U,departmentColumns:V,roleColumns:q,departmentPagination:T,rolePagination:R,departmentModalVisible:M,roleModalVisible:D,departmentModalTitle:P,roleModalTitle:k,departmentFormRef:N,roleFormRef:F,departmentForm:b,roleForm:y,departmentRules:B,roleRules:H,onSearchDepartments:l,onSearchRoles:v,onDepartmentTableChange:S,onRoleTableChange:ee,showAddDepartmentModal:te,showAddRoleModal:ne,editDepartment:ae,editRole:oe,handleDepartmentSubmit:re,handleRoleSubmit:ie,deleteDepartment:se,deleteRole:de,resetDepartmentModal:X,resetRoleModal:W,beforeUpload:a=>a.type==="image/jpeg"||a.type==="image/png"?a.size/1024/1024<2?!0:(w.error("Kích thước file phải nhỏ hơn 2MB!"),!1):(w.error("Chỉ có thể upload file JPG/PNG!"),!1),handleCustomRequest:ce,handleImageChange:a=>{if(a.file.status==="uploading")return;const r=new FileReader;r.addEventListener("load",()=>{b.imageUrl=r.result}),r.readAsDataURL(a.file.originFileObj||a.file)},customRow:a=>({onClick:()=>{console.log("Row clicked:",a)},style:{cursor:"pointer"}})}}},xe={class:"departments-roles-management card"},ke={class:"tab-content pt-0"},Fe={class:"header-actions"},Se={class:"tab-content"},Te={class:"header-actions"},Re={key:0},Me=["src"],Oe={key:1};function De(g,t,s,e,_,L){const j=i("a-input-search"),x=i("a-button"),O=i("a-tag"),U=i("edit-outlined"),V=i("delete-outlined"),q=i("a-popconfirm"),T=i("a-space"),R=i("a-table"),M=i("a-tab-pane"),D=i("plus-outlined"),P=i("a-tabs"),k=i("a-input"),m=i("a-form-item"),h=i("a-col"),N=i("a-switch"),u=i("a-select-option"),A=i("a-select"),F=i("a-row"),b=i("a-upload"),y=i("a-textarea"),B=i("a-form"),H=i("a-modal");return C(),Q("div",xe,[t[33]||(t[33]=f("div",null,[f("h2",{class:"mb-3"},"Quản lý phòng ban và vai trò")],-1)),n(P,{activeKey:e.activeTab,"onUpdate:activeKey":t[2]||(t[2]=l=>e.activeTab=l),type:"card",class:""},{default:o(()=>[n(M,{key:"departments",tab:"Quản lý Phòng ban",class:""},{default:o(()=>[f("div",ke,[f("div",Fe,[n(j,{value:e.departmentSearch,"onUpdate:value":t[0]||(t[0]=l=>e.departmentSearch=l),placeholder:"Tìm kiếm phòng ban...",style:{width:"300px"},onSearch:e.onSearchDepartments},null,8,["value","onSearch"]),n(x,{type:"primary",onClick:e.showAddDepartmentModal},{default:o(()=>t[16]||(t[16]=[f("i",{class:"bi bi-plus-circle me-2"},null,-1),c("Thêm phòng ban ")])),_:1},8,["onClick"])]),n(R,{columns:e.departmentColumns,"data-source":e.filteredDepartments,pagination:e.departmentPagination,loading:e.departmentLoading,"row-key":"id","custom-row":e.customRow,onChange:e.onDepartmentTableChange,locale:{triggerDesc:"Nhấn để sắp xếp giảm dần",triggerAsc:"Nhấn để sắp xếp tăng dần",cancelSort:"Nhấn để hủy sắp xếp"}},{bodyCell:o(({column:l,record:v})=>[l.key==="status"?(C(),z(O,{key:0,color:v.status==="active"?"green":"red"},{default:o(()=>[c(J(v.status==="active"?"Hoạt động":"Ngừng hoạt động"),1)]),_:2},1032,["color"])):l.key==="actions"?(C(),z(T,{key:1},{default:o(()=>[n(x,{type:"text",onClick:S=>e.editDepartment(v)},{icon:o(()=>[n(U)]),_:2},1032,["onClick"]),n(q,{title:"Bạn có chắc chắn muốn xóa phòng ban này?",onConfirm:S=>e.deleteDepartment(v.id)},{default:o(()=>[n(x,{type:"text",danger:""},{icon:o(()=>[n(V)]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):Z("",!0)]),_:1},8,["columns","data-source","pagination","loading","custom-row","onChange"])])]),_:1}),n(M,{key:"roles",tab:"Quản lý Vai trò"},{default:o(()=>[f("div",Se,[f("div",Te,[n(j,{value:e.roleSearch,"onUpdate:value":t[1]||(t[1]=l=>e.roleSearch=l),placeholder:"Tìm kiếm vai trò...",style:{width:"300px"},onSearch:e.onSearchRoles},null,8,["value","onSearch"]),n(x,{type:"primary",onClick:e.showAddRoleModal},{icon:o(()=>[n(D)]),default:o(()=>[t[17]||(t[17]=c(" Thêm vai trò "))]),_:1},8,["onClick"])]),n(R,{columns:e.roleColumns,"data-source":e.filteredRoles,pagination:e.rolePagination,loading:e.roleLoading,"custom-row":e.customRow,"row-key":"id",onChange:e.onRoleTableChange},{bodyCell:o(({column:l,record:v})=>[l.key==="permissions"?(C(!0),Q(_e,{key:0},be(v.permissions,S=>(C(),z(O,{key:S,color:"blue"},{default:o(()=>[c(J(S),1)]),_:2},1024))),128)):l.key==="status"?(C(),z(O,{key:1,color:v.status==="active"?"green":"red"},{default:o(()=>[c(J(v.status==="active"?"Hoạt động":"Ngừng hoạt động"),1)]),_:2},1032,["color"])):l.key==="actions"?(C(),z(T,{key:2},{default:o(()=>[n(x,{type:"text",onClick:S=>e.editRole(v)},{icon:o(()=>[n(U)]),_:2},1032,["onClick"]),n(q,{title:"Bạn có chắc chắn muốn xóa vai trò này?",onConfirm:S=>e.deleteRole(v.id)},{default:o(()=>[n(x,{type:"text",danger:""},{icon:o(()=>[n(V)]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):Z("",!0)]),_:1},8,["columns","data-source","pagination","loading","custom-row","onChange"])])]),_:1})]),_:1},8,["activeKey"]),n(H,{visible:e.departmentModalVisible,"onUpdate:visible":t[10]||(t[10]=l=>e.departmentModalVisible=l),title:e.departmentModalTitle,onOk:e.handleDepartmentSubmit,onCancel:e.resetDepartmentModal,width:"600px",zIndex:1e4},{default:o(()=>[n(B,{ref:"departmentFormRef",model:e.departmentForm,rules:e.departmentRules,layout:"vertical"},{default:o(()=>[n(F,{gutter:16},{default:o(()=>[n(h,{span:10},{default:o(()=>[n(m,{label:"Tên phòng ban",name:"name"},{default:o(()=>[n(k,{value:e.departmentForm.name,"onUpdate:value":t[3]||(t[3]=l=>e.departmentForm.name=l),placeholder:"Nhập tên phòng ban"},null,8,["value"])]),_:1})]),_:1}),n(h,{span:6},{default:o(()=>[n(m,{label:"Được phê duyệt",name:"can_approve"},{default:o(()=>[n(N,{checked:e.departmentForm.can_approve,"onUpdate:checked":t[4]||(t[4]=l=>e.departmentForm.can_approve=l),"checked-children":"Có","un-checked-children":"Không"},null,8,["checked"])]),_:1})]),_:1}),n(h,{span:8},{default:o(()=>[n(m,{label:"Nhóm",name:"group"},{default:o(()=>[n(A,{value:e.departmentForm.group,"onUpdate:value":t[5]||(t[5]=l=>e.departmentForm.group=l),placeholder:"Chọn nhóm","dropdown-style":{position:"absolute",zIndex:1e4,background:"white",border:"1px solid #ccc"}},{default:o(()=>[n(u,{value:"faculty"},{default:o(()=>t[18]||(t[18]=[c("Khoa/Trung tâm")])),_:1}),n(u,{value:"lcd"},{default:o(()=>t[19]||(t[19]=[c("LCĐ")])),_:1}),n(u,{value:"lch"},{default:o(()=>t[20]||(t[20]=[c("LCH")])),_:1}),n(u,{value:"unit"},{default:o(()=>t[21]||(t[21]=[c("Phòng/Ban/Đơn vị")])),_:1}),n(u,{value:"club"},{default:o(()=>t[22]||(t[22]=[c("CLB/Đội")])),_:1}),n(u,{value:"other"},{default:o(()=>t[23]||(t[23]=[c("Khác")])),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),n(F,{gutter:16},{default:o(()=>[n(h,{span:12},{default:o(()=>[n(m,{label:"Số điện thoại",name:"phone"},{default:o(()=>[n(k,{value:e.departmentForm.phone,"onUpdate:value":t[6]||(t[6]=l=>e.departmentForm.phone=l),placeholder:"Nhập số điện thoại","allow-clear":""},null,8,["value"])]),_:1})]),_:1}),n(h,{span:12},{default:o(()=>[n(m,{label:"Vị trí",name:"location"},{default:o(()=>[n(k,{value:e.departmentForm.location,"onUpdate:value":t[7]||(t[7]=l=>e.departmentForm.location=l),placeholder:"Vị trí văn phòng","allow-clear":""},null,8,["value"])]),_:1})]),_:1})]),_:1}),n(F,{gutter:16},{default:o(()=>[n(h,{span:8},{default:o(()=>[n(m,{label:"Hình ảnh",name:"image"},{default:o(()=>[n(b,{"file-list":e.upload_files,"onUpdate:fileList":t[8]||(t[8]=l=>e.upload_files=l),name:"avatar",headers:e.headers,"list-type":"picture-card",class:"avatar-uploader",accept:".jpg,.jpeg,.png","show-upload-button":!0,"show-upload-list":!1,"before-upload":e.beforeUpload,"custom-request":e.handleCustomRequest,onChange:e.handleImageChange},{default:o(()=>[e.departmentForm.imageUrl?(C(),Q("div",Re,[f("img",{src:e.departmentForm.imageUrl,alt:"avatar",style:{width:"100%"}},null,8,Me)])):(C(),Q("div",Oe,t[24]||(t[24]=[f("i",{class:"bi bi-plus-lg"},null,-1),f("div",{style:{"margin-top":"8px"}},"Tải ảnh lên",-1)])))]),_:1},8,["file-list","headers","before-upload","custom-request","onChange"]),t[25]||(t[25]=f("div",{style:{"margin-top":"8px",color:"#999","font-size":"12px"}}," Hỗ trợ JPG, PNG. Kích thước tối đa 2MB ",-1))]),_:1})]),_:1}),n(h,{span:16},{default:o(()=>[n(m,{label:"Mô tả",name:"description"},{default:o(()=>[n(y,{value:e.departmentForm.description,"onUpdate:value":t[9]||(t[9]=l=>e.departmentForm.description=l),placeholder:"Nhập mô tả",rows:3,"allow-clear":"","show-count":"",maxlength:200},null,8,["value"])]),_:1})]),_:1})]),_:1}),n(F,{gutter:16})]),_:1},8,["model","rules"])]),_:1},8,["visible","title","onOk","onCancel"]),n(H,{visible:e.roleModalVisible,"onUpdate:visible":t[15]||(t[15]=l=>e.roleModalVisible=l),title:e.roleModalTitle,onOk:e.handleRoleSubmit,onCancel:e.resetRoleModal,width:"600px",zIndex:1e4},{default:o(()=>[n(B,{ref:"roleFormRef",model:e.roleForm,rules:e.roleRules,layout:"vertical"},{default:o(()=>[n(m,{label:"Tên vai trò",name:"name"},{default:o(()=>[n(k,{value:e.roleForm.name,"onUpdate:value":t[11]||(t[11]=l=>e.roleForm.name=l),placeholder:"Nhập tên vai trò"},null,8,["value"])]),_:1}),n(m,{label:"Mô tả",name:"description"},{default:o(()=>[n(y,{value:e.roleForm.description,"onUpdate:value":t[12]||(t[12]=l=>e.roleForm.description=l),placeholder:"Nhập mô tả",rows:3},null,8,["value"])]),_:1}),n(m,{label:"Quyền hạn",name:"permissions"},{default:o(()=>[n(A,{value:e.roleForm.permissions,"onUpdate:value":t[13]||(t[13]=l=>e.roleForm.permissions=l),mode:"multiple",placeholder:"Chọn quyền hạn","dropdown-style":{position:"fixed",zIndex:1e4,background:"white",border:"1px solid #ccc"},style:{width:"100%"}},{default:o(()=>[n(u,{value:"read"},{default:o(()=>t[26]||(t[26]=[c("Xem")])),_:1}),n(u,{value:"write"},{default:o(()=>t[27]||(t[27]=[c("Tạo")])),_:1}),n(u,{value:"update"},{default:o(()=>t[28]||(t[28]=[c("Cập nhật")])),_:1}),n(u,{value:"delete"},{default:o(()=>t[29]||(t[29]=[c("Xóa")])),_:1}),n(u,{value:"approve"},{default:o(()=>t[30]||(t[30]=[c("Phê duyệt")])),_:1})]),_:1},8,["value"])]),_:1}),n(m,{label:"Trạng thái",name:"status"},{default:o(()=>[n(A,{value:e.roleForm.status,"onUpdate:value":t[14]||(t[14]=l=>e.roleForm.status=l),"dropdown-style":{position:"fixed",zIndex:1e4,background:"white",border:"1px solid #ccc"}},{default:o(()=>[n(u,{value:"active"},{default:o(()=>t[31]||(t[31]=[c("Hoạt động")])),_:1}),n(u,{value:"inactive"},{default:o(()=>t[32]||(t[32]=[c("Ngừng hoạt động")])),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["visible","title","onOk","onCancel"])])}const ze=me(Ce,[["render",De],["__scopeId","data-v-ebdce8fc"]]);export{ze as default};
