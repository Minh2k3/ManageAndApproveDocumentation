import{u as ie}from"./use-menu-gUeO072V.js";import{_ as de,e as re,c as w,b as n,d as l,r as m,F as W,A as ue,z as ce,g as f,i as me,H as _,G as k,o as p,a as e,N as u,x as M,I as P,q as d}from"./index-HU749lUt.js";import{U as pe}from"./UploadOutlined-Cj0QsS7g.js";const fe=re({components:{UploadOutlined:pe},setup(){ie().onSelectedKeys(["approver-documents-template"]);const o=ue(),t=ce(),$=f(!1),x=f([]),H={authorization:"authorization-text"},y=f([]),V=f([]),T=f(),v=f(),g=f(!1),h=f({name:"",document_type_id:null,description:""}),C=f({file:null});me(async()=>{await o.fetchDocumentTemplates(),y.value=o.document_templates,y.value=y.value.filter(s=>s.status==="active"||s.creator.id===t.user.id),await o.fetchDocumentTypes(),V.value=o.document_types});const N={name:[{required:!0,message:"Vui lòng nhập tên mẫu văn bản"},{max:100,message:"Tên mẫu văn bản không được quá 100 ký tự"}],document_type_id:[{required:!0,message:"Vui lòng chọn loại văn bản"}]},R={file:[{required:!0,message:"Vui lòng chọn file PDF",trigger:"blur"}]},F=(s,a)=>a.label.toLowerCase().indexOf(s.toLowerCase())>=0,z=()=>{$.value=!0};function S({onSuccess:s}){setTimeout(()=>{s("ok")},0)}function B(s){const a=s.type==="application/pdf";return a||_.error("Bạn chỉ có thể upload file PDF!"),a}function A(s){let a;if(s.originFileObj)a=s.originFileObj;else if(s.url){window.open(s.url,"_blank");return}const r=URL.createObjectURL(a);window.open(r,"_blank")}const j=s=>{var a;C.file=s.fileList.length>0?s.fileList[0]:null,(a=v.value)==null||a.validateFields(["file"])},O=async({file:s,documentTemplateId:a})=>{try{const r=new FormData;return r.append("upload_file",s),r.append("document_template_id",a),{status:200,message:"File uploaded successfully",data:(await k.post("/api/document-templates/upload-file",r,{headers:{"Content-Type":"multipart/form-data"}})).data}}catch{return{status:500,message:"Lỗi khi upload file"}}},i=async()=>{try{await T.value.validateFields(),await v.value.validateFields(["file"]),g.value=!0;const s=t.role==="admin"?"active":"pending",a={...h.value,created_by:t.user.id,document_type_id:h.value.document_type_id,status:s};console.log("New Template Data:",a);const r=await k.post("/api/document-templates",a);if(r.status!==201)throw new Error("Failed to create document template");const E=C.file.originFileObj,I=r.data.document_template.id;if((await O({file:E,documentTemplateId:I})).status!==200)throw new Error("Failed to upload file");_.success("Thêm mẫu văn bản thành công!"),y.value.push(a),h.value={name:"",document_type_id:null,description:""},C.value={file:null},$.value=!1}catch(s){console.error("Validation failed:",s),_.error("Đã xảy ra lỗi khi thêm mẫu văn bản. Vui lòng kiểm tra lại thông tin.")}finally{g.value=!1}},U=async s=>{try{const a=await k.post("/api/notifications",s);a.status===201?console.log("Notification sent successfully:",a.data):console.error("Failed to send notification:",a)}catch(a){console.error("Error sending notification:",a)}},c=async(s,a)=>{try{g.value=!0;const r=s.status;if((await k.post(`/api/document-templates/${s.id}/change-status`,{status:a})).status===200){r==="pending"?(await U({notification_category_id:1,from_user_id:t.user.id,receiver_id:s.creator.id,title:`Mẫu văn bản "${s.name}" của bạn đã được chấp thuận`,content:`Mẫu văn bản "${s.name}" đã được chấp thuận và có thể sử dụng.`}),_.success(`Mẫu văn bản "${s.name}" đã được chấp thuận để sử dụng.`)):a==="active"?_.success(`Mẫu văn bản "${s.name}" đã có thể kích hoạt.`):a==="inactive"&&_.success(`Mẫu văn bản "${s.name}" đã tạm ngừng sử dụng.`);const I=y.value.findIndex(Q=>Q.id===s.id);I!==-1&&(y.value[I].status=a)}else _.error("Đã xảy ra lỗi khi thay đổi trạng thái mẫu văn bản.")}catch(r){console.error("Error changing status:",r),_.error("Không thể thay đổi trạng thái mẫu văn bản. Vui lòng thử lại sau.")}finally{g.value=!1}},L=s=>{console.log("Showing confirm active for:",s),c(s,"active")},b=s=>{console.log("Showing confirm inactive for:",s),c(s,"inactive")},D=f(!1),q=f(null),G=f(null),X=async(s,a)=>{console.log("Viewing details for:",s),D.value=!0,G.value=a;try{if(g.value=!0,D.value=!0,s.creator&&s.document_type)q.value=s;else{const r=await k.get(`/api/document-templates/${s.id}`);q.value=r.data.document_template}}catch(r){console.error("Error loading template details:",r),_.error("Không thể tải thông tin chi tiết")}finally{g.value=!1}},Y=(s,a)=>({onClick:()=>{X(s,a)},style:{cursor:"pointer"}}),Z=s=>({active:"green",pending:"orange",inactive:"red"})[s]||"default",ee=s=>({active:"Được sử dụng",pending:"Chờ duyệt",inactive:"Tạm ngừng sử dụng"})[s]||s,te=s=>s?s.split("/").pop()||s:"",se=s=>{if(!s)return"";const a=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(s)/Math.log(1024));return Math.round(s/Math.pow(1024,r)*100)/100+" "+a[r]},K="https://tminh.id.vn",oe=async s=>{if(s.file_path){const a=`${K}/documents/${s.file_path}`;await k.get(`/api/document-templates/${s.id}/download`),window.open(a,"_blank"),y.value[G.value].downloaded+=1}else _.warning("Không có file để xem")},ae=s=>s?new Date(s).toLocaleString("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",J=f(""),le=async s=>{try{const a=await k.get(`/api/document-templates/${s.id}/download`);J.value=a.data.download_url,await k.get(`/documents/${J.value}`)}catch{_.error("Không thể tải file")}},ne=s=>s>100||s==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${s}`;return{apiUrl:K,document_templates:y,document_types:V,columns:[{title:"Tên văn bản mẫu",dataIndex:"name",key:"name",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center"},{title:"Mô tả",dataIndex:"description",key:"description",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Người tạo",dataIndex:"created_by",key:"created_by",width:150,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"}],templateModalVisible:$,upload_files:x,headers:H,rules:N,uploadRules:R,formRef:T,uploadFormRef:v,formData:h,uploadData:C,loading:g,filterOption:F,showModalAddTemplate:z,handleCustomRequest:S,beforeUpload:B,handlePreview:A,handleFileChange:j,handleAddTemplate:i,showConfirmActive:L,showConfirmInactive:b,customRow:Y,detailModalVisible:D,selectedTemplate:q,viewDetail:X,getStatusColor:Z,getStatusText:ee,previewFile:oe,getFileName:te,formatFileSize:se,formatDateTime:ae,fetchFileUrl:le,getAvatarUrl:(s,a)=>s?`${K}/images/avatars/${s}`:ne(a)}}}),ve={class:"row mb-3"},he={class:"col-12"},_e={class:"row g-2"},ge={class:"col-12 col-md-4"},ye={class:"col-12 col-md-8"},we={class:"row g-2"},be={class:"col-6 col-md-3"},ke={class:"col-6 col-md-3"},Te={class:"col-6 col-md-1 d-flex align-items-center justify-content-end"},Ce={class:"row mb-3 d-flex justify-content-end"},Fe={class:"col-3"},De={class:"row"},Me={class:"col-12"},Ue={class:""},$e={class:""},Ve={key:3},Se={class:"row d-flex justify-content-end g-2"},Ae={class:"row"},Le={class:"col-12"},Ie={class:"row"},Ne={class:"col-12"},Re={class:"row d-flex justify-content-end g-2"},ze={key:0,class:"template-detail"},Be={class:"row mb-3"},je={class:"col-12"},Oe={class:"text-primary mb-2"},qe={class:"row mb-3"},Ke={class:"col-6"},Ee={class:"info-item"},Pe={class:"mt-1"},xe={class:"col-6"},He={class:"info-item"},Ge={class:"mt-1"},Xe={class:"row mb-3"},Je={class:"col-12"},Qe={class:"info-item"},We={class:"mt-2 p-3 bg-light rounded"},Ye={key:0,class:"mb-0"},Ze={key:1,class:"mb-0 text-muted"},et={class:"row mb-3"},tt={class:"col-12"},st={class:"info-item"},ot={class:"mt-2"},at={key:0,class:"file-item d-flex align-items-center justify-content-between p-3 border rounded bg-white"},lt={class:"d-flex align-items-center"},nt={class:"fw-medium"},it={class:"text-muted"},dt={class:"file-actions"},rt={key:1,class:"text-muted text-center p-3 border rounded bg-light"},ut={class:"row mb-3"},ct={class:"col-6"},mt={class:"stat-card text-center p-3 border rounded bg-primary bg-opacity-10"},pt={class:"stat-number text-primary fs-4 fw-bold"},ft={class:"col-6"},vt={class:"stat-card text-center p-3 border rounded bg-opacity-10",style:{"background-color":"rgba(247, 82, 123, 0.3)"}},ht={class:"stat-number fs-4 fw-bold",style:{color:"#f7527b"}},_t={class:"row"},gt={class:"col-12"},yt={class:"creator-info p-3 border rounded bg-light"},wt={class:"row align-items-center"},bt={class:"col-auto"},kt={class:"col"},Tt={class:"fw-medium"},Ct={class:"text-muted"},Ft={key:1,class:"text-center py-5"};function Dt(o,t,$,x,H,y){const V=m("a-input-search"),T=m("a-select"),v=m("a-button"),g=m("a-tooltip"),h=m("a-tag"),C=m("a-table"),N=m("a-card"),R=m("a-input"),F=m("a-form-item"),z=m("a-textarea"),S=m("a-form"),B=m("a-upload"),A=m("a-modal"),j=m("a-avatar"),O=m("a-spin");return p(),w(W,null,[n(N,{title:"",style:{width:"100%"}},{default:l(()=>[t[17]||(t[17]=e("h2",{class:"fw-bold mb-3"},"Mẫu Văn Bản",-1)),e("div",ve,[e("div",he,[e("div",_e,[e("div",ge,[n(V,{placeholder:"Tìm kiếm","allow-clear":"","enter-button":"",class:"w-100"})]),e("div",ye,[e("div",we,[e("div",be,[n(T,{value:o.status_id,"onUpdate:value":t[0]||(t[0]=i=>o.status_id=i),"show-search":"",placeholder:"Trạng thái",options:o.documents_status,"filter-option":o.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",ke,[n(T,{value:o.type_id,"onUpdate:value":t[1]||(t[1]=i=>o.type_id=i),"show-search":"",placeholder:"Loại văn bản",options:o.documents_type,"filter-option":o.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",Te,[n(v,{type:"primary",class:"w-100 w-md-auto"},{default:l(()=>t[11]||(t[11]=[e("i",{class:"fa-solid fa-filter"},null,-1)])),_:1})])])])])])]),e("div",Ce,[e("div",Fe,[n(v,{type:"primary",class:"w-100 w-md-auto",onClick:o.showModalAddTemplate},{default:l(()=>t[12]||(t[12]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),u(" Thêm mẫu mới ")])),_:1},8,["onClick"])])]),e("div",De,[e("div",Me,[n(C,{dataSource:o.document_templates,columns:o.columns,scroll:{x:576},bordered:"",customRow:o.customRow},{bodyCell:l(({column:i,index:U,record:c})=>[i.key==="type"?(p(),M(g,{key:0},{title:l(()=>[e("span",Ue,d(c.document_type.description),1)]),default:l(()=>[e("span",null,d(c.document_type.name),1)]),_:2},1024)):P("",!0),i.key==="status"?(p(),w(W,{key:1},[c.status==="active"?(p(),M(h,{key:0,color:"green"},{default:l(()=>t[13]||(t[13]=[u(d("Hoạt động"))])),_:1})):c.status==="pending"?(p(),M(h,{key:1,color:"orange"},{default:l(()=>t[14]||(t[14]=[u(d("Chờ duyệt"))])),_:1})):c.status==="inactive"?(p(),M(h,{key:2,color:"red"},{default:l(()=>t[15]||(t[15]=[u(d("Không hoạt động"))])),_:1})):c.status==="reject"?(p(),M(h,{key:3,color:"volcano"},{default:l(()=>t[16]||(t[16]=[u(d("Bị từ chối"))])),_:1})):P("",!0)],64)):i.key==="created_by"?(p(),M(g,{key:2},{title:l(()=>[e("span",$e,d(c.creator.position_title),1)]),default:l(()=>[e("span",null,d(c.creator.name),1)]),_:2},1024)):i.key==="created_at"?(p(),w("span",Ve,d(o.formatDateTime(c.created_at)),1)):P("",!0)]),_:1},8,["dataSource","columns","customRow"])])])]),_:1}),n(A,{open:o.templateModalVisible,"onUpdate:open":t[7]||(t[7]=i=>o.templateModalVisible=i),width:"500px",centered:"","z-index":1003},{title:l(()=>t[18]||(t[18]=[e("span",{class:"fw-bold"},"Thêm mẫu mới",-1)])),footer:l(()=>[e("div",Se,[n(v,{type:"primary",class:"col-3",onClick:o.handleAddTemplate,loading:o.loading},{default:l(()=>t[19]||(t[19]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),u(" Thêm mới ")])),_:1},8,["onClick","loading"]),n(v,{type:"default",class:"col-2",onClick:t[2]||(t[2]=i=>o.templateModalVisible=!1)},{default:l(()=>t[20]||(t[20]=[e("i",{class:"fa-solid fa-xmark me-2"},null,-1),u(" Đóng ")])),_:1})])]),default:l(()=>[e("div",Ae,[e("div",Le,[n(S,{ref:"formRef",model:o.formData,rules:o.rules,layout:"vertical"},{default:l(()=>[n(F,{label:"Tên mẫu văn bản",name:"name","has-feedback":""},{default:l(()=>[n(R,{value:o.formData.name,"onUpdate:value":t[3]||(t[3]=i=>o.formData.name=i),"allow-clear":"",placeholder:"Nhập tên mẫu văn bản"},null,8,["value"])]),_:1}),n(F,{label:"Loại văn bản",name:"document_type_id","has-feedback":""},{default:l(()=>[n(T,{value:o.formData.document_type_id,"onUpdate:value":t[4]||(t[4]=i=>o.formData.document_type_id=i),"show-search":"",placeholder:"Chọn loại văn bản",options:o.document_types,"filter-option":o.filterOption,"allow-clear":"","list-height":200,"dropdown-style":{position:"fixed",zIndex:1e4,background:"white",border:"1px solid #ccc"}},null,8,["value","options","filter-option"])]),_:1}),n(F,{label:"Mô tả",name:"description"},{default:l(()=>[n(z,{value:o.formData.description,"onUpdate:value":t[5]||(t[5]=i=>o.formData.description=i),rows:"4",placeholder:"Nhập mô tả cho mẫu văn bản"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])])]),e("div",Ie,[e("div",Ne,[t[22]||(t[22]=e("h6",null,"Tệp tin đính kèm",-1)),n(S,{ref:"uploadFormRef",model:o.uploadData,rules:o.uploadRules},{default:l(()=>[n(F,{name:"file"},{default:l(()=>[n(B,{"file-list":o.uploadData.file,"onUpdate:fileList":t[6]||(t[6]=i=>o.uploadData.file=i),name:"file",accept:".pdf",headers:o.headers,"show-upload-list":!0,"custom-request":o.handleCustomRequest,"before-upload":o.beforeUpload,"max-count":1,onPreview:o.handlePreview,onChange:o.handleFileChange},{default:l(()=>[n(v,null,{default:l(()=>t[21]||(t[21]=[e("span",null,[e("i",{class:"bi bi-upload me-2"}),u("Chọn file PDF ")],-1)])),_:1})]),_:1},8,["file-list","headers","custom-request","before-upload","onPreview","onChange"])]),_:1})]),_:1},8,["model","rules"])])])]),_:1},8,["open"]),n(A,{open:o.detailModalVisible,"onUpdate:open":t[10]||(t[10]=i=>o.detailModalVisible=i),width:"600px",centered:"","z-index":1003},{title:l(()=>t[23]||(t[23]=[e("span",{class:"fw-bold"},"Chi tiết mẫu văn bản",-1)])),footer:l(()=>[e("div",Re,[n(v,{type:"primary",class:"col-3",onClick:t[8]||(t[8]=i=>o.detailModalVisible=!1)},{default:l(()=>t[24]||(t[24]=[e("i",{class:"fa-solid fa-check me-2"},null,-1),u(" Đóng ")])),_:1})])]),default:l(()=>{var i,U,c,L;return[o.selectedTemplate?(p(),w("div",ze,[e("div",Be,[e("div",je,[e("h5",Oe,[t[25]||(t[25]=e("i",{class:"fa-solid fa-file-text me-2"},null,-1)),u(" "+d(o.selectedTemplate.name),1)])])]),e("div",qe,[e("div",Ke,[e("div",Ee,[t[26]||(t[26]=e("label",{class:"fw-bold text-muted"},"Loại văn bản:",-1)),e("div",Pe,[n(h,{class:"px-2 py-1"},{default:l(()=>{var b;return[u(d((b=o.selectedTemplate.document_type)==null?void 0:b.name),1)]}),_:1})])])]),e("div",xe,[e("div",He,[t[27]||(t[27]=e("label",{class:"fw-bold text-muted"},"Trạng thái:",-1)),e("div",Ge,[n(h,{color:o.getStatusColor(o.selectedTemplate.status),class:"px-2 py-1"},{default:l(()=>[u(d(o.getStatusText(o.selectedTemplate.status)),1)]),_:1},8,["color"])])])])]),e("div",Xe,[e("div",Je,[e("div",Qe,[t[29]||(t[29]=e("label",{class:"fw-bold text-muted"},"Mô tả:",-1)),e("div",We,[o.selectedTemplate.description?(p(),w("p",Ye,d(o.selectedTemplate.description),1)):(p(),w("p",Ze,t[28]||(t[28]=[e("i",null,"Chưa có mô tả",-1)])))])])])]),e("div",et,[e("div",tt,[e("div",st,[t[33]||(t[33]=e("label",{class:"fw-bold text-muted"},"File đính kèm:",-1)),e("div",ot,[o.selectedTemplate.file_path?(p(),w("div",at,[e("div",lt,[t[30]||(t[30]=e("i",{class:"fa-solid fa-file-pdf text-danger me-2 fs-4"},null,-1)),e("div",null,[e("div",nt,d(o.getFileName(o.selectedTemplate.file_path)),1),e("small",it,d(o.formatFileSize(o.selectedTemplate.file_size)),1)])]),e("div",dt,[n(v,{type:"link",size:"small",onClick:t[9]||(t[9]=b=>o.previewFile(o.selectedTemplate)),class:"me-2"},{default:l(()=>t[31]||(t[31]=[e("i",{class:"fa-solid fa-eye me-1"},null,-1),u(" Xem ")])),_:1})])])):(p(),w("div",rt,t[32]||(t[32]=[e("i",{class:"fa-solid fa-file-slash me-2"},null,-1),u(" Không có file đính kèm ")])))])])])]),e("div",ut,[e("div",ct,[e("div",mt,[e("div",pt,d(o.selectedTemplate.downloaded||0),1),t[34]||(t[34]=e("div",{class:"stat-label text-muted"},[e("span",{class:"text-primary"},[e("i",{class:"fa-solid fa-eye me-1"}),u(" Lượt xem ")])],-1))])]),e("div",ft,[e("div",vt,[e("div",ht,d(o.selectedTemplate.liked||0),1),t[35]||(t[35]=e("div",{class:"stat-label text-muted"},[e("span",{style:{color:"#f7527b"}},[e("i",{class:"fa-solid fa-heart me-1"}),u(" Lượt thích ")])],-1))])])]),e("div",_t,[e("div",gt,[e("div",yt,[e("div",wt,[e("div",bt,[n(j,{src:o.getAvatarUrl((i=o.selectedTemplate.creator)==null?void 0:i.avatar,(U=o.selectedTemplate.creator)==null?void 0:U.id),size:40,class:"me-3"},{default:l(()=>{var b,D;return[u(d((D=(b=o.selectedTemplate.creator)==null?void 0:b.name)==null?void 0:D.charAt(0)),1)]}),_:1},8,["src"])]),e("div",kt,[e("div",Tt,[e("span",null,d((c=o.selectedTemplate.creator)==null?void 0:c.name)+" - "+d((L=o.selectedTemplate.creator)==null?void 0:L.full_name_with_role),1)]),e("small",Ct," Tạo lúc: "+d(o.formatDateTime(o.selectedTemplate.created_at)),1)])])])])])])):(p(),w("div",Ft,[n(O,{size:"large"}),t[36]||(t[36]=e("div",{class:"mt-3 text-muted"},"Đang tải thông tin...",-1))]))]}),_:1},8,["open"])],64)}const At=de(fe,[["render",Dt]]);export{At as default};
