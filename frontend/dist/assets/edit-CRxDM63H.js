import{_ as ve,e as fe,c as k,a as e,b as s,r as f,d as u,F as V,u as G,x as _e,I as he,V as be,z as we,a2 as ge,g as p,i as ye,C as Ce,k as W,H as m,M as z,W as X,G as T,D as De,o as C,N as S,q as E}from"./index-DelqX8ny.js";import{u as ke}from"./use-menu-DW2wxuke.js";import{S as Se,u as Oe,a as Ue}from"./approver-store-DLfjYZXc.js";import{M as Le,D as Fe,P as je}from"./PlusCircleOutlined-19gQ4NAQ.js";import{U as Ne}from"./UploadOutlined-D-KEzNIl.js";const Pe=fe({components:{UploadOutlined:Ne,PlusCircleOutlined:je,DownCircleOutlined:Fe,MinusCircleOutlined:Le,SaveOutlined:Se,CloseCircleOutlined:be},setup(){const n=De(),D=we().user;ke().onSelectedKeys(["creator-documents-edit"]);const U=ge(),q=Oe(),R=Ue(),w=p(""),h=p(null),O=p(1),g=p([]);let F=p([]),j=p([]),b=p([]),L=p([]);ye(async()=>{await U.fetchDocumentTypes(),F.value=U.document_types,await U.fetchDocumentFlowTemplates(),j.value=U.document_flow_templates,await R.fetchApproversWithRoll(),b.value=R.approvers_with_roll,await q.fetchDepartmentsCanApprove(),L.value=q.departments_can_approve});const A=Ce(()=>L.value.slice(3)),$={authorization:"authorization-text"};function y(l){g.value=[...l.upload_files],l.file.status==="done"?m.success(`${l.file.name} upload thành công.`):l.file.status==="error"&&m.error(`${l.file.name} upload thất bại.`),console.log(g)}function B({onSuccess:l}){setTimeout(()=>{l("ok")},0)}function M(l){const a=l.type==="application/pdf";return a||m.error("Bạn chỉ có thể upload file PDF!"),a}function I(l){let a;if(l.originFileObj)a=l.originFileObj;else if(l.url){window.open(l.url,"_blank");return}const i=URL.createObjectURL(a);window.open(i,"_blank")}const o=(l,a)=>a.label.toLowerCase().indexOf(l.toLowerCase())>=0,_=p(null),c=p(""),J=p(null),Q=p(null);let N=p([]),r=p([{step:1,multichoice:!1,department_id:null,approver_id:null}]);const P=p(!1);W(_,()=>{if(!_.value){r.value=[{step:1,multichoice:!1,department_id:null,approver_id:null}];return}P.value=!0});async function Y(l){console.log("Đang lấy dữ liệu từ API...");try{const a=await T.get(`api/document-flow-steps/${l}/`,{withCredentials:!0});console.log("Response:",a.data),a.data.document_flow_steps?(N.value=a.data.document_flow_steps.map(i=>({step:i.step,multichoice:i.multichoice,department_id:i.department_id,approver_id:null})),console.log("Đã cập nhật document_flow_steps:",N.value)):console.error("Dữ liệu trả về không có document_flow_steps:",a.data)}catch(a){console.error("Lỗi khi lấy dữ liệu:",a)}}W(P,async l=>{l&&(await Y(_.value),r.value=[...N.value],P.value=!1)});function Z(){r.value=[{step:1,department_id:null,approver_id:null}],_.value=null,P.value=!1}function x(l){return l?p(b.value.filter(i=>i.department_id===l)).value.map(i=>({value:i.value,label:i.label})):[]}function ee(l){l.approver_id=null,console.log("multichoice: "+l.multichoice)}function te(){new Audio("/sounds/meow.mp3").play()}function le(l,a){const i={step:l+1,department_id:null,approver_id:null,multichoice:!1};r.value.splice(a+1,0,i);const d=i.step;for(let v=a+2;v<r.value.length;++v)r.value[v].step>=d&&(r.value[v].step+=1);te()}function ne(l,a){return a===r.value.length-1?!1:r.value[a+1].step===l}function oe(l,a){r.value[a].multichoice=!0;const i={step:l,department_id:null,approver_id:null,multichoice:!0};r.value.splice(a+1,0,i);for(let d=a;d<r.value.length;++d)r.value[d].step==l?multichoice=!0:r.value[d].step+=1}function se(l){const a=r.value[l].step;r.value.splice(l,1);for(let d=l;d<r.value.length&&r.value[d].step!=a;++d)r.value[d].step-=1;const i=new Map;for(cur_step of r)i.has(cur_step.step)?i.set(cur_step.step,i.get(cur_step.step)+1):i.set(cur_step.step,1);for(let d=0;d<r.value.length;++d)i.get(r.value[d].step)>1?r.value[d].multichoice=!0:r.value[d].multichoice=!1}const K=async({file:l,documentId:a})=>{try{const i=new FormData;i.append("upload_file",l),i.append("document_id",a);const d=await T.post("/api/documents/upload-file",i,{headers:{"Content-Type":"multipart/form-data"}});m.success("Upload file thành công")}catch{m.error("Lỗi khi upload file")}};function ae(){return w.value.trim()?h.value===null?(m.error("Không được để trống"),!1):g.value.length===0?(m.error("Chưa có văn bản đưa lên"),!1):r.value[0].department_id===null?(m.error("Chưa có đơn vị phê duyệt nào!"),!1):!0:(m.error("Hãy điền tên văn bản!"),!1)}async function ie(){var d;const l={title:w.value,document_type_id:h.value,description:c.value,created_by:D.id,is_public:O.value},a={document_flow_name:"Luồng phê duyệt cho '"+w.value+"' của "+D.name+" - "+new Date().toLocaleString(),created_by:D.id,current_flow_step:r.value},i={document:l,document_flow:a};console.log("Request data: "+JSON.stringify(i,null,2));try{const v=await T.post("/api/documents/request",i);console.log(v);const H=v.data.id;await K({file:(d=g.value[0])==null?void 0:d.originFileObj,documentId:H}),m.success("Gửi yêu cầu phê duyệt thành công"),n.push({name:"creator-documents"})}catch(v){m.error("Gửi yêu cầu phê duyệt thất bại"),console.error("Lỗi khi gửi yêu cầu phê duyệt:",v)}}function re(){z.confirm({title:"Bạn có chắc chắn gửi phê duyệt văn bản này?",icon:s(X),content:s("div",{style:"color:red;"}),onOk(){ie()},onCancel(){}})}function de(){ae()&&re()}function ue(){return w.value.trim()?h.value===null?(m.error("Không thể lưu nháp khi chưa đủ thông tin văn bản"),!1):g.value.length===0?(m.error("Không thể lưu nháp khi chưa đủ thông tin văn bản"),!1):!0:(m.error("Không thể lưu nháp khi chưa đủ thông tin văn bản"),!1)}async function ce(){var d;const l={title:w.value,document_type_id:h.value,description:c.value,created_by:D.id,is_public:O.value},a={document_flow_name:"Luồng phê duyệt cho '"+w.value+"' của "+D.name+" - "+new Date().toLocaleString(),created_by:D.id,current_flow_step:r.value},i={document:l,document_flow:a};console.log("Draft data: "+JSON.stringify(i,null,2));try{const v=await T.post("/api/documents/draft",i);console.log(v);const H=v.data.id;await K({file:(d=g.value[0])==null?void 0:d.originFileObj,documentId:H}),m.success("Lưu nháp thành công"),n.push({name:"creator-documents"})}catch(v){m.error("Lưu nháp thất bại"),console.error("Lỗi khi lưu nháp:",v)}}function pe(){z.confirm({title:"Bạn có chắc chắn lưu nháp văn bản này?",icon:s(X),content:s("div",{style:"color:red;"}),onOk(){ce()},onCancel(){}})}function me(){ue()&&pe()}return{document_name:w,document_type:h,document_public:O,document_description:c,upload_files:g,current_flow_step:r,listDocumentTypes:F,listApprovers:b,listDepartments:L,listDepartmentsForNewFlow:A,listDocumentFlows:j,headers:$,document_flow_id:_,document_flow_steps:N,department_id:J,approver_id:Q,handleChange:y,beforeUpload:M,handleCustomRequest:B,handlePreview:I,filterOption:o,getApproversByDepartment:x,handleDepartmentChange:ee,createNewWorkflow:Z,addStep:le,checkIfAfterHasSameStep:ne,addSameStep:oe,removeStep:se,handleSendRequest:de,handleSaveDraft:me}}}),Te={class:"container py-4"},qe={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},Re={class:"col"},Ae={class:"row mt-3"},$e={class:"col-sm-10"},Be={class:"row mt-3"},Me={class:"col-sm-4"},Ie={class:"d-flex"},He={class:"col align-self-center mt-3 mt-sm-0"},Ke={class:"row align-items-center justify-content-sm-end"},Ve={class:"row mt-3"},Ge={class:"col-sm-10"},We={class:"row mt-3"},ze={class:"col-sm-10"},Xe={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},Ee={class:"col"},Je={class:"row mt-3"},Qe={class:"col-12 col-sm-6"},Ye={class:"d-flex"},Ze={class:"col-12 col-sm-3 mt-3 mt-sm-0"},xe={class:"d-flex justify-content-sm-center align-items-center"},et={key:0,class:"row mt-3"},tt={class:"row mb-2"},lt={class:"col-12"},nt={class:"row my-2"},ot={class:"col-md-11 col-10 d-flex justify-content-between align-items-center mb-2"},st={class:"fs-6 fw-bold"},at={class:"row my-2"},it={class:"col-12 col-md-6 mb-3 mb-md-0"},rt={class:"row"},dt={class:"col-12"},ut={class:"col-12 col-md-6"},ct={class:"row"},pt={class:"col-12"},mt={key:1,class:"row mt-3"},vt={class:"row mb-2"},ft={class:"col-md-11 col-12"},_t={class:"row my-2"},ht={class:"col-md-11 col-10 d-flex justify-content-between align-items-center mb-2"},bt={class:"fs-6 fw-bold"},wt={class:"row my-2"},gt={class:"col-12 col-md-6 mb-3 mb-md-0"},yt={class:"row"},Ct={class:"col-12"},Dt={class:"col-12 col-md-6"},kt={class:"row"},St={class:"col-12"},Ot={class:"col-md col"},Ut={class:"row"},Lt={class:"col-md col mb-md-2"},Ft={class:"d-flex flex-wrap justify-content-end gap-2 align-items-center justify-content-md-center"},jt={class:"row mt-1"},Nt={class:"col d-flex justify-content-end align-items-center"},Pt={class:"row mt-1"},Tt={class:"col d-flex justify-content-center align-items-center gap-3"};function qt(n,t,D,U,q,R){const w=f("a-input"),h=f("a-select"),O=f("a-radio"),g=f("a-radio-group"),F=f("a-textarea"),j=f("UploadOutlined"),b=f("a-button"),L=f("a-upload"),A=f("PlusOutlined"),$=f("PlusCircleOutlined"),y=f("a-tooltip"),B=f("DownCircleOutlined"),M=f("MinusCircleOutlined"),I=f("CloseCircleOutlined");return C(),k("div",Te,[t[29]||(t[29]=e("div",{class:"d-flex justify-content-between align-items-center mb-4"},[e("div",null,[e("h1",{class:"h3 fw-bold"},"Sửa văn bản"),e("p",{class:"text-secondary"},"Sửa văn bản đã tạo")])],-1)),e("div",qe,[e("div",Re,[t[17]||(t[17]=e("div",{class:"row mb-3"},[e("div",{class:"col d-flex justify-content-center"},[e("span",{class:"fs-5 fw-bold"},"Thông tin văn bản")])],-1)),e("div",Ae,[t[7]||(t[7]=e("div",{class:"col-sm-2 text-start mb-2 mb-sm-0 align-self-center ps-3"},[e("label",null,[e("span",{class:"text-danger me-1"},"*"),e("span",null,"Tên văn bản:")])],-1)),e("div",$e,[s(w,{value:n.document_name,"onUpdate:value":t[0]||(t[0]=o=>n.document_name=o),placeholder:"Văn bản số 1","allow-clear":""},null,8,["value"]),t[6]||(t[6]=e("div",{class:"w-100"},null,-1))])]),e("div",Be,[t[11]||(t[11]=e("div",{class:"col-sm-2 text-start mb-2 mb-sm-0 align-self-center ps-3"},[e("label",null,[e("span",{class:"text-danger me-1"},"*"),e("span",null,"Loại văn bản:")])],-1)),e("div",Me,[e("div",Ie,[s(h,{value:n.document_type,"onUpdate:value":t[1]||(t[1]=o=>n.document_type=o),"show-search":"",placeholder:"Loại",style:{width:"100%"},options:n.listDocumentTypes,"filter-option":n.filterOption,"allow-clear":""},null,8,["value","options","filter-option"])])]),e("div",He,[e("div",Ke,[t[10]||(t[10]=e("span",{class:"col text-start text-sm-end"},"Hiển thị công khai:",-1)),s(g,{value:n.document_public,"onUpdate:value":t[2]||(t[2]=o=>n.document_public=o),class:"col"},{default:u(()=>[s(O,{value:1},{default:u(()=>t[8]||(t[8]=[S("Có")])),_:1}),s(O,{value:2},{default:u(()=>t[9]||(t[9]=[S("Không")])),_:1})]),_:1},8,["value"])])])]),e("div",Ve,[t[13]||(t[13]=e("div",{class:"col-sm-2 text-start mb-2 mb-sm-0 align-self-center ps-3"},[e("label",null,[e("span",null,"Mô tả:")])],-1)),e("div",Ge,[s(F,{placeholder:"Mô tả đơn giản",value:n.document_description,"onUpdate:value":t[3]||(t[3]=o=>n.document_description=o),"show-count":"",maxlength:1e3},null,8,["value"]),t[12]||(t[12]=e("div",{class:"w-100"},null,-1))])]),e("div",We,[t[16]||(t[16]=e("div",{class:"col-sm-2 text-start mb-2 mb-sm-0 align-self-top ps-3 pt-3"},[e("label",null,[e("span",{class:"text-danger me-1"},"*"),e("span",null,"Tải tệp lên:")])],-1)),e("div",ze,[s(L,{"file-list":n.upload_files,"onUpdate:fileList":t[4]||(t[4]=o=>n.upload_files=o),name:"file",accept:".pdf",headers:n.headers,"show-upload-list":!0,"custom-request":n.handleCustomRequest,"before-upload":n.beforeUpload,"max-count":1,onPreview:n.handlePreview},{default:u(()=>[s(b,null,{default:u(()=>[s(j),t[14]||(t[14]=S(" Chọn file PDF "))]),_:1})]),_:1},8,["file-list","headers","custom-request","before-upload","onPreview"]),t[15]||(t[15]=e("div",{class:"w-100"},null,-1))])])])]),e("div",Xe,[e("div",Ee,[t[28]||(t[28]=e("div",{class:"row mb-3"},[e("div",{class:"col d-flex justify-content-center"},[e("span",{class:"fs-5 fw-bold"},"Luồng phê duyệt")])],-1)),e("div",Je,[t[20]||(t[20]=e("div",{class:"col col-sm-3 text-start mb-2 mb-sm-0 align-self-center ps-3"},[e("label",null,[e("span",null,"Chọn luồng sẵn có:")])],-1)),e("div",Qe,[e("div",Ye,[s(h,{value:n.document_flow_id,"onUpdate:value":t[5]||(t[5]=o=>n.document_flow_id=o),"show-search":"",placeholder:"Luồng mẫu",style:{width:"100%"},options:n.listDocumentFlows,"filter-option":n.filterOption,"allow-clear":""},null,8,["value","options","filter-option"])])]),e("div",Ze,[e("div",xe,[t[19]||(t[19]=e("span",{class:"text-center me-2"},"Hoặc",-1)),s(b,{type:"primary",onClick:n.createNewWorkflow},{icon:u(()=>[s(A)]),default:u(()=>[t[18]||(t[18]=S(" Tạo luồng mới "))]),_:1},8,["onClick"])])])]),n.document_flow_id?(C(),k("div",et,[(C(!0),k(V,null,G(n.current_flow_step,(o,_)=>(C(),k("div",{key:_,class:"mb-4 p-3 border rounded"},[e("div",tt,[e("div",lt,[e("div",nt,[e("div",ot,[e("span",st,"Cấp duyệt "+E(o.step)+":",1)])]),e("div",at,[e("div",it,[e("div",rt,[t[21]||(t[21]=e("div",{class:"col-12 d-flex align-items-center mb-1"},[e("label",{class:"mb-md-0 mb-1"},"Đơn vị:")],-1)),e("div",dt,[s(h,{value:o.department_id,"onUpdate:value":c=>o.department_id=c,style:{width:"100%"},options:n.listDepartments,placeholder:"Chọn đơn vị",onChange:c=>n.handleDepartmentChange(o),disabled:o.multichoice===0},null,8,["value","onUpdate:value","options","onChange","disabled"])])])]),e("div",ut,[e("div",ct,[t[22]||(t[22]=e("div",{class:"col-12 d-flex align-items-center mb-1"},[e("label",{class:"mb-1 mb-md-0"},"Người duyệt:")],-1)),e("div",pt,[s(h,{value:o.approver_id,"onUpdate:value":c=>o.approver_id=c,style:{width:"100%"},options:n.getApproversByDepartment(o.department_id),placeholder:"Chọn người duyệt",allowClear:""},null,8,["value","onUpdate:value","options"])])])])])])])]))),128))])):(C(),k("div",mt,[(C(!0),k(V,null,G(n.current_flow_step,(o,_)=>(C(),k("div",{key:_,class:"mb-4 p-3 border rounded"},[e("div",vt,[e("div",ft,[e("div",_t,[e("div",ht,[e("span",bt,"Cấp duyệt "+E(o.step)+":",1)])]),e("div",wt,[e("div",gt,[e("div",yt,[t[23]||(t[23]=e("div",{class:"col-12 d-flex align-items-center mb-1"},[e("label",{class:"mb-md-0 mb-1"},"Đơn vị:")],-1)),e("div",Ct,[s(h,{value:o.department_id,"onUpdate:value":c=>o.department_id=c,style:{width:"100%"},options:n.listDepartmentsForNewFlow,placeholder:"Chọn đơn vị",onChange:c=>n.handleDepartmentChange(o),allowClear:""},null,8,["value","onUpdate:value","options","onChange"])])])]),e("div",Dt,[e("div",kt,[t[24]||(t[24]=e("div",{class:"col-12 d-flex align-items-center mb-1"},[e("label",{class:"mb-1 mb-md-0"},"Người duyệt:")],-1)),e("div",St,[s(h,{value:o.approver_id,"onUpdate:value":c=>o.approver_id=c,style:{width:"100%"},options:n.getApproversByDepartment(o.department_id),placeholder:"Chọn người duyệt",allowClear:"",disabled:o.department_id===null},null,8,["value","onUpdate:value","options","disabled"])])])])])]),e("div",Ot,[e("div",Ut,[e("div",Lt,[e("div",Ft,[s(y,{title:"Thêm cấp duyệt sau cấp hiện tại",class:"mb-md-0"},{default:u(()=>[e("span",null,[s(b,{type:"primary",disabled:!o.department_id||!o.approver_id||n.checkIfAfterHasSameStep(o.step,_),onClick:c=>n.addStep(o.step,_),class:"text-center align-self-center bg-success"},{icon:u(()=>[s($)]),_:2},1032,["disabled","onClick"])])]),_:2},1024),s(y,{title:"Thêm cấp duyệt đồng cấp với cấp hiện tại",class:"mb-md-0"},{default:u(()=>[e("span",null,[s(b,{type:"primary",disabled:!o.department_id||!o.approver_id,onClick:c=>n.addSameStep(o.step,_),class:"text-center align-self-center bg-warning"},{icon:u(()=>[s(B)]),_:2},1032,["disabled","onClick"])])]),_:2},1024),s(y,{title:"Xóa cấp duyệt này"},{default:u(()=>[e("span",null,[s(b,{type:"primary",disabled:n.current_flow_step.length<=1,onClick:c=>n.removeStep(_),class:"text-center align-self-center bg-danger"},{icon:u(()=>[s(M)]),_:2},1032,["disabled","onClick"])])]),_:2},1024)])])])])])]))),128))])),e("div",jt,[e("div",Nt,[n.current_flow_step.length>1&&n.document_flow_id===null?(C(),_e(y,{key:0,title:"Xóa toàn bộ cấp duyệt"},{default:u(()=>[e("span",null,[s(b,{type:"primary",onClick:n.createNewWorkflow,class:"text-center align-self-center bg-danger"},{icon:u(()=>[s(I,{class:"me-2"})]),default:u(()=>[t[25]||(t[25]=S(" Xóa toàn bộ luồng "))]),_:1},8,["onClick"])])]),_:1})):he("",!0)])]),e("div",Pt,[e("div",Tt,[s(y,{title:"Gửi yêu cầu phê duyệt theo luồng đã tạo"},{default:u(()=>[e("span",null,[s(b,{type:"primary",onClick:n.handleSendRequest,class:"text-center align-self-center bg-primary"},{default:u(()=>t[26]||(t[26]=[e("span",null,[e("i",{class:"bi bi-send me-2"}),S("Gửi yêu cầu")],-1)])),_:1},8,["onClick"])])]),_:1}),s(y,{title:"Lưu nháp, mai sau còn dùng lại"},{default:u(()=>[e("span",null,[s(b,{type:"primary",onClick:n.handleSaveDraft,class:"text-center align-self-center bg-secondary"},{default:u(()=>t[27]||(t[27]=[e("span",null,[e("i",{class:"bi bi-floppy me-2"}),S("Lưu nháp")],-1)])),_:1},8,["onClick"])])]),_:1})])])])])])}const It=ve(Pe,[["render",qt]]);export{It as default};
