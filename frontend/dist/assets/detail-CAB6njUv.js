import{u as te}from"./use-menu-D8a4IeYX.js";import{_ as se,e as ne,c as p,a as e,b as i,d as a,r as f,I as v,N as B,x as _,q as c,F as L,T as q,g as d,a2 as oe,z as le,s as ae,C as ie,i as de,U as re,t as ce,k as ue,m as me,H as U,G as pe,M as ve,D as fe,o as l,u as _e}from"./index-Cb7gdW67.js";import{u as be}from"./certificate-store-CIQY4xh-.js";import{P as he}from"./PDFViewer-CIltYqZV.js";import{N as ye,r as ge}from"./ProgressDocument-DSB2xkd8.js";const we=ne({components:{PDFViewer:he,NestedProgressSteps:ye},setup(){const s="https://tminh.id.vn";q.extend(ge);const t=d("document"),C=d(!1);te().onSelectedKeys(["creator-documents-detail"]);const u=oe(),E=be(),A=le().user,N=re(),P=fe(),w=d([]);let h=d([]);const y=d(""),k=d(0),D=d([]),x=d([]),S=d([]),b=ae([]),T=ie(()=>b.value.length>0?b.value[0].version+1:1),F=d(!1),K=d("");de(async()=>{await u.fetchDocuments(A.id),w.value=u.documents;const o=parseInt(N.params.id);h.value=w.value.find(r=>r.id===o)||null,await u.getDocumentVersions(o),b.value=ce(u.current_document_versions);for(let r=0;r<b.value.length;r++)b.value[r].document_data=JSON.parse(b.value[r].document_data);if(console.log("Document versions: ",b.value),await u.fetchDocumentComments(o),x.value=u.document_comments,console.log(x.value),console.log(h.value),y.value=h.value.file_path,k.value=h.value.process/h.value.step_count*100,await u.fetchStepsByDocumentFlowId(h.value.document_flow_id),S.value=u.current_document_flow_steps,console.log(S.value),S.value.is_completed){const r=await u.createCertificate(o);console.log("Certificate response message:",r.message),r.message&&(F.value=!0,h.value.certificate_path=r.certificate_path);const g=await E.findCertificateByDocumentId(o);console.log("Certificate found:",g),K.value=g?g.file_path:""}await u.fetchDocumentTypes(),D.value=u.document_types,console.log(D.value)});const n=d(""),I="https://tminh.id.vn",m=o=>o?`${I}/images/avatars/${o}`:null,R=d(null),j=d("Nhận xét"),X=async()=>{C.value=!C.value,t.value!=="comment"?(t.value="comment",j.value="Văn bản",await me(),R.value.focus()):(t.value="document",j.value="Nhận xét")};ue(t,o=>{o!=="comment"?(C.value=!1,j.value="Nhận xét"):(C.value=!0,j.value="Văn bản")});const M=d(!1),z=(o,r=null)=>{try{M.value=!0;const g=`${I}/documents/${o}`,$=document.createElement("a");$.href=g,$.download=r||o.split("/").pop(),$.style.display="none",document.body.appendChild($),$.click(),document.body.removeChild($),U.success("Đang tải file..."),setTimeout(()=>{M.value=!1},2e3)}catch(g){console.error("Error downloading file:",g),U.error("Có lỗi xảy ra khi tải file!"),M.value=!1}},Q=d(!1),W=async()=>{if(n.value===""){U.error("Vui lòng nhập bình luận");return}Q.value=!0;try{const o=parseInt(N.params.id);await pe.post(`/api/documents/${o}/comments`,{comment:n.value}),U.success("Nhận xét gửi thành công"),await u.fetchDocumentComments(o),x.value=u.document_comments,n.value=""}catch(o){U.error("Có lỗi xảy ra khi gửi nhận xét"),console.error("Error sending comment:",o)}},Y=o=>o>100||o==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${o}`,Z=async()=>{R.value.focus()},ee=[{title:"Bản",dataIndex:"version",key:"version",width:60,customRender:({version:o})=>o+1,align:"center"},{title:"Tên văn bản",dataIndex:"title",key:"title",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center",responsive:["xxl"]},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"},{title:"Thao tác",key:"action",width:150,align:"center",fixed:"right"}],H=o=>{const r=D.value.find(g=>g.value===o);return r?r.label:"Không xác định"},V=d([]),O=d({visible:!1,title:"",description:"",type:"",version:0,file_path:""}),J=o=>{console.log("Changing version to:",o),V.value=JSON.parse(JSON.stringify(o.document_data)),console.log("Version data:",V.value),O.value={visible:!0,title:V.value.title,description:V.value.description,type:H(V.value.document_type_id),version:o.version,file_path:V.value.file_path}};return{apiUrl:s,user:A,document:h,pdfUrl:y,process_of_document:k,activeKey:t,commentSection:C,comment:n,document_comments:x,dayjs:q,btnCommentText:j,commentTextarea:R,isDownloading:M,document_flow_steps:S,document_versions:b,version_columns:ee,max_version:T,detailVersion:O,show_certificate:F,certificate_file_path:K,getAvatarUrl:m,randomAvatar:Y,handleClickComment:X,handleClickDownload:z,handleSendComment:W,handleFocusCommentInput:Z,customRow:o=>({onClick:()=>{J(o)},style:{cursor:"pointer"}}),mapTypeIdToName:H,changeVersion:J,createNewVersion:o=>{ve.confirm({title:"Tạo phiên bản mới",content:"Bạn có chắc chắn muốn tạo phiên bản mới từ phiên bản này?",okText:"Tạo mới",cancelText:"Hủy",onOk:()=>{try{console.log(o.document_data),o.document_data.version=o.status==="draft"?0:o.version,u.setCurrentDocumentData(o.document_data),P.push({name:"creator-documents-create"})}catch(r){console.error("Error creating new version:",r),U.error("Có lỗi xảy ra khi tạo phiên bản mới")}},onCancel:()=>{console.log("Create new version cancelled")}})}}}}),ke={class:"container-fluid"},Ce={class:"container py-1"},Ne={class:"row justify-content-between gap-3"},xe={class:"col-xl-7"},Se={class:"row"},Te={class:"col text-end mb-2 mb-xl-0 align-self-top ps-3 pt-1"},Ve=["href"],$e={key:0,class:"row"},Ue={class:"col text-end mb-2 mb-xl-0 align-self-top ps-3 pt-1"},De=["href"],Ie={key:1,class:"row"},Re={class:"col text-end mb-2 mb-xl-0 align-self-top ps-3 pt-1"},je=["href"],Be={class:"col"},Ae={class:"row mb-3"},Pe={class:"d-flex justify-content-center"},Fe={class:"fs-5 fw-bold fst-italic"},Ke={class:"row mb-3 border-1 border border-dark rounded-3 bg-light py-1"},Me={class:"col align-self-center"},Le={class:"col-10"},Ee={class:"row"},He={class:"fw-bold"},Oe={class:"row"},Je={class:"text-muted"},qe={class:"row text-end"},Ge={class:"text-muted"},Xe={key:1,class:"row mb-3"},ze={class:"col d-flex justify-content-center"},Qe={class:"row mb-3"},We={key:0},Ye={class:""},Ze={class:""},et={key:2,class:""},tt={class:"col-xl"},st={key:0,class:"row border-1 rounded-3 p-4 mb-4 bg-light"},nt={class:"col"},ot={class:"row mb-3"},lt={class:"col"},at={class:"row mb-3"},it={class:"col"},dt=["disabled"],rt={key:0},ct={key:1},ut={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},mt={class:"col"},pt={class:"row mt-3"},vt={class:"col-8"},ft={class:"row mt-3"},_t={class:"col-8"},bt={class:"row mt-3"},ht={class:"col-8"},yt={class:"d-flex"},gt={class:"row mt-3"},wt={class:"col-12 mt-1"},kt={class:"row mt-3"},Ct={class:"col-8"},Nt={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},xt={class:"col"},St={class:"row mb-3"},Tt={class:"text-center"},Vt={key:0,class:"fst-italic text-success"},$t={key:1,class:"fst-italic text-danger"},Ut={key:2,class:"fst-italic text-secondary"},Dt={class:"modal-content"},It={class:"modal-body"},Rt={class:"info-grid"},jt={class:"info-item"},Bt={class:"info-value"},At={class:"info-item"},Pt={class:"info-value"},Ft={class:"info-row"},Kt={class:"info-item half"},Mt={class:"info-value"},Lt={class:"document-type-badge"},Et={class:"info-item half"},Ht={class:"info-value"},Ot={class:"version-badge"},Jt={class:"info-item"},qt={class:"info-value"},Gt=["href"],Xt={class:"modal-footer"};function zt(s,t,C,u,E,G){const A=f("PDFViewer"),N=f("a-tab-pane"),P=f("a-avatar"),w=f("a-button"),h=f("a-empty"),y=f("a-tooltip"),k=f("a-tag"),D=f("a-space"),x=f("a-table"),S=f("a-tabs"),b=f("a-textarea"),T=f("a-input"),F=f("NestedProgressSteps"),K=f("a-modal");return l(),p(L,null,[e("div",ke,[t[36]||(t[36]=e("h2",{class:"fw-bold mb-3"},"Chi tiết văn bản",-1)),e("div",null,[e("div",Ce,[e("div",Ne,[e("div",xe,[i(S,{activeKey:s.activeKey,"onUpdate:activeKey":t[0]||(t[0]=n=>s.activeKey=n),type:"card",class:"row border-1 rounded-3 p-4 mb-2 bg-light"},{default:a(()=>[i(N,{key:"document",tab:"Văn bản"},{default:a(()=>[e("div",Se,[e("div",Te,[e("label",null,[e("a",{href:`${s.apiUrl}/documents/${s.document.file_path}`,target:"_blank",class:"text-decoration-none fst-italic"}," Mở tệp trong tab mới ",8,Ve)])])]),s.show_certificate?(l(),p("div",$e,[e("div",Ue,[e("label",null,[e("a",{href:`${s.apiUrl}/documents/certificates/${s.document.certificate_path}`,target:"_blank",class:"text-decoration-none fst-italic"}," Chứng chỉ số ",8,De)])])])):v("",!0),s.show_certificate?(l(),p("div",Ie,[e("div",Re,[e("label",null,[e("a",{href:`${s.apiUrl}/documents/certificates/${s.certificate_file_path}`,target:"_blank",class:"text-decoration-none fst-italic"}," Văn bản đã ký số ",8,je)])])])):v("",!0),e("div",null,[e("div",Be,[e("div",Ae,[e("div",Pe,[t[10]||(t[10]=e("span",{class:"fs-5 fw-bold"},"Tên tài liệu:",-1)),t[11]||(t[11]=B("   ")),e("span",Fe,c(s.document.title),1)])])]),e("div",null,[i(A,{"pdf-url":s.pdfUrl},null,8,["pdf-url"])])])]),_:1}),i(N,{key:"comment",tab:`Nhận xét (${s.document_comments.total_current_comments})`,"force-render":""},{default:a(()=>[s.document_comments.total_current_comments>0?(l(!0),p(L,{key:0},_e(s.document_comments.current_comments,(n,I)=>(l(),p("div",{key:I},[e("div",Ke,[e("div",Me,[n.user.avatar?(l(),_(P,{key:0,class:"",src:s.getAvatarUrl(n.user.avatar)},null,8,["src"])):(l(),_(P,{key:1,class:"",src:s.randomAvatar(n.user.id),alt:"Random Avatar"},null,8,["src"]))]),e("div",Le,[e("div",Ee,[e("span",He,c(n.user.id===s.user.id?`Tôi (${n.user.name})`:n.user.name),1)]),e("div",Oe,[e("span",Je,c(n.content),1)]),e("div",qe,[e("span",Ge,c(n.commented_at),1)])])])]))),128)):(l(),p("div",Xe,[e("div",ze,[i(h,{image:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNvPNFo6a-PV4l-vMo8Hcsoj5rRr2I5XIJUQ&s","image-style":{height:"50px"}},{description:a(()=>t[12]||(t[12]=[e("span",{class:"fw-bold fs-5"},"Chưa có bình luận nào",-1),e("br",null,null,-1),e("span",null,"Hãy là người đầu tiên chia sẻ ý kiến về văn bản này",-1)])),default:a(()=>[i(w,{type:"primary",onClick:s.handleFocusCommentInput},{default:a(()=>t[13]||(t[13]=[B("Nhận xét ngay")])),_:1},8,["onClick"])]),_:1})])]))]),_:1},8,["tab"]),i(N,{key:"versions",tab:`Phiên bản (${s.document.version_count})`},{default:a(()=>[t[22]||(t[22]=e("div",{class:"row mb-3"},[e("h4",{class:"fw-bold"},"Các phiên bản")],-1)),e("div",Qe,[i(x,{dataSource:s.document_versions,columns:s.version_columns,scroll:{x:576},bordered:"",customRow:s.customRow,showSorterTooltip:!1,locale:{triggerDesc:"Nhấn để sắp xếp giảm dần",triggerAsc:"Nhấn để sắp xếp tăng dần",cancelSort:"Nhấn để hủy sắp xếp"}},{headerCell:a(({column:n})=>[n.key==="title"?(l(),_(y,{key:0,title:"Sắp xếp theo tên văn bản"},{default:a(()=>[e("span",null,c(n.title),1)]),_:2},1024)):n.key==="status"?(l(),_(y,{key:1,title:"Sắp xếp theo trạng thái"},{default:a(()=>[e("span",null,c(n.title),1)]),_:2},1024)):n.key==="created_at"?(l(),_(y,{key:2,title:"Sắp xếp theo ngày tạo"},{default:a(()=>[e("span",null,c(n.title),1)]),_:2},1024)):v("",!0)]),bodyCell:a(({column:n,index:I,record:m})=>[n.key==="version"?(l(),p("span",We,c(m.version),1)):v("",!0),n.key==="title"?(l(),_(y,{key:1},{title:a(()=>[e("span",Ye,c(m.document_data.description),1)]),default:a(()=>[e("span",Ze,c(m.document_data.title),1)]),_:2},1024)):v("",!0),n.key==="type"?(l(),p("span",et,c(s.mapTypeIdToName(m.document_data.document_type_id)),1)):v("",!0),n.key==="status"?(l(),p(L,{key:3},[m.status==="approved"?(l(),_(k,{key:0,color:"green"},{default:a(()=>t[14]||(t[14]=[e("span",null,"Đã duyệt",-1)])),_:1})):v("",!0),m.status==="in_review"?(l(),_(k,{key:1,color:"orange"},{default:a(()=>t[15]||(t[15]=[e("span",null,"Chờ duyệt",-1)])),_:1})):v("",!0),m.status==="rejected"?(l(),_(k,{key:2,color:"red"},{default:a(()=>t[16]||(t[16]=[e("span",null,"Bị từ chối",-1)])),_:1})):v("",!0),m.status==="draft"?(l(),_(k,{key:3,color:"blue"},{default:a(()=>t[17]||(t[17]=[e("span",null,"Bản nháp",-1)])),_:1})):v("",!0)],64)):v("",!0),n.key==="action"?(l(),_(D,{key:4,class:"d-flex justify-content-center gap-3"},{default:a(()=>[i(y,null,{title:a(()=>t[18]||(t[18]=[e("span",{class:""},"Xem chi tiết",-1)])),default:a(()=>[i(w,{onClick:R=>s.changeVersion(m),class:"bg-primary text-white"},{default:a(()=>t[19]||(t[19]=[e("i",{class:"bi bi-eye"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024),m.status==="rejected"&&m.version===s.max_version||m.status==="draft"?(l(),_(y,{key:0},{title:a(()=>t[20]||(t[20]=[e("span",{class:""},"Tạo phiên bản mới",-1)])),default:a(()=>[i(w,{onClick:R=>s.createNewVersion(m),class:"bg-success text-white"},{default:a(()=>t[21]||(t[21]=[e("i",{class:"bi bi-plus-circle"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024)):v("",!0)]),_:2},1024)):v("",!0)]),_:1},8,["dataSource","columns","customRow"])])]),_:1},8,["tab"])]),_:1},8,["activeKey"])]),e("div",tt,[s.commentSection?(l(),p("div",st,[e("div",nt,[t[25]||(t[25]=e("div",{class:"row mb-3"},[e("div",{class:"col d-flex justify-content-center"},[e("span",{class:"fs-5 fw-bold"},"Nhận xét")])],-1)),e("div",ot,[e("div",lt,[i(b,{placeholder:"Nhập nhận xét của bạn",value:s.comment,"onUpdate:value":t[1]||(t[1]=n=>s.comment=n),"show-count":"",maxlength:1e3,ref:"commentTextarea"},null,8,["value"])])]),e("div",at,[e("div",it,[e("button",{class:"border border-2 rounded-2 w-100 py-2 bg-secondary text-white button-click-effect",style:{"--bs-bg-opacity":".9"},onClick:t[2]||(t[2]=(...n)=>s.handleSendComment&&s.handleSendComment(...n)),disabled:s.loadingSendComment},[s.loadingSendComment?(l(),p("span",rt,t[23]||(t[23]=[e("i",{class:"spinner-border spinner-border-sm me-2"},null,-1),B(" Đang gửi nhận xét... ")]))):(l(),p("span",ct,t[24]||(t[24]=[e("i",{class:"bi bi-chat-square-dots me-2"},null,-1),B("Gửi nhận xét ")])))],8,dt)])])])])):v("",!0),e("div",ut,[e("div",mt,[t[33]||(t[33]=e("div",{class:"row mb-3"},[e("div",{class:"col d-flex justify-content-center"},[e("span",{class:"fs-5 fw-bold"},"Thông tin văn bản")])],-1)),e("div",pt,[t[27]||(t[27]=e("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[e("label",null,[e("span",null,"Người tạo:")])],-1)),e("div",vt,[i(T,{value:s.document.creator_name,"onUpdate:value":t[3]||(t[3]=n=>s.document.creator_name=n),placeholder:"Văn bản số 1",disabled:""},null,8,["value"]),t[26]||(t[26]=e("div",{class:"w-100"},null,-1))])]),e("div",ft,[t[29]||(t[29]=e("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[e("label",null,[e("span",null,"Tên văn bản:")])],-1)),e("div",_t,[i(T,{value:s.document.title,"onUpdate:value":t[4]||(t[4]=n=>s.document.title=n),placeholder:"Văn bản số 1",disabled:""},null,8,["value"]),t[28]||(t[28]=e("div",{class:"w-100"},null,-1))])]),e("div",bt,[t[30]||(t[30]=e("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[e("label",null,[e("span",null,"Loại văn bản:")])],-1)),e("div",ht,[e("div",yt,[i(T,{value:s.document.type,"onUpdate:value":t[5]||(t[5]=n=>s.document.type=n),placeholder:"Love",disabled:""},null,8,["value"])])])]),e("div",gt,[t[31]||(t[31]=e("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[e("label",null,[e("span",null,"Mô tả:")])],-1)),e("div",wt,[i(b,{placeholder:"Mô tả đơn giản",value:s.document.description,"onUpdate:value":t[6]||(t[6]=n=>s.document.description=n),"show-count":"",maxlength:1e3,disabled:""},null,8,["value"])])]),e("div",kt,[t[32]||(t[32]=e("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[e("label",null,[e("span",null,"Ngày tạo:")])],-1)),e("div",Ct,[i(T,{value:s.document.created_at,"onUpdate:value":t[7]||(t[7]=n=>s.document.created_at=n),placeholder:"Ngày chờ, tháng nhớ, năm mong",disabled:""},null,8,["value"])])])])]),e("div",Nt,[e("div",xt,[e("div",St,[e("div",Tt,[t[34]||(t[34]=e("span",{class:"fs-5 fw-bold"},"Luồng phê duyệt",-1)),t[35]||(t[35]=e("br",null,null,-1)),s.document.status==="approved"?(l(),p("span",Vt,"Đã được duyệt")):s.document.status==="rejected"?(l(),p("span",$t,"Bị từ chối")):(l(),p("span",Ut,"Tiến độ: "+c(s.document_flow_steps.progress_percentage)+"%",1))]),s.document_flow_steps&&Object.keys(s.document_flow_steps).length>0?(l(),_(F,{key:0,steps:s.document_flow_steps},null,8,["steps"])):v("",!0)])])])])])])])]),i(K,{open:s.detailVersion.visible,"onUpdate:open":t[9]||(t[9]=n=>s.detailVersion.visible=n),width:"480px",zIndex:1e4,footer:null,centered:"",class:"document-modal"},{default:a(()=>[e("div",Dt,[t[43]||(t[43]=e("div",{class:"modal-header"},[e("div",{class:"header-content"},[e("span",{class:"header-icon"},"📄"),e("h3",{class:"modal-title"},"Thông tin văn bản")])],-1)),e("div",It,[e("div",Rt,[e("div",jt,[t[37]||(t[37]=e("div",{class:"info-label"},"📝 Tiêu đề",-1)),e("div",Bt,c(s.detailVersion.title),1)]),e("div",At,[t[38]||(t[38]=e("div",{class:"info-label"},"📋 Mô tả",-1)),e("div",Pt,c(s.detailVersion.description??"Không có mô tả"),1)]),e("div",Ft,[e("div",Kt,[t[39]||(t[39]=e("div",{class:"info-label"},"🏷️ Loại văn bản",-1)),e("div",Mt,[e("span",Lt,c(s.detailVersion.type),1)])]),e("div",Et,[t[40]||(t[40]=e("div",{class:"info-label"},"🔢 Phiên bản",-1)),e("div",Ht,[e("span",Ot,"v"+c(s.detailVersion.version),1)])])]),e("div",Jt,[t[41]||(t[41]=e("div",{class:"info-label"},"📎 Tệp đính kèm",-1)),e("div",qt,[e("a",{href:`${s.apiUrl}/documents/${s.detailVersion.file_path}`,target:"_blank",class:"file-link"}," 📂 Xem tệp 🔗 ",8,Gt)])])])]),e("div",Xt,[i(w,{type:"primary",onClick:t[8]||(t[8]=n=>s.detailVersion.visible=!1),class:"close-button"},{default:a(()=>t[42]||(t[42]=[B(" Đóng ")])),_:1})])])]),_:1},8,["open"])],64)}const ns=se(we,[["render",zt],["__scopeId","data-v-9ef0aa20"]]);export{ns as default};
