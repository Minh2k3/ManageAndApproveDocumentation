import{u as pt}from"./use-menu-Ch1M1A0s.js";import{u as gt}from"./certificate-store-DW8rbSIm.js";import{b as d,O as ft,_ as ht,e as bt,x as N,d as a,r as v,z as wt,y as Ct,g as u,i as ye,C as S,j as yt,H as G,o as c,a as t,q as i,N as r,c as p,I as f,F as q,J as kt,n as ve,u as de,w as I,X as Tt,Y as le,Z as ke,E as Ut,$ as Te}from"./index-CoRCteip.js";import{u as At}from"./department-store-DfyYNekg.js";var St={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M456 231a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0zm0 280a56 56 0 10112 0 56 56 0 10-112 0z"}}]},name:"more",theme:"outlined"};function Ue(s){for(var e=1;e<arguments.length;e++){var b=arguments[e]!=null?Object(arguments[e]):{},M=Object.keys(b);typeof Object.getOwnPropertySymbols=="function"&&(M=M.concat(Object.getOwnPropertySymbols(b).filter(function(F){return Object.getOwnPropertyDescriptor(b,F).enumerable}))),M.forEach(function(F){Dt(s,F,b[F])})}return s}function Dt(s,e,b){return e in s?Object.defineProperty(s,e,{value:b,enumerable:!0,configurable:!0,writable:!0}):s[e]=b,s}var pe=function(e,b){var M=Ue({},e,b.attrs);return d(ft,Ue({},M,{icon:St}),null)};pe.displayName="MoreOutlined";pe.inheritAttrs=!1;const Nt=bt({components:{MoreOutlined:pe},setup(){pt().onSelectedKeys(["admin-signatures"]),wt();const s=gt(),e=At(),b=Ct(),M=u("1"),F=u(!1),Q=u(""),L=u(void 0),T=u(void 0),R=u(!1),U=u([]),x=u([]),h=u([]);ye(async()=>{await s.fetchCertificates(),U.value=s.certificates,console.log("Đã fetch xong"),await e.fetchDepartments(),x.value=e.departments.filter(o=>o.group!=="Khác"),console.log("Đã fetch xong departments: ",x.value),await b.fetchUsers(),h.value=b.users,console.log("Đã fetch xong users: ",h.value)});const C=u("user"),E=u(null),$=u(""),A=u(null),z=u(null),O=u(""),_=u(0),W=u([]),J=u(!1),ae=S(()=>h.value.length),w=u(!1),V=u(!1),P=u([]),ie=o=>{if(!o){P.value=[];return}V.value=!0,setTimeout(()=>{P.value=h.value.filter(l=>l.name.toLowerCase().includes(o.toLowerCase())||l.email.toLowerCase().includes(o.toLowerCase())),V.value=!1},300)},ue=o=>{A.value=h.value.find(l=>l.id===o),$.value=o.toString()},n=()=>{if($.value){const o=parseInt($.value);A.value=h.value.find(l=>l.id===o),E.value=o}else A.value=null,E.value=null},g=()=>{var o;W.value=h.value.filter(l=>l.department_id===z.value),O.value=((o=x.value.find(l=>l.id===z.value))==null?void 0:o.name)||"",console.log("Department users: ",W),_.value=W.value.length},m=()=>({user:"Người dùng cụ thể",department:"Theo tổ chức",all:"Tất cả người dùng"})[C.value],Z=()=>C.value==="user"?A.value?1:0:C.value==="department"?_.value:ae.value,Ae=async()=>{if(C.value==="user"&&!A.value){G.error("Vui lòng chọn người dùng",2);return}if(C.value==="department"&&!z.value){G.error("Vui lòng chọn tổ chức",2);return}if(C.value==="all"&&!J.value){G.error("Vui lòng xác nhận cấp chữ ký cho tất cả người dùng",2);return}w.value=!0;try{if(C.value==="user")(await s.issueCertificate(A.value.id)).success===!0&&(w.value=!1,R.value=!1,G.success(`Đã cấp chữ ký thành công cho ${Z()} người dùng`),ce(),await s.fetchCertificates());else if(C.value==="department"){const o=u(0);for(const l of W.value)(await s.issueCertificate(l.id)).success===!0&&o.value++;w.value=!1,R.value=!1,G.success(`Đã cấp chữ ký thành công cho ${o.value} người dùng trong ${O.value}`)}else{const o=u(0);for(const l of h.value)(await s.issueCertificate(l.id)).success===!0&&o.value++;w.value=!1,R.value=!1,G.success(`Đã cấp chữ ký thành công cho ${Z()} người dùng trong hệ thống`),ce(),await s.fetchCertificates(!0)}}catch{G.error("Đã xảy ra lỗi khi cấp chữ ký. Vui lòng thử lại sau.")}finally{w.value=!1}},ce=()=>{C.value="user",E.value=null,$.value="",A.value=null,z.value=null,_.value=0,W.value=[],J.value=!1,P.value=[]},Se=o=>{const l=o.split(" ");return l.length===0?"":l[l.length-1].charAt(0).toUpperCase()},De="http://localhost:8000",Ne=o=>o>100||o==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${o}`,Ie=(o,l)=>o?`${De}/images/avatars/${o}`:Ne(l),Me=u(!1),D=u([{id:1,subject:{commonName:"Trường Đại học Thủy lợi Root CA",organization:"Truong Dai hoc Thuy loi",country:"VN"},serialNumber:"1A2B3C4D5E6F7890",thumbprint:"SHA1: A1B2C3D4E5F67890ABCDEF1234567890ABCDEF12",validFrom:"2020-01-01",validTo:"2030-01-01",status:"active",issuedCerts:245,revokedCerts:12,keySize:"2048"}]),Re=u([{id:1,commonName:"Nguyễn Văn An",email:"an.nguyen@tlu.edu.vn",issuedDate:"2024-01-15"},{id:2,commonName:"Trần Thị Bình",email:"binh.tran@tlu.edu.vn",issuedDate:"2024-01-10"},{id:3,commonName:"Lê Minh Châu",email:"chau.le@tlu.edu.vn",issuedDate:"2024-01-08"}]),ee=u(!1),j=u(!1),te=u(!1),me=u(!1),ge=u(!1),xe=u(!1),K=u(null),se=u(""),ne=u(""),re=u(!1),X=u(10),Y=u(null),H=u({commonName:"",organization:"Truong Dai hoc Thuy loi",country:"VN",validityYears:"10",keySize:"4096"}),ze=S(()=>U.value.length),Oe=S(()=>U.value.filter(o=>o.status==="renewal").length),We=S(()=>U.value.filter(o=>o.status==="revoked").length),Fe=S(()=>U.value.filter(o=>o.status==="expired").length),$e=S(()=>D.value.filter(o=>o.status==="active").length),Ve=S(()=>D.value.reduce((o,l)=>o+l.issuedCerts,0)),He=S(()=>D.value.filter(o=>o.status==="expiring_soon").length),Be=S(()=>D.value.reduce((o,l)=>o+l.revokedCerts,0)),Ge=S(()=>(10-X.value)/10*100),Le=[{title:"Người dùng",dataIndex:"user",key:"user",width:150,customHeaderCell:()=>({style:{textAlign:"center"}}),responsive:["xs","sm","md","lg","xl"]},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,responsive:["xs","sm","md","lg","xl"],align:"center"},{title:"Sử dụng",dataIndex:"used_count",key:"used_count",width:100,responsive:["lg","xl"],align:"center"},{title:"Ngày tạo",dataIndex:"createdAt",key:"createdAt",width:120,responsive:["xl"],align:"center"},{title:"Ngày hết hạn",dataIndex:"expires_at",key:"expires_at",width:150,responsive:["md","lg","xl"],align:"center"},{title:"Thao tác",key:"action",width:150,responsive:["xs","sm","md","lg","xl"],align:"center",fixed:"right"}],Ee=[{title:"Thông tin chứng chỉ",dataIndex:"certificate",key:"certificate",width:350,slots:{customRender:"certificate"}},{title:"Trạng thái",dataIndex:"status",key:"status",width:140,slots:{customRender:"rootStatus"}},{title:"Thời hạn hiệu lực",dataIndex:"validity",key:"validity",width:200,slots:{customRender:"validity"}},{title:"Thống kê",dataIndex:"stats",key:"stats",width:150,slots:{customRender:"stats"}},{title:"Thao tác",key:"action",width:100,slots:{customRender:"rootAction"}}],B=u({current:1,pageSize:10,total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(o,l)=>`${l[0]}-${l[1]} của ${o} mục`}),_e=S(()=>{let o=[...U.value];if(Q.value){const l=Q.value.toLowerCase();o=o.filter(y=>y.user.name.toLowerCase().includes(l)||y.user.email.toLowerCase().includes(l)||y.user.department.toLowerCase().includes(l))}return L.value&&(o=o.filter(l=>l.status===L.value)),T.value&&(o=o.filter(l=>l.type===T.value)),B.value.total=o.length,o}),Pe=o=>({active:"Đang sử dụng",revoked:"Bị thu hồi",expired:"Hết hạn",renewal:"Yêu cầu làm mới"})[o]||o,je=o=>({active:"text-success font-weight-bold",expired:"text-warning font-weight-bold",revoked:"text-danger font-weight-bold",renewal:"text-secondary font-weight-bold"})[o]||"",Ke=o=>({active:"Đang hoạt động",expiring_soon:"Sắp hết hạn",expired:"Đã hết hạn",revoked:"Đã thu hồi"})[o]||o,Xe=o=>({active:"text-success fw-bold",expiring_soon:"text-warning fw-bold",expired:"text-danger fw-bold",revoked:"text-muted fw-bold"})[o]||"",Ye=o=>({active:"fas fa-check-circle",expiring_soon:"fas fa-exclamation-triangle",expired:"fas fa-times-circle",revoked:"fas fa-ban"})[o]||"fas fa-question-circle",qe=o=>new Date(o).toLocaleDateString("vi-VN"),Qe=o=>{const l=new Date,oe=new Date(o)-l,k=Math.ceil(oe/(1e3*60*60*24));return k<0?"Đã hết hạn":k<30?`Còn ${k} ngày`:k<365?`Còn ${Math.ceil(k/30)} tháng`:`Còn ${Math.ceil(k/365)} năm`},Je=o=>{const l=new Date,oe=new Date(o)-l,k=Math.ceil(oe/(1e3*60*60*24));return k<0||k<30?"text-danger small fw-bold":k<90?"text-warning small fw-bold":"text-success small"},Ze=()=>{B.value.current=1},et=()=>{B.value.current=1},tt=()=>{Q.value="",L.value=void 0,T.value=void 0,B.value.current=1},st=o=>{B.value=o},nt=(o,l)=>{console.log("User signature menu clicked:",o.key,l)},ot=(o,l)=>{const{key:y}=o;switch(K.value=l,y){case"view":console.log("View CA details:",l);break;case"export":be(l);break;case"renew":we(l);break;case"revoke":Ce(l);break;case"delete":fe(l);break}},fe=o=>{K.value=o,ee.value=!0},lt=()=>{ee.value=!1,j.value=!0},at=()=>{j.value=!1,te.value=!0},it=()=>{if(!(!se.value||!ne.value||!re.value)){if(se.value!=="admin123"){alert("Mật khẩu admin không chính xác!");return}te.value=!1,me.value=!0,rt()}},rt=()=>{X.value=10,Y.value=setInterval(()=>{X.value--,X.value<=0&&clearInterval(Y.value)},1e3)},he=()=>{ee.value=!1,j.value=!1,te.value=!1,me.value=!1,K.value=null,se.value="",ne.value="",re.value=!1,Y.value&&clearInterval(Y.value)},dt=()=>{if(X.value>0)return;const o=D.value.findIndex(l=>l.id===K.value.id);o!==-1&&(D.value.splice(o,1),console.log("Đã xóa Root CA:",K.value.subject.commonName),console.log("Lý do:",ne.value)),he()},ut=()=>{j.value=!1,ee.value=!0},ct=()=>{te.value=!1,j.value=!0,se.value="",ne.value="",re.value=!1},be=o=>{console.log("Export CA:",o.subject.commonName)},we=o=>{console.log("Renew CA:",o.subject.commonName)},Ce=o=>{console.log("Revoke CA:",o.subject.commonName)},mt=()=>{console.log("Export all certificates")},vt=()=>{const o=Math.max(...D.value.map(k=>k.id))+1,l=new Date,y=new Date(l.getFullYear()+parseInt(H.value.validityYears),l.getMonth(),l.getDate()),oe={id:o,subject:{commonName:H.value.commonName,organization:H.value.organization,country:H.value.country},serialNumber:Math.random().toString(16).substring(2,18).toUpperCase(),thumbprint:"SHA1: "+Math.random().toString(16).substring(2,42).toUpperCase(),validFrom:l.toISOString().split("T")[0],validTo:y.toISOString().split("T")[0],status:"active",issuedCerts:0,revokedCerts:0,keySize:H.value.keySize};D.value.unshift(oe),ge.value=!1,H.value={commonName:"",organization:"Truong Dai hoc Thuy loi",country:"VN",validityYears:"10",keySize:"4096"}};return ye(()=>{B.value.total=U.value.length}),yt(()=>{Y.value&&clearInterval(Y.value)}),{activeKey:M,loading:F,searchText:Q,statusFilter:L,typeFilter:T,columns:Le,filteredData:_e,pagination:B,totalUserSignatures:ze,renewalCount:Oe,revokedCount:We,expiredCount:Fe,allUsers:h,grantType:C,selectedUserId:E,manualUserId:$,selectedUserInfo:A,selectedDepartment:z,departmentUserCount:_,departmentUsers:W,confirmGrantAll:J,totalUsersInSystem:ae,isGenerating:w,userSearchLoading:V,searchedUsers:P,departments:x,showGenerateSignatureUserModal:R,handleUserSearch:ie,handleUserSelect:ue,handleManualUserIdChange:n,handleDepartmentSelect:g,getGrantTypeText:m,getTargetUserCount:Z,resetSignatureForm:ce,generateNewUserSignature:Ae,getCharOfName:Se,getAvatarUrl:Ie,rootCALoading:Me,rootCAs:D,rootCAColumns:Ee,recentChildCerts:Re,activeRootCAs:$e,totalIssuedCerts:Ve,expiringSoon:He,revokedCerts:Be,showDeleteWarning1:ee,showDeleteWarning2:j,showDeleteWarning3:te,showFinalWarning:me,showGenerateModal:ge,showImportModal:xe,selectedCA:K,adminPassword:se,deleteReason:ne,confirmUnderstand:re,countdown:X,progressPercent:Ge,newCA:H,getStatusText:Pe,getStatusClass:je,handleSearch:Ze,handleFilter:et,resetFilters:tt,handleTableChange:st,handleMenuClick:nt,getRootStatusText:Ke,getRootStatusClass:Xe,getRootStatusIcon:Ye,formatDate:qe,getExpiryText:Qe,getExpiryClass:Je,handleRootMenuClick:ot,startDeleteProcess:fe,proceedToWarning2:lt,proceedToWarning3:at,proceedToFinalWarning:it,cancelDelete:he,confirmDelete:dt,backToWarning1:ut,backToWarning2:ct,exportCA:be,renewCA:we,revokeCA:Ce,exportAllCerts:mt,generateNewRootCA:vt}}}),It={class:"row mt-2"},Mt={class:"col"},Rt={class:"border border-1 border-primary rounded-2 bg-light p-3"},xt={class:"row"},zt={class:"fw-bold fs-4 text-primary"},Ot={class:"col"},Wt={class:"border border-1 border-warning rounded-2 bg-light p-3"},Ft={class:"row"},$t={class:"fw-bold fs-4 text-warning"},Vt={class:"col"},Ht={class:"border border-1 border-danger rounded-2 bg-light p-3"},Bt={class:"row"},Gt={class:"fw-bold fs-4 text-danger"},Lt={class:"col"},Et={class:"border border-1 border-dark rounded-2 bg-light p-3"},_t={class:"row"},Pt={class:"fw-bold fs-4 text-dark"},jt={class:"row"},Kt={class:"col"},Xt={class:"row mt-3"},Yt={class:"signature-list-container"},qt={class:"mb-4 row"},Qt={class:"col"},Jt={class:"col"},Zt={class:"col"},es={class:"text-uppercase"},ts={key:0,class:"user-info"},ss={class:"font-weight-bold"},ns={class:"text-muted small"},os={class:"text-muted small"},ls={key:1,class:"signature-info"},as={class:"font-weight-bold text-primary"},is={class:"text-muted small"},rs={class:"text-primary"},ds={key:4,class:""},us={key:5,class:""},cs={class:"root-ca-content"},ms={class:"row mb-4"},vs={class:"col-md-3"},ps={class:"border border-1 border-primary rounded-2 bg-light p-3"},gs={class:"row"},fs={class:"fw-bold fs-4 text-primary"},hs={class:"col-md-3"},bs={class:"border border-1 border-success rounded-2 bg-light p-3"},ws={class:"row"},Cs={class:"fw-bold fs-4 text-success"},ys={class:"col-md-3"},ks={class:"border border-1 border-warning rounded-2 bg-light p-3"},Ts={class:"row"},Us={class:"fw-bold fs-4 text-warning"},As={class:"col-md-3"},Ss={class:"border border-1 border-danger rounded-2 bg-light p-3"},Ds={class:"row"},Ns={class:"fw-bold fs-4 text-danger"},Is={class:"row mb-4"},Ms={class:"col-12"},Rs={class:"row"},xs={class:"col-12"},zs={class:"cert-info"},Os={class:"fw-bold text-primary"},Ws={class:"text-muted small"},Fs={class:"text-muted small"},$s={class:"text-muted small"},Vs={class:"validity-info"},Hs={class:"small"},Bs={class:"small"},Gs={class:"stats-info"},Ls={class:"small text-success"},Es={class:"small text-danger"},_s={class:"alert alert-danger"},Ps={class:"text-center mt-4"},js={class:"alert alert-danger"},Ks={class:"mt-3"},Xs={class:"alert alert-info"},Ys={class:"small"},qs={class:"text-center mt-4"},Qs={class:"mb-3"},Js={class:"mb-3"},Zs={class:"form-check mb-3"},en={class:"text-center mt-4"},tn=["disabled"],sn={class:"text-center"},nn={class:"alert alert-danger"},on={class:"display-1 text-danger fw-bold"},ln={class:"progress mt-3"},an={class:"mt-4"},rn=["disabled"],dn=["disabled"],un={class:"row"},cn={class:"col-md-6"},mn={class:"mb-3"},vn={class:"col-md-6"},pn={class:"mb-3"},gn={class:"row"},fn={class:"col-md-6"},hn={class:"mb-3"},bn={class:"col-md-6"},wn={class:"mb-3"},Cn={class:"mb-3"},yn={class:"signature-grant-form"},kn={class:"mb-4"},Tn={key:0,class:"user-specific-form"},Un={class:"row"},An={class:"col-md-6"},Sn={class:"mb-3"},Dn={class:"d-flex align-items-center"},Nn={class:""},In={class:"col-md-6"},Mn={class:"mb-3"},Rn={key:0,class:"selected-user-info"},xn={class:"alert alert-info"},zn={class:"d-flex align-items-center"},On={class:"fw-bold"},Wn={class:"text-muted"},Fn={class:"text-muted small"},$n={key:1,class:"department-form"},Vn={class:"row"},Hn={class:"col-md-6"},Bn={class:"mb-3"},Gn={class:"col-md-6"},Ln={class:"mb-3"},En={key:0,class:"department-users"},_n={class:"user-preview-list"},Pn={key:0,class:"text-muted small"},jn={key:2,class:"all-users-form"},Kn={class:"alert alert-warning"},Xn={class:"mb-0"},Yn={class:"confirmation-section"},qn={class:"form-check"};function Qn(s,e,b,M,F,Q){const L=v("a-input-search"),T=v("a-select-option"),R=v("a-select"),U=v("a-button"),x=v("a-avatar"),h=v("a-tag"),C=v("a-tooltip"),E=v("a-popconfirm"),$=v("a-space"),A=v("a-table"),z=v("a-tab-pane"),O=v("a-menu-item"),_=v("a-menu-divider"),W=v("a-menu"),J=v("a-dropdown"),ae=v("a-tabs"),w=v("a-modal"),V=v("a-radio"),P=v("a-radio-group"),ie=v("a-input"),ue=v("a-card");return c(),N(ue,{class:"",style:{width:"100%"}},{default:a(()=>[e[122]||(e[122]=t("div",{class:"row"},[t("div",{class:"col-12"},[t("h1",null,"Quản lý chữ ký"),t("p",null,"Code nhanh còn nghỉ khỏe, đi ăn chơi xả láng")])],-1)),d(ae,{activeKey:s.activeKey,"onUpdate:activeKey":e[9]||(e[9]=n=>s.activeKey=n),type:"card",class:"row mt-3"},{default:a(()=>[d(z,{key:"1",tab:"Chữ ký người dùng"},{default:a(()=>[t("div",It,[t("div",Mt,[t("div",Rt,[e[38]||(e[38]=t("div",{class:"row"},[t("span",{class:"text-primary"},"Tổng số chữ ký")],-1)),t("div",xt,[t("span",zt,i(s.totalUserSignatures),1)])])]),t("div",Ot,[t("div",Wt,[e[39]||(e[39]=t("div",{class:"row"},[t("span",{class:"text-warning"},"Đang xin cấp")],-1)),t("div",Ft,[t("span",$t,i(s.renewalCount),1)])])]),t("div",Vt,[t("div",Ht,[e[40]||(e[40]=t("div",{class:"row"},[t("span",{class:"text-danger"},"Bị thu hồi")],-1)),t("div",Bt,[t("span",Gt,i(s.revokedCount),1)])])]),t("div",Lt,[t("div",Et,[e[41]||(e[41]=t("div",{class:"row"},[t("span",{class:"text-dark"},"Hết hạn")],-1)),t("div",_t,[t("span",Pt,i(s.expiredCount),1)])])])]),t("div",jt,[t("div",Kt,[t("button",{class:"btn btn-primary mt-3",onClick:e[0]||(e[0]=n=>s.showGenerateSignatureUserModal=!0)},e[42]||(e[42]=[t("i",{class:"fas fa-plus"},null,-1),r(" Tạo chữ ký mới ")])),t("button",{class:"btn btn-secondary mt-3 ms-2",onClick:e[1]||(e[1]=(...n)=>s.exportAllSignatures&&s.exportAllSignatures(...n))},e[43]||(e[43]=[t("i",{class:"fas fa-download"},null,-1),r(" Export tất cả ")])),t("button",{class:"btn btn-info mt-3 ms-2",onClick:e[2]||(e[2]=n=>s.showImportModal=!0)},e[44]||(e[44]=[t("i",{class:"fas fa-upload"},null,-1),r(" Import chữ ký ")]))])]),t("div",Xt,[t("div",Yt,[t("div",qt,[t("div",Qt,[d(L,{value:s.searchText,"onUpdate:value":e[3]||(e[3]=n=>s.searchText=n),placeholder:"Tìm kiếm theo tên, email...","allow-clear":"",onSearch:s.handleSearch},null,8,["value","onSearch"])]),t("div",Jt,[d(R,{value:s.statusFilter,"onUpdate:value":e[4]||(e[4]=n=>s.statusFilter=n),placeholder:"Lọc theo trạng thái","allow-clear":"",style:{width:"100%"},onChange:s.handleFilter},{default:a(()=>[d(T,{value:"renewal"},{default:a(()=>e[45]||(e[45]=[r("Xin cấp lại")])),_:1}),d(T,{value:"active"},{default:a(()=>e[46]||(e[46]=[r("Đang sử dụng")])),_:1}),d(T,{value:"revoked"},{default:a(()=>e[47]||(e[47]=[r("Bị thu hồi")])),_:1}),d(T,{value:"expired"},{default:a(()=>e[48]||(e[48]=[r("Hết hạn")])),_:1})]),_:1},8,["value","onChange"])]),t("div",Zt,[d(U,{type:"primary",onClick:s.resetFilters},{default:a(()=>e[49]||(e[49]=[r(" Đặt lại ")])),_:1},8,["onClick"])])]),d(A,{columns:s.columns,"data-source":s.filteredData,pagination:s.pagination,loading:s.loading,scroll:{x:1200},"row-key":"id",onChange:s.handleTableChange},{headerCell:a(({column:n})=>[t("span",es,i(n.title),1)]),bodyCell:a(({column:n,index:g,record:m})=>[n.key==="user"?(c(),p("div",ts,[d(x,{size:40,class:"mr-3",src:s.getAvatarUrl(m.user.avatar,m.user.id)},null,8,["src"]),t("div",null,[t("div",ss,i(m.user.name),1),t("div",ns,i(m.user.email),1),t("div",os,i(m.user.department),1)])])):f("",!0),n.key==="signature"?(c(),p("div",ls,[t("div",as,i(m.signature.name),1),t("div",is," Public Key: "+i(m.signature.publicKey.substring(0,20))+"... ",1)])):f("",!0),n.key==="status"?(c(),p(q,{key:2},[m.status==="active"?(c(),N(h,{key:0,color:"green"},{default:a(()=>e[50]||(e[50]=[t("span",null," Đang sử dụng ",-1)])),_:1})):m.status==="request_renewal"?(c(),N(h,{key:1,color:"blue"},{default:a(()=>e[51]||(e[51]=[t("span",null," Xin cấp lại ",-1)])),_:1})):m.status==="revoked"?(c(),N(h,{key:2,color:"red"},{default:a(()=>e[52]||(e[52]=[t("span",null," Bị thu hồi ",-1)])),_:1})):m.status==="expired"?(c(),N(h,{key:3,color:"gray"},{default:a(()=>e[53]||(e[53]=[t("span",null," Hết hạn ",-1)])),_:1})):f("",!0)],64)):f("",!0),n.key==="used_count"?(c(),p(q,{key:3},[t("span",rs,i(m.used_count),1),e[54]||(e[54]=t("span",null," lần",-1))],64)):f("",!0),n.key==="createdAt"?(c(),p("span",ds,i(m.issued_at),1)):f("",!0),n.key==="expires_at"?(c(),p("span",us,i(m.expires_at),1)):f("",!0),n.key==="action"?(c(),N($,{key:6,class:"d-flex justify-content-center gap-3"},{default:a(()=>[d(C,null,{title:a(()=>e[55]||(e[55]=[t("span",{class:""},"Xem chi tiết",-1)])),default:a(()=>[d(U,{onClick:Z=>s.viewDetail(m,g),class:"bg-primary text-white"},{default:a(()=>e[56]||(e[56]=[t("i",{class:"bi bi-eye"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024),m.status==="active"?(c(),N(E,{key:0,placement:"topRight","ok-text":"Yes","cancel-text":"No",onConfirm:Z=>s.handleConfirmRevoke(m)},{title:a(()=>e[57]||(e[57]=[t("span",{class:""},"Bạn có chắc chắn thu hồi chữ ký này?",-1)])),default:a(()=>[d(U,{class:"bg-danger text-white",onClick:e[5]||(e[5]=kt(()=>{},["stop"]))},{default:a(()=>e[58]||(e[58]=[t("i",{class:"bi bi-dash-circle"},null,-1)])),_:1})]),_:2},1032,["onConfirm"])):f("",!0)]),_:2},1024)):f("",!0)]),_:1},8,["columns","data-source","pagination","loading","onChange"])])])]),_:1}),d(z,{key:"2",tab:"Chứng chỉ tổ chức","force-render":""},{default:a(()=>[t("div",cs,[t("div",ms,[t("div",vs,[t("div",ps,[e[59]||(e[59]=t("div",{class:"row"},[t("span",{class:"text-primary"},"Root CA đang hoạt động")],-1)),t("div",gs,[t("span",fs,i(s.activeRootCAs),1)])])]),t("div",hs,[t("div",bs,[e[60]||(e[60]=t("div",{class:"row"},[t("span",{class:"text-success"},"Chứng chỉ con đã cấp")],-1)),t("div",ws,[t("span",Cs,i(s.totalIssuedCerts),1)])])]),t("div",ys,[t("div",ks,[e[61]||(e[61]=t("div",{class:"row"},[t("span",{class:"text-warning"},"Sắp hết hạn")],-1)),t("div",Ts,[t("span",Us,i(s.expiringSoon),1)])])]),t("div",As,[t("div",Ss,[e[62]||(e[62]=t("div",{class:"row"},[t("span",{class:"text-danger"},"Đã thu hồi")],-1)),t("div",Ds,[t("span",Ns,i(s.revokedCerts),1)])])])]),t("div",Is,[t("div",Ms,[t("button",{class:"btn btn-primary me-2",onClick:e[6]||(e[6]=n=>s.showGenerateModal=!0)},e[63]||(e[63]=[t("i",{class:"fas fa-plus"},null,-1),r(" Tạo Root CA mới ")])),t("button",{class:"btn btn-info me-2",onClick:e[7]||(e[7]=(...n)=>s.exportAllCerts&&s.exportAllCerts(...n))},e[64]||(e[64]=[t("i",{class:"fas fa-download"},null,-1),r(" Export tất cả ")])),t("button",{class:"btn btn-secondary",onClick:e[8]||(e[8]=n=>s.showImportModal=!0)},e[65]||(e[65]=[t("i",{class:"fas fa-upload"},null,-1),r(" Import Root CA ")]))])]),t("div",Rs,[t("div",xs,[d(A,{columns:s.rootCAColumns,"data-source":s.rootCAs,pagination:!1,loading:s.rootCALoading,"row-key":"id",class:"root-ca-table"},{certificate:a(({record:n})=>[t("div",zs,[t("div",Os,i(n.subject.commonName),1),t("div",Ws,"Organization: "+i(n.subject.organization),1),t("div",Fs,"Serial: "+i(n.serialNumber),1),t("div",$s,"Thumbprint: "+i(n.thumbprint.substring(0,20))+"...",1)])]),rootStatus:a(({record:n})=>[t("span",{class:ve(s.getRootStatusClass(n.status))},[t("i",{class:ve(s.getRootStatusIcon(n.status))},null,2),r(" "+i(s.getRootStatusText(n.status)),1)],2)]),validity:a(({record:n})=>[t("div",Vs,[t("div",Hs,[e[66]||(e[66]=t("strong",null,"Từ:",-1)),r(" "+i(s.formatDate(n.validFrom)),1)]),t("div",Bs,[e[67]||(e[67]=t("strong",null,"Đến:",-1)),r(" "+i(s.formatDate(n.validTo)),1)]),t("div",{class:ve(s.getExpiryClass(n.validTo))},[e[68]||(e[68]=t("i",{class:"fas fa-clock"},null,-1)),r(" "+i(s.getExpiryText(n.validTo)),1)],2)])]),stats:a(({record:n})=>[t("div",Gs,[t("div",Ls,[e[69]||(e[69]=t("i",{class:"fas fa-certificate"},null,-1)),e[70]||(e[70]=r(" Đã cấp: ")),t("strong",null,i(n.issuedCerts),1)]),t("div",Es,[e[71]||(e[71]=t("i",{class:"fas fa-ban"},null,-1)),e[72]||(e[72]=r(" Đã thu hồi: ")),t("strong",null,i(n.revokedCerts),1)])])]),rootAction:a(({record:n})=>[d(J,{trigger:["click"],placement:"bottomRight"},{default:a(()=>[d(W,{onClick:g=>s.handleRootMenuClick(g,n)},{default:a(()=>[d(O,{key:"view"},{default:a(()=>e[73]||(e[73]=[r(" 👁️ Xem chi tiết ")])),_:1}),d(O,{key:"export"},{default:a(()=>e[74]||(e[74]=[r(" 📥 Export ")])),_:1}),d(O,{key:"renew",disabled:n.status!=="active"},{default:a(()=>e[75]||(e[75]=[r(" 🔄 Gia hạn ")])),_:2},1032,["disabled"]),d(O,{key:"revoke",disabled:n.status!=="active"},{default:a(()=>e[76]||(e[76]=[r(" 🚫 Thu hồi ")])),_:2},1032,["disabled"]),d(_),d(O,{key:"delete",class:"text-danger"},{default:a(()=>e[77]||(e[77]=[r(" 🗑️ Xóa vĩnh viễn ")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:1},8,["columns","data-source","loading"])])])])]),_:1})]),_:1},8,["activeKey"]),d(w,{open:s.showDeleteWarning1,"onUpdate:open":e[12]||(e[12]=n=>s.showDeleteWarning1=n),title:"⚠️ Cảnh báo: Xóa Root CA",width:600,footer:null,closable:!1},{default:a(()=>{var n,g;return[t("div",_s,[e[79]||(e[79]=t("h5",null,[t("i",{class:"fas fa-exclamation-triangle"}),r(" Thao tác CỰC KỲ NGUY HIỂM!")],-1)),t("p",null,[e[78]||(e[78]=r("Bạn đang cố gắng xóa Root CA: ")),t("strong",null,i((g=(n=s.selectedCA)==null?void 0:n.subject)==null?void 0:g.commonName),1)]),e[80]||(e[80]=t("p",null,"Điều này sẽ ảnh hưởng nghiêm trọng đến toàn bộ hệ thống!",-1))]),t("div",Ps,[t("button",{class:"btn btn-secondary me-3",onClick:e[10]||(e[10]=(...m)=>s.cancelDelete&&s.cancelDelete(...m))},e[81]||(e[81]=[t("i",{class:"fas fa-times"},null,-1),r(" Hủy bỏ ")])),t("button",{class:"btn btn-warning",onClick:e[11]||(e[11]=(...m)=>s.proceedToWarning2&&s.proceedToWarning2(...m))},e[82]||(e[82]=[t("i",{class:"fas fa-forward"},null,-1),r(" Tôi hiểu, tiếp tục ")]))])]}),_:1},8,["open"]),d(w,{open:s.showDeleteWarning2,"onUpdate:open":e[15]||(e[15]=n=>s.showDeleteWarning2=n),title:"🚨 Xác nhận tác động hệ thống",width:700,footer:null,closable:!1},{default:a(()=>{var n;return[t("div",js,[e[87]||(e[87]=t("h5",null,"Tác động khi xóa Root CA này:",-1)),t("ul",Ks,[t("li",null,[t("strong",null,i(((n=s.selectedCA)==null?void 0:n.issuedCerts)||0),1),e[83]||(e[83]=r(" chứng chỉ con sẽ mất hiệu lực"))]),e[84]||(e[84]=t("li",null,[r("Tất cả chữ ký đã tạo bằng các chứng chỉ con sẽ "),t("strong",null,"KHÔNG THỂ XÁC THỰC")],-1)),e[85]||(e[85]=t("li",null,"Các văn bản đã ký có thể mất giá trị pháp lý",-1)),e[86]||(e[86]=t("li",null,"Hệ thống có thể ngưng hoạt động cho đến khi tạo Root CA mới",-1))])]),t("div",Xs,[e[88]||(e[88]=t("h6",null,"Danh sách chứng chỉ con gần đây:",-1)),t("ul",Ys,[(c(!0),p(q,null,de(s.recentChildCerts,g=>(c(),p("li",{key:g.id},i(g.commonName)+" - "+i(g.email)+" ("+i(s.formatDate(g.issuedDate))+") ",1))),128))])]),t("div",qs,[t("button",{class:"btn btn-secondary me-3",onClick:e[13]||(e[13]=(...g)=>s.backToWarning1&&s.backToWarning1(...g))},e[89]||(e[89]=[t("i",{class:"fas fa-arrow-left"},null,-1),r(" Quay lại ")])),t("button",{class:"btn btn-danger",onClick:e[14]||(e[14]=(...g)=>s.proceedToWarning3&&s.proceedToWarning3(...g))},e[90]||(e[90]=[t("i",{class:"fas fa-forward"},null,-1),r(" Tôi chấp nhận rủi ro ")]))])]}),_:1},8,["open"]),d(w,{open:s.showDeleteWarning3,"onUpdate:open":e[22]||(e[22]=n=>s.showDeleteWarning3=n),title:"🔐 Xác thực quyền admin",width:500,footer:null,closable:!1},{default:a(()=>[e[96]||(e[96]=t("div",{class:"alert alert-warning"},[t("p",null,[t("strong",null,"Bước cuối cùng:"),r(" Nhập thông tin xác thực để xác nhận bạn là admin có thẩm quyền")])],-1)),t("div",Qs,[e[91]||(e[91]=t("label",{class:"form-label"},"Mật khẩu admin:",-1)),I(t("input",{type:"password",class:"form-control","onUpdate:modelValue":e[16]||(e[16]=n=>s.adminPassword=n),placeholder:"Nhập mật khẩu admin",onKeyup:e[17]||(e[17]=Tt((...n)=>s.proceedToFinalWarning&&s.proceedToFinalWarning(...n),["enter"]))},null,544),[[le,s.adminPassword]])]),t("div",Js,[e[92]||(e[92]=t("label",{class:"form-label"},"Lý do xóa:",-1)),I(t("textarea",{class:"form-control",rows:"3","onUpdate:modelValue":e[18]||(e[18]=n=>s.deleteReason=n),placeholder:"Mô tả lý do tại sao cần xóa Root CA này"},null,512),[[le,s.deleteReason]])]),t("div",Zs,[I(t("input",{class:"form-check-input",type:"checkbox",id:"confirmUnderstand","onUpdate:modelValue":e[19]||(e[19]=n=>s.confirmUnderstand=n)},null,512),[[ke,s.confirmUnderstand]]),e[93]||(e[93]=t("label",{class:"form-check-label text-danger",for:"confirmUnderstand"},[t("strong",null,"Tôi hiểu rằng thao tác này KHÔNG THỂ HOÀN TÁC")],-1))]),t("div",en,[t("button",{class:"btn btn-secondary me-3",onClick:e[20]||(e[20]=(...n)=>s.backToWarning2&&s.backToWarning2(...n))},e[94]||(e[94]=[t("i",{class:"fas fa-arrow-left"},null,-1),r(" Quay lại ")])),t("button",{class:"btn btn-danger",onClick:e[21]||(e[21]=(...n)=>s.proceedToFinalWarning&&s.proceedToFinalWarning(...n)),disabled:!s.adminPassword||!s.deleteReason||!s.confirmUnderstand},e[95]||(e[95]=[t("i",{class:"fas fa-key"},null,-1),r(" Xác thực và tiếp tục ")]),8,tn)])]),_:1},8,["open"]),d(w,{open:s.showFinalWarning,"onUpdate:open":e[25]||(e[25]=n=>s.showFinalWarning=n),title:"⏰ Countdown cuối cùng",width:450,footer:null,closable:!1},{default:a(()=>[t("div",sn,[t("div",nn,[e[97]||(e[97]=t("h4",null,[t("i",{class:"fas fa-skull-crossbones"}),r(" CẢNH BÁO CUỐI CÙNG")],-1)),e[98]||(e[98]=t("p",null,"Root CA sẽ bị xóa vĩnh viễn sau:",-1)),t("div",on,i(s.countdown),1),t("div",ln,[t("div",{class:"progress-bar bg-danger",role:"progressbar",style:Ut({width:s.progressPercent+"%"})},null,4)])]),t("div",an,[t("button",{class:"btn btn-success me-3",onClick:e[23]||(e[23]=(...n)=>s.cancelDelete&&s.cancelDelete(...n)),disabled:s.countdown===0},e[99]||(e[99]=[t("i",{class:"fas fa-shield-alt"},null,-1),r(" HỦY BỎ AN TOÀN ")]),8,rn),t("button",{class:"btn btn-danger",onClick:e[24]||(e[24]=(...n)=>s.confirmDelete&&s.confirmDelete(...n)),disabled:s.countdown>0},e[100]||(e[100]=[t("i",{class:"fas fa-trash"},null,-1),r(" XÓA VĨNH VIỄN ")]),8,dn)])])]),_:1},8,["open"]),d(w,{open:s.showGenerateModal,"onUpdate:open":e[31]||(e[31]=n=>s.showGenerateModal=n),title:"Tạo Root CA mới",width:600,onOk:s.generateNewRootCA,"ok-text":"Tạo Root CA","cancel-text":"Hủy"},{default:a(()=>[t("div",un,[t("div",cn,[t("div",mn,[e[101]||(e[101]=t("label",{class:"form-label"},"Common Name (CN):",-1)),I(t("input",{type:"text",class:"form-control","onUpdate:modelValue":e[26]||(e[26]=n=>s.newCA.commonName=n),placeholder:"Trường Đại học Thủy lợi Root CA"},null,512),[[le,s.newCA.commonName]])])]),t("div",vn,[t("div",pn,[e[102]||(e[102]=t("label",{class:"form-label"},"Organization (O):",-1)),I(t("input",{type:"text",class:"form-control","onUpdate:modelValue":e[27]||(e[27]=n=>s.newCA.organization=n),placeholder:"Truong Dai hoc Thuy loi"},null,512),[[le,s.newCA.organization]])])])]),t("div",gn,[t("div",fn,[t("div",hn,[e[103]||(e[103]=t("label",{class:"form-label"},"Country (C):",-1)),I(t("input",{type:"text",class:"form-control","onUpdate:modelValue":e[28]||(e[28]=n=>s.newCA.country=n),placeholder:"VN",maxlength:"2"},null,512),[[le,s.newCA.country]])])]),t("div",bn,[t("div",wn,[e[105]||(e[105]=t("label",{class:"form-label"},"Thời hạn (năm):",-1)),I(t("select",{class:"form-select","onUpdate:modelValue":e[29]||(e[29]=n=>s.newCA.validityYears=n)},e[104]||(e[104]=[t("option",{value:"5"},"5 năm",-1),t("option",{value:"10"},"10 năm",-1),t("option",{value:"20"},"20 năm",-1)]),512),[[Te,s.newCA.validityYears]])])])]),t("div",Cn,[e[107]||(e[107]=t("label",{class:"form-label"},"Key Size:",-1)),I(t("select",{class:"form-select","onUpdate:modelValue":e[30]||(e[30]=n=>s.newCA.keySize=n)},e[106]||(e[106]=[t("option",{value:"2048"},"2048 bit",-1),t("option",{value:"4096"},"4096 bit (Khuyến nghị)",-1)]),512),[[Te,s.newCA.keySize]])])]),_:1},8,["open","onOk"]),d(w,{open:s.showGenerateSignatureUserModal,"onUpdate:open":e[37]||(e[37]=n=>s.showGenerateSignatureUserModal=n),title:"Cấp chữ ký cho người dùng",width:800,onOk:s.generateNewUserSignature,"ok-text":"Cấp chữ ký","cancel-text":"Hủy","confirm-loading":s.isGenerating,"z-index":3103},{default:a(()=>[t("div",yn,[t("div",kn,[e[111]||(e[111]=t("label",{class:"form-label fw-bold"},"Chọn loại cấp chữ ký:",-1)),d(P,{value:s.grantType,"onUpdate:value":e[32]||(e[32]=n=>s.grantType=n),class:"d-block mt-2"},{default:a(()=>[d(V,{value:"user",class:"d-block mb-2"},{default:a(()=>e[108]||(e[108]=[t("span",{class:"ms-2"},"Cấp cho người dùng cụ thể (theo ID)",-1)])),_:1}),d(V,{value:"department",class:"d-block mb-2"},{default:a(()=>e[109]||(e[109]=[t("span",{class:"ms-2"},"Cấp cho tổ chức/khoa",-1)])),_:1}),d(V,{value:"all",class:"d-block"},{default:a(()=>e[110]||(e[110]=[t("span",{class:"ms-2"},"Cấp cho tất cả người dùng",-1)])),_:1})]),_:1},8,["value"])]),s.grantType==="user"?(c(),p("div",Tn,[t("div",Un,[t("div",An,[t("div",Sn,[e[112]||(e[112]=t("label",{class:"form-label"},"Tìm kiếm người dùng:",-1)),d(R,{value:s.selectedUserId,"onUpdate:value":e[33]||(e[33]=n=>s.selectedUserId=n),"show-search":"",placeholder:"Nhập tên hoặc email để tìm kiếm","filter-option":!1,loading:s.userSearchLoading,onSearch:s.handleUserSearch,onChange:s.handleUserSelect,style:{width:"100%"},"dropdown-style":{position:"absolute",zIndex:1e4,background:"white",border:"1px solid #ccc"}},{default:a(()=>[(c(!0),p(q,null,de(s.searchedUsers,n=>(c(),N(T,{key:n.id,value:n.id},{default:a(()=>[t("div",Dn,[t("div",null,[t("div",Nn,i(n.name),1)])])]),_:2},1032,["value"]))),128))]),_:1},8,["value","loading","onSearch","onChange"])])]),t("div",In,[t("div",Mn,[e[113]||(e[113]=t("label",{class:"form-label"},"Hoặc nhập User ID:",-1)),d(ie,{value:s.manualUserId,"onUpdate:value":e[34]||(e[34]=n=>s.manualUserId=n),placeholder:"Nhập ID người dùng",onChange:s.handleManualUserIdChange},null,8,["value","onChange"])])])]),s.selectedUserInfo?(c(),p("div",Rn,[t("div",xn,[t("div",zn,[d(x,{size:40,class:"me-3"},{default:a(()=>[r(i(s.getCharOfName(s.selectedUserInfo.name)),1)]),_:1}),t("div",null,[t("div",On,i(s.selectedUserInfo.name)+" ("+i(s.selectedUserInfo.roll)+")",1),t("div",Wn,i(s.selectedUserInfo.email),1),t("div",Fn,i(s.selectedUserInfo.department),1)])])])])):f("",!0)])):f("",!0),s.grantType==="department"?(c(),p("div",$n,[t("div",Vn,[t("div",Hn,[t("div",Bn,[e[114]||(e[114]=t("label",{class:"form-label"},"Chọn tổ chức/khoa:",-1)),d(R,{value:s.selectedDepartment,"onUpdate:value":e[35]||(e[35]=n=>s.selectedDepartment=n),placeholder:"Chọn tổ chức",style:{width:"100%"},onChange:s.handleDepartmentSelect,"dropdown-style":{position:"absolute",zIndex:1e4,background:"white",border:"1px solid #ccc"}},{default:a(()=>[(c(!0),p(q,null,de(s.departments,n=>(c(),N(T,{key:n.id,value:n.id},{default:a(()=>[r(i(n.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","onChange"])])]),t("div",Gn,[t("div",Ln,[e[115]||(e[115]=t("label",{class:"form-label"},"Số lượng người dùng:",-1)),d(ie,{value:s.departmentUserCount,disabled:"",class:"text-center fw-bold"},null,8,["value"])])])]),s.departmentUsers.length>0?(c(),p("div",En,[e[116]||(e[116]=t("label",{class:"form-label"},"Danh sách người dùng sẽ được cấp chữ ký:",-1)),t("div",_n,[(c(!0),p(q,null,de(s.departmentUsers.slice(0,5),n=>(c(),p("div",{key:n.id,class:"user-preview-item"},[d(x,{size:24,class:"me-2"},{default:a(()=>[r(i(s.getCharOfName(n.name)),1)]),_:2},1024),t("span",null,i(n.name)+" - "+i(n.email),1)]))),128)),s.departmentUsers.length>5?(c(),p("div",Pn," ... và "+i(s.departmentUsers.length-5)+" người dùng khác ",1)):f("",!0)])])):f("",!0)])):f("",!0),s.grantType==="all"?(c(),p("div",jn,[t("div",Kn,[e[119]||(e[119]=t("h6",null,[t("i",{class:"fas fa-exclamation-triangle"}),r(" Cảnh báo")],-1)),e[120]||(e[120]=t("p",{class:"mb-2"},[r("Bạn đang chọn cấp chữ ký cho "),t("strong",null,"TẤT CẢ"),r(" người dùng trong hệ thống.")],-1)),t("p",Xn,[e[117]||(e[117]=r("Thao tác này sẽ tạo chữ ký cho ")),t("strong",null,i(s.totalUsersInSystem),1),e[118]||(e[118]=r(" người dùng."))])]),t("div",Yn,[t("div",qn,[I(t("input",{class:"form-check-input",type:"checkbox",id:"confirmGrantAll","onUpdate:modelValue":e[36]||(e[36]=n=>s.confirmGrantAll=n)},null,512),[[ke,s.confirmGrantAll]]),e[121]||(e[121]=t("label",{class:"form-check-label fw-bold text-danger",for:"confirmGrantAll"}," Tôi xác nhận muốn cấp chữ ký cho tất cả người dùng ",-1))])])])):f("",!0)])]),_:1},8,["open","onOk","confirm-loading"])]),_:1})}const so=ht(Nt,[["render",Qn],["__scopeId","data-v-5ff1d751"]]);export{so as default};
