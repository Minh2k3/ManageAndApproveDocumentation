import{u as Y}from"./use-menu-DW2wxuke.js";import{_ as Z,e as tt,c as v,a as t,b as i,d as l,r as m,I as _,N as $,x as b,q as d,F,T as O,g as r,A as et,z as st,s as nt,C as ot,i as lt,U as at,t as it,k as dt,m as rt,H as V,G as ct,M as ut,D as mt,o as a,u as pt}from"./index-DelqX8ny.js";import{P as vt}from"./PDFViewer-DeO5X2qv.js";import{N as _t,r as bt}from"./ProgressDocument-5njSt4zg.js";const ft=tt({components:{PDFViewer:vt,NestedProgressSteps:_t},setup(){O.extend(bt);const s=r("versions"),e=r(!1);Y().onSelectedKeys(["admin-documents-detail"]);const u=et(),K=st().user,M=at(),R=mt(),x=r([]);let f=r([]);const C=r(""),B=r(0),h=r([]),g=r([]),D=r([]),y=nt([]),j=ot(()=>y.value.length>0?y.value[0].version+1:1),U=[{title:"Bước 1",description:"Mô tả bước 1",status:"approved"},{title:"Bước 2",description:"Mô tả bước 2",status:"in_review"},{title:"Bước 3",description:"Mô tả bước 3",status:"waiting",subSteps:[{title:"Bước con 3.1",description:"Mô tả bước con 3.1",status:"waiting"},{title:"Bước con 3.2",description:"Mô tả bước con 3.2",status:"waiting"}]}];lt(async()=>{await u.fetchDocuments(),x.value=u.documents;const o=parseInt(M.params.id);f.value=x.value.find(p=>p.id===o)||null,await u.getDocumentVersions(o),y.value=it(u.current_document_versions);for(let p=0;p<y.value.length;p++)y.value[p].document_data=JSON.parse(y.value[p].document_data);console.log("Document versions: ",y.value),await u.fetchDocumentComments(o),g.value=u.document_comments,console.log(g.value),console.log(f.value),C.value=f.value.file_path,B.value=f.value.process/f.value.step_count*100,await u.fetchStepsByDocumentFlowId(f.value.document_flow_id),D.value=u.current_document_flow_steps,console.log(D.value),await u.fetchDocumentTypes(),h.value=u.document_types,console.log(h.value)});const w=r(""),A="http://localhost:8000",P=o=>o?`${A}/images/avatars/${o}`:null,n=r(null),k=r("Nhận xét"),c=async()=>{e.value=!e.value,s.value!=="comment"?(s.value="comment",k.value="Văn bản",await rt(),n.value.focus()):(s.value="document",k.value="Nhận xét")};dt(s,o=>{o!=="comment"?(e.value=!1,k.value="Nhận xét"):(e.value=!0,k.value="Văn bản")});const N=r(!1),q=(o,p=null)=>{try{N.value=!0;const I=`http://localhost:8000/documents/${o}`,S=document.createElement("a");S.href=I,S.download=p||o.split("/").pop(),S.style.display="none",document.body.appendChild(S),S.click(),document.body.removeChild(S),V.success("Đang tải file..."),setTimeout(()=>{N.value=!1},2e3)}catch(I){console.error("Error downloading file:",I),V.error("Có lỗi xảy ra khi tải file!"),N.value=!1}},G=r(!1),X=async()=>{if(w.value===""){V.error("Vui lòng nhập bình luận");return}G.value=!0;try{const o=parseInt(M.params.id);await ct.post(`/api/documents/${o}/comments`,{comment:w.value}),V.success("Nhận xét gửi thành công"),await u.fetchDocumentComments(o),g.value=u.document_comments,w.value=""}catch(o){V.error("Có lỗi xảy ra khi gửi nhận xét"),console.error("Error sending comment:",o)}},z=o=>o>100||o==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${o}`,Q=async()=>{n.value.focus()},W=[{title:"Bản",dataIndex:"version",key:"version",width:60,customRender:({version:o})=>o+1,align:"center"},{title:"Tên văn bản",dataIndex:"title",key:"title",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center",responsive:["xxl"]},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"},{title:"Thao tác",key:"action",width:150,align:"center",fixed:"right"}],L=o=>{const p=h.value.find(I=>I.value===o);return p?p.label:"Không xác định"},T=r([]),E=r({visible:!1,title:"",description:"",type:"",version:0,file_path:""}),H=o=>{console.log("Changing version to:",o),T.value=JSON.parse(JSON.stringify(o.document_data)),console.log("Version data:",T.value),E.value={visible:!0,title:T.value.title,description:T.value.description,type:L(T.value.document_type_id),version:o.version,file_path:T.value.file_path}};return{user:K,document:f,pdfUrl:C,process_of_document:B,activeKey:s,commentSection:e,comment:w,document_comments:g,dayjs:O,btnCommentText:k,commentTextarea:n,isDownloading:N,document_steps:U,document_flow_steps:D,document_versions:y,version_columns:W,max_version:j,detailVersion:E,getAvatarUrl:P,randomAvatar:z,handleClickComment:c,handleClickDownload:q,handleSendComment:X,handleFocusCommentInput:Q,customRow:o=>({onClick:()=>{H(o)},style:{cursor:"pointer"}}),mapTypeIdToName:L,changeVersion:H,createNewVersion:o=>{ut.confirm({title:"Tạo phiên bản mới",content:"Bạn có chắc chắn muốn tạo phiên bản mới từ phiên bản này?",okText:"Tạo mới",cancelText:"Hủy",onOk:()=>{try{console.log(o.document_data),o.document_data.version=o.status==="draft"?0:o.version,u.setCurrentDocumentData(o.document_data),R.push({name:"creator-documents-create"})}catch(p){console.error("Error creating new version:",p),V.error("Có lỗi xảy ra khi tạo phiên bản mới")}},onCancel:()=>{console.log("Create new version cancelled")}})}}}}),ht={class:"container-fluid"},yt={class:"container py-1"},gt={class:"row justify-content-between gap-3"},wt={class:"col-xl-7"},kt={class:"row"},Ct={class:"col text-end mb-2 mb-xl-0 align-self-top ps-3 pt-1"},xt=["href"],Nt={class:"col"},Tt={class:"row mb-3"},St={class:"d-flex justify-content-center"},Vt={class:"fs-5 fw-bold fst-italic"},Dt={class:"row mb-3 border-1 border border-dark rounded-3 bg-light py-1"},It={class:"col align-self-center"},$t={class:"col-10"},Bt={class:"row"},Ut={class:"fw-bold"},Mt={class:"row"},Rt={class:"text-muted"},jt={class:"row text-end"},At={class:"text-muted"},Pt={key:1,class:"row mb-3"},Ft={class:"col d-flex justify-content-center"},Kt={class:"row mb-3"},Lt={key:0},Et={class:""},Ht={class:""},Ot={key:2,class:""},Jt={class:"col-xl"},qt={key:0,class:"row border-1 rounded-3 p-4 mb-4 bg-light"},Gt={class:"col"},Xt={class:"row mb-3"},zt={class:"col"},Qt={class:"row mb-3"},Wt={class:"col"},Yt=["disabled"],Zt={key:0},te={key:1},ee={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},se={class:"col"},ne={class:"row mt-3"},oe={class:"col-8"},le={class:"row mt-3"},ae={class:"col-8"},ie={class:"row mt-3"},de={class:"col-8"},re={class:"d-flex"},ce={class:"row mt-3"},ue={class:"col-12 mt-1"},me={class:"row mt-3"},pe={class:"col-8"},ve={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},_e={class:"col"},be={class:"row mb-3"},fe={class:"text-center"},he={key:0,class:"fst-italic text-success"},ye={key:1,class:"fst-italic text-danger"},ge={key:2,class:"fst-italic text-secondary"},we={class:"modal-content"},ke={class:"modal-body"},Ce={class:"info-grid"},xe={class:"info-item"},Ne={class:"info-value"},Te={class:"info-item"},Se={class:"info-value"},Ve={class:"info-row"},De={class:"info-item half"},Ie={class:"info-value"},$e={class:"document-type-badge"},Be={class:"info-item half"},Ue={class:"info-value"},Me={class:"version-badge"},Re={class:"info-item"},je={class:"info-value"},Ae=["href"],Pe={class:"modal-footer"};function Fe(s,e,u,J,K,M){const R=m("PDFViewer"),x=m("a-tab-pane"),f=m("a-avatar"),C=m("a-button"),B=m("a-empty"),h=m("a-tooltip"),g=m("a-tag"),D=m("a-space"),y=m("a-table"),j=m("a-tabs"),U=m("a-textarea"),w=m("a-input"),A=m("NestedProgressSteps"),P=m("a-modal");return a(),v(F,null,[t("div",ht,[e[36]||(e[36]=t("h2",{class:"fw-bold mb-3"},"Chi tiết văn bản",-1)),t("div",null,[t("div",yt,[t("div",gt,[t("div",wt,[i(j,{activeKey:s.activeKey,"onUpdate:activeKey":e[0]||(e[0]=n=>s.activeKey=n),type:"card",class:"row border-1 rounded-3 p-4 mb-2 bg-light"},{default:l(()=>[i(x,{key:"document",tab:"Văn bản"},{default:l(()=>[t("div",kt,[t("div",Ct,[t("label",null,[t("a",{href:`http://localhost:8000/documents/${s.document.file_path}`,target:"_blank",class:"text-decoration-none fst-italic"}," Mở tệp trong tab mới ",8,xt)])])]),t("div",null,[t("div",Nt,[t("div",Tt,[t("div",St,[e[10]||(e[10]=t("span",{class:"fs-5 fw-bold"},"Tên tài liệu:",-1)),e[11]||(e[11]=$("   ")),t("span",Vt,d(s.document.title),1)])])]),t("div",null,[i(R,{"pdf-url":s.pdfUrl},null,8,["pdf-url"])])])]),_:1}),i(x,{key:"comment",tab:`Nhận xét (${s.document_comments.total_current_comments})`,"force-render":""},{default:l(()=>[s.document_comments.total_current_comments>0?(a(!0),v(F,{key:0},pt(s.document_comments.current_comments,(n,k)=>(a(),v("div",{key:k},[t("div",Dt,[t("div",It,[n.user.avatar?(a(),b(f,{key:0,class:"",src:s.getAvatarUrl(n.user.avatar)},null,8,["src"])):(a(),b(f,{key:1,class:"",src:s.randomAvatar(n.user.id),alt:"Random Avatar"},null,8,["src"]))]),t("div",$t,[t("div",Bt,[t("span",Ut,d(n.user.id===s.user.id?`Tôi (${n.user.name})`:n.user.name),1)]),t("div",Mt,[t("span",Rt,d(n.content),1)]),t("div",jt,[t("span",At,d(n.commented_at),1)])])])]))),128)):(a(),v("div",Pt,[t("div",Ft,[i(B,{image:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNvPNFo6a-PV4l-vMo8Hcsoj5rRr2I5XIJUQ&s","image-style":{height:"50px"}},{description:l(()=>e[12]||(e[12]=[t("span",{class:"fw-bold fs-5"},"Chưa có bình luận nào",-1),t("br",null,null,-1),t("span",null,"Hãy là người đầu tiên chia sẻ ý kiến về văn bản này",-1)])),default:l(()=>[i(C,{type:"primary",onClick:s.handleFocusCommentInput},{default:l(()=>e[13]||(e[13]=[$("Nhận xét ngay")])),_:1},8,["onClick"])]),_:1})])]))]),_:1},8,["tab"]),i(x,{key:"versions",tab:`Phiên bản (${s.document.version_count})`},{default:l(()=>[e[22]||(e[22]=t("div",{class:"row mb-3"},[t("h4",{class:"fw-bold"},"Các phiên bản")],-1)),t("div",Kt,[i(y,{dataSource:s.document_versions,columns:s.version_columns,scroll:{x:576},bordered:"",customRow:s.customRow,showSorterTooltip:!1,locale:{triggerDesc:"Nhấn để sắp xếp giảm dần",triggerAsc:"Nhấn để sắp xếp tăng dần",cancelSort:"Nhấn để hủy sắp xếp"}},{headerCell:l(({column:n})=>[n.key==="title"?(a(),b(h,{key:0,title:"Sắp xếp theo tên văn bản"},{default:l(()=>[t("span",null,d(n.title),1)]),_:2},1024)):n.key==="status"?(a(),b(h,{key:1,title:"Sắp xếp theo trạng thái"},{default:l(()=>[t("span",null,d(n.title),1)]),_:2},1024)):n.key==="created_at"?(a(),b(h,{key:2,title:"Sắp xếp theo ngày tạo"},{default:l(()=>[t("span",null,d(n.title),1)]),_:2},1024)):_("",!0)]),bodyCell:l(({column:n,index:k,record:c})=>[n.key==="version"?(a(),v("span",Lt,d(c.version),1)):_("",!0),n.key==="title"?(a(),b(h,{key:1},{title:l(()=>[t("span",Et,d(c.document_data.description),1)]),default:l(()=>[t("span",Ht,d(c.document_data.title),1)]),_:2},1024)):_("",!0),n.key==="type"?(a(),v("span",Ot,d(s.mapTypeIdToName(c.document_data.document_type_id)),1)):_("",!0),n.key==="status"?(a(),v(F,{key:3},[c.status==="approved"?(a(),b(g,{key:0,color:"green"},{default:l(()=>e[14]||(e[14]=[t("span",null,"Đã duyệt",-1)])),_:1})):_("",!0),c.status==="in_review"?(a(),b(g,{key:1,color:"orange"},{default:l(()=>e[15]||(e[15]=[t("span",null,"Chờ duyệt",-1)])),_:1})):_("",!0),c.status==="rejected"?(a(),b(g,{key:2,color:"red"},{default:l(()=>e[16]||(e[16]=[t("span",null,"Bị từ chối",-1)])),_:1})):_("",!0),c.status==="draft"?(a(),b(g,{key:3,color:"blue"},{default:l(()=>e[17]||(e[17]=[t("span",null,"Bản nháp",-1)])),_:1})):_("",!0)],64)):_("",!0),n.key==="action"?(a(),b(D,{key:4,class:"d-flex justify-content-center gap-3"},{default:l(()=>[i(h,null,{title:l(()=>e[18]||(e[18]=[t("span",{class:""},"Xem chi tiết",-1)])),default:l(()=>[i(C,{onClick:N=>s.changeVersion(c),class:"bg-primary text-white"},{default:l(()=>e[19]||(e[19]=[t("i",{class:"bi bi-eye"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024),c.status==="rejected"&&c.version===s.max_version||c.status==="draft"?(a(),b(h,{key:0},{title:l(()=>e[20]||(e[20]=[t("span",{class:""},"Tạo phiên bản mới",-1)])),default:l(()=>[i(C,{onClick:N=>s.createNewVersion(c),class:"bg-success text-white"},{default:l(()=>e[21]||(e[21]=[t("i",{class:"bi bi-plus-circle"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024)):_("",!0)]),_:2},1024)):_("",!0)]),_:1},8,["dataSource","columns","customRow"])])]),_:1},8,["tab"])]),_:1},8,["activeKey"])]),t("div",Jt,[s.commentSection?(a(),v("div",qt,[t("div",Gt,[e[25]||(e[25]=t("div",{class:"row mb-3"},[t("div",{class:"col d-flex justify-content-center"},[t("span",{class:"fs-5 fw-bold"},"Nhận xét")])],-1)),t("div",Xt,[t("div",zt,[i(U,{placeholder:"Nhập nhận xét của bạn",value:s.comment,"onUpdate:value":e[1]||(e[1]=n=>s.comment=n),"show-count":"",maxlength:1e3,ref:"commentTextarea"},null,8,["value"])])]),t("div",Qt,[t("div",Wt,[t("button",{class:"border border-2 rounded-2 w-100 py-2 bg-secondary text-white button-click-effect",style:{"--bs-bg-opacity":".9"},onClick:e[2]||(e[2]=(...n)=>s.handleSendComment&&s.handleSendComment(...n)),disabled:s.loadingSendComment},[s.loadingSendComment?(a(),v("span",Zt,e[23]||(e[23]=[t("i",{class:"spinner-border spinner-border-sm me-2"},null,-1),$(" Đang gửi nhận xét... ")]))):(a(),v("span",te,e[24]||(e[24]=[t("i",{class:"bi bi-chat-square-dots me-2"},null,-1),$("Gửi nhận xét ")])))],8,Yt)])])])])):_("",!0),t("div",ee,[t("div",se,[e[33]||(e[33]=t("div",{class:"row mb-3"},[t("div",{class:"col d-flex justify-content-center"},[t("span",{class:"fs-5 fw-bold"},"Thông tin văn bản")])],-1)),t("div",ne,[e[27]||(e[27]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Người tạo:")])],-1)),t("div",oe,[i(w,{value:s.document.creator_name,"onUpdate:value":e[3]||(e[3]=n=>s.document.creator_name=n),placeholder:"Văn bản số 1",disabled:""},null,8,["value"]),e[26]||(e[26]=t("div",{class:"w-100"},null,-1))])]),t("div",le,[e[29]||(e[29]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Tên văn bản:")])],-1)),t("div",ae,[i(w,{value:s.document.title,"onUpdate:value":e[4]||(e[4]=n=>s.document.title=n),placeholder:"Văn bản số 1",disabled:""},null,8,["value"]),e[28]||(e[28]=t("div",{class:"w-100"},null,-1))])]),t("div",ie,[e[30]||(e[30]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Loại văn bản:")])],-1)),t("div",de,[t("div",re,[i(w,{value:s.document.type,"onUpdate:value":e[5]||(e[5]=n=>s.document.type=n),placeholder:"Love",disabled:""},null,8,["value"])])])]),t("div",ce,[e[31]||(e[31]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Mô tả:")])],-1)),t("div",ue,[i(U,{placeholder:"Mô tả đơn giản",value:s.document.description,"onUpdate:value":e[6]||(e[6]=n=>s.document.description=n),"show-count":"",maxlength:1e3,disabled:""},null,8,["value"])])]),t("div",me,[e[32]||(e[32]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Ngày tạo:")])],-1)),t("div",pe,[i(w,{value:s.document.created_at,"onUpdate:value":e[7]||(e[7]=n=>s.document.created_at=n),placeholder:"Ngày chờ, tháng nhớ, năm mong",disabled:""},null,8,["value"])])])])]),t("div",ve,[t("div",_e,[t("div",be,[t("div",fe,[e[34]||(e[34]=t("span",{class:"fs-5 fw-bold"},"Luồng phê duyệt",-1)),e[35]||(e[35]=t("br",null,null,-1)),s.document.status==="approved"?(a(),v("span",he,"Đã được duyệt")):s.document.status==="rejected"?(a(),v("span",ye,"Bị từ chối")):(a(),v("span",ge,"Tiến độ: "+d(s.document_flow_steps.progress_percentage)+"%",1))]),s.document_flow_steps&&Object.keys(s.document_flow_steps).length>0?(a(),b(A,{key:0,steps:s.document_flow_steps},null,8,["steps"])):_("",!0)])])])])])])])]),i(P,{open:s.detailVersion.visible,"onUpdate:open":e[9]||(e[9]=n=>s.detailVersion.visible=n),width:"480px",zIndex:1e4,footer:null,centered:"",class:"document-modal"},{default:l(()=>[t("div",we,[e[43]||(e[43]=t("div",{class:"modal-header"},[t("div",{class:"header-content"},[t("span",{class:"header-icon"},"📄"),t("h3",{class:"modal-title"},"Thông tin văn bản")])],-1)),t("div",ke,[t("div",Ce,[t("div",xe,[e[37]||(e[37]=t("div",{class:"info-label"},"📝 Tiêu đề",-1)),t("div",Ne,d(s.detailVersion.title),1)]),t("div",Te,[e[38]||(e[38]=t("div",{class:"info-label"},"📋 Mô tả",-1)),t("div",Se,d(s.detailVersion.description??"Không có mô tả"),1)]),t("div",Ve,[t("div",De,[e[39]||(e[39]=t("div",{class:"info-label"},"🏷️ Loại văn bản",-1)),t("div",Ie,[t("span",$e,d(s.detailVersion.type),1)])]),t("div",Be,[e[40]||(e[40]=t("div",{class:"info-label"},"🔢 Phiên bản",-1)),t("div",Ue,[t("span",Me,"v"+d(s.detailVersion.version),1)])])]),t("div",Re,[e[41]||(e[41]=t("div",{class:"info-label"},"📎 Tệp đính kèm",-1)),t("div",je,[t("a",{href:`http://localhost:8000/documents/${s.detailVersion.file_path}`,target:"_blank",class:"file-link"}," 📂 Xem tệp 🔗 ",8,Ae)])])])]),t("div",Pe,[i(C,{type:"primary",onClick:e[8]||(e[8]=n=>s.detailVersion.visible=!1),class:"close-button"},{default:l(()=>e[42]||(e[42]=[$(" Đóng ")])),_:1})])])]),_:1},8,["open"])],64)}const qe=Z(ft,[["render",Fe],["__scopeId","data-v-195cbddf"]]);export{qe as default};
