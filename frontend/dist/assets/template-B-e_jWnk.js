import{u as ie}from"./use-menu-BRyuwgc6.js";import{_ as de,e as re,c as _,b as i,d as a,r as p,F as G,A as ue,z as ce,g as y,i as me,H as h,G as w,o as u,a as e,J as r,x as T,I as B,q as d}from"./index-CRJSQdz7.js";import{U as pe}from"./UploadOutlined-BEn665BI.js";const fe=re({components:{UploadOutlined:pe},setup(){ie().onSelectedKeys(["approver-documents-template"]);const s=ue(),t=ce(),$=y(!1),q=y([]),E={authorization:"authorization-text"},k=y([]),V=y([]),C=y(),f=y(),v=y(!1),g=y({name:"",document_type_id:null,description:""}),F=y({file:null});me(async()=>{await s.fetchDocumentTemplates(),k.value=s.document_templates,await s.fetchDocumentTypes(),V.value=s.document_types});const I={name:[{required:!0,message:"Vui lòng nhập tên mẫu văn bản"},{max:100,message:"Tên mẫu văn bản không được quá 100 ký tự"}],document_type_id:[{required:!0,message:"Vui lòng chọn loại văn bản"}]},N={file:[{required:!0,message:"Vui lòng chọn file PDF",trigger:"blur"}]},D=(o,l)=>l.label.toLowerCase().indexOf(o.toLowerCase())>=0,S=()=>{$.value=!0};function R({onSuccess:o}){setTimeout(()=>{o("ok")},0)}function z(o){const l=o.type==="application/pdf";return l||h.error("Bạn chỉ có thể upload file PDF!"),l}function A(o){let l;if(o.originFileObj)l=o.originFileObj;else if(o.url){window.open(o.url,"_blank");return}const m=URL.createObjectURL(l);window.open(m,"_blank")}const j=o=>{var l;F.file=o.fileList.length>0?o.fileList[0]:null,(l=f.value)==null||l.validateFields(["file"])},O=async({file:o,documentTemplateId:l})=>{try{const m=new FormData;return m.append("upload_file",o),m.append("document_template_id",l),{status:200,message:"File uploaded successfully",data:(await w.post("/api/document-templates/upload-file",m,{headers:{"Content-Type":"multipart/form-data"}})).data}}catch{return{status:500,message:"Lỗi khi upload file"}}},n=async o=>{try{const l=await w.post("/api/notifications/all-admins",o);l.status===201?console.log("Notification sent successfully:",l.data):console.error("Failed to send notification:",l)}catch(l){console.error("Error sending notification:",l)}},M=async()=>{try{await C.value.validateFields(),await f.value.validateFields(["file"]),v.value=!0;const o=t.role==="admin"?"active":"pending",l={...g.value,created_by:t.user.id,document_type_id:g.value.document_type_id,status:o};console.log("New Template Data:",l);const m=await w.post("/api/document-templates",l);if(m.status!==201)throw new Error("Failed to create document template");const P=F.file.originFileObj,ne=m.data.document_template.id;if((await O({file:P,documentTemplateId:ne})).status!==200)throw new Error("Failed to upload file");await n({notification_category_id:1,from_user_id:t.user.id,title:"Mẫu văn bản mới",content:`Đề xuất mẫu văn bản "${l.name}".`}),h.success("Thêm mẫu văn bản thành công!"),k.value.push(l),g.value={name:"",document_type_id:null,description:""},F.value={file:null},$.value=!1}catch(o){console.error("Validation failed:",o),h.error("Đã xảy ra lỗi khi thêm mẫu văn bản. Vui lòng kiểm tra lại thông tin.")}finally{v.value=!1}},c=y(!1),U=y(null),b=y(null),L=async(o,l)=>{console.log("Viewing details for:",o),c.value=!0,b.value=l;try{if(v.value=!0,c.value=!0,o.creator&&o.document_type)U.value=o;else{const m=await w.get(`/api/document-templates/${o.id}`);U.value=m.data.document_template}}catch(m){console.error("Error loading template details:",m),h.error("Không thể tải thông tin chi tiết")}finally{v.value=!1}},J=(o,l)=>({onClick:()=>{L(o,l)},style:{cursor:"pointer"}}),X=o=>({active:"green",pending:"orange",inactive:"red"})[o]||"default",Q=o=>({active:"Được sử dụng",pending:"Chờ duyệt",inactive:"Tạm ngừng sử dụng"})[o]||o,W=o=>o?o.split("/").pop()||o:"",Y=o=>{if(!o)return"";const l=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(o)/Math.log(1024));return Math.round(o/Math.pow(1024,m)*100)/100+" "+l[m]},K="https://tminh.id.vn",Z=async o=>{if(o.file_path){const l=`${K}/documents/${o.file_path}`;await w.get(`/api/document-templates/${o.id}/download`),window.open(l,"_blank"),k.value[b.value].downloaded+=1}else h.warning("Không có file để xem")},x=o=>o?new Date(o).toLocaleString("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",H=y(""),ee=async o=>{try{const l=await w.get(`/api/document-templates/${o.id}/download`);H.value=l.data.download_url,await w.get(`/documents/${H.value}`)}catch{h.error("Không thể tải file")}},te=o=>o>100||o==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${o}`,se=(o,l)=>o?`${K}/images/avatars/${o}`:te(l),oe=async o=>{try{v.value=!0,(await w.post(`/api/document-templates/${o.id}/like`)).status===200?(o.liked+=1,o.userHasLike=!0,h.success("Đã thích mẫu văn bản này")):h.error("Không thể thích mẫu văn bản này")}catch(l){console.error("Error liking template:",l),h.error("Đã xảy ra lỗi khi thích mẫu văn bản")}finally{v.value=!1}},le=async o=>{try{v.value=!0,(await w.post(`/api/document-templates/${o.id}/unlike`)).status===200?(o.liked-=1,o.userHasLike=!1,h.success("Đã bỏ thích mẫu văn bản này")):h.error("Không thể bỏ thích mẫu văn bản này")}catch(l){console.error("Error unliking template:",l),h.error("Đã xảy ra lỗi khi bỏ thích mẫu văn bản")}finally{v.value=!1}},ae=async()=>{v.value=!0;try{await s.fetchDocumentTemplates(!0),k.value=s.document_templates,k.value=k.value.filter(o=>o.status==="active"||o.creator.id===t.user.id),h.success("Đã làm mới danh sách mẫu văn bản")}catch(o){console.error("Error refreshing templates:",o),h.error("Không thể làm mới danh sách mẫu văn bản")}finally{v.value=!1}};return{apiUrl:K,document_templates:k,document_types:V,columns:[{title:"Tên văn bản mẫu",dataIndex:"name",key:"name",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center"},{title:"Mô tả",dataIndex:"description",key:"description",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Người tạo",dataIndex:"created_by",key:"created_by",width:150,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"}],templateModalVisible:$,upload_files:q,headers:E,rules:I,uploadRules:N,formRef:C,uploadFormRef:f,formData:g,uploadData:F,loading:v,filterOption:D,showModalAddTemplate:S,handleCustomRequest:R,beforeUpload:z,handlePreview:A,handleFileChange:j,handleAddTemplate:M,showConfirmActive,showConfirmInactive,customRow:J,detailModalVisible:c,selectedTemplate:U,viewDetail:L,getStatusColor:X,getStatusText:Q,previewFile:Z,getFileName:W,formatFileSize:Y,formatDateTime:x,fetchFileUrl:ee,getAvatarUrl:se,handleLikeTemplate:oe,handleUnikeTemplate:le,onRefresh:ae}}}),ve={class:"row mb-3"},he={class:"col-12"},ye={class:"row g-2"},ge={class:"col-12 col-md-4"},_e={class:"col-12 col-md-8"},be={class:"row g-2"},we={class:"col-6 col-md-3"},ke={class:"col-6 col-md-3"},Te={class:"col-6 col-md-1 d-flex align-items-center justify-content-end"},Ce={class:"col-6 col-md-1 d-flex align-items-center justify-content-end"},Fe={class:"row mb-3 d-flex justify-content-end"},De={class:"col-3"},Ue={class:"row"},Me={class:"col-12"},Le={class:""},$e={class:""},Ve={key:3},Re={class:"row d-flex justify-content-end g-2"},Ae={class:"row"},Be={class:"col-12"},Ie={class:"row"},Ne={class:"col-12"},Se={class:"row d-flex justify-content-end g-2"},ze={key:0},je={key:0,class:"template-detail"},Oe={class:"row mb-3"},Ke={class:"col-12"},qe={class:"text-primary mb-2"},Ee={class:"row mb-3"},He={class:"col-6"},Pe={class:"info-item"},Ge={class:"mt-1"},Je={class:"col-6"},Xe={class:"info-item"},Qe={class:"mt-1"},We={class:"row mb-3"},Ye={class:"col-12"},Ze={class:"info-item"},xe={class:"mt-2 p-3 bg-light rounded"},et={key:0,class:"mb-0"},tt={key:1,class:"mb-0 text-muted"},st={class:"row mb-3"},ot={class:"col-12"},lt={class:"info-item"},at={class:"mt-2"},nt={key:0,class:"file-item d-flex align-items-center justify-content-between p-3 border rounded bg-white"},it={class:"d-flex align-items-center"},dt={class:"fw-medium"},rt={class:"text-muted"},ut={class:"file-actions"},ct={key:1,class:"text-muted text-center p-3 border rounded bg-light"},mt={class:"row mb-3"},pt={class:"col-6"},ft={class:"stat-card text-center p-3 border rounded bg-primary bg-opacity-10"},vt={class:"stat-number text-primary fs-4 fw-bold"},ht={class:"col-6"},yt={class:"stat-card text-center p-3 border rounded bg-opacity-10",style:{"background-color":"rgba(247, 82, 123, 0.3)"}},gt={class:"stat-number fs-4 fw-bold",style:{color:"#f7527b"}},_t={class:"row"},bt={class:"col-12"},wt={class:"creator-info p-3 border rounded bg-light"},kt={class:"row align-items-center"},Tt={class:"col-auto"},Ct={class:"col"},Ft={class:"fw-medium"},Dt={class:"text-muted"},Ut={key:1,class:"text-center py-5"};function Mt(s,t,$,q,E,k){const V=p("a-input-search"),C=p("a-select"),f=p("a-button"),v=p("a-tooltip"),g=p("a-tag"),F=p("a-table"),I=p("a-card"),N=p("a-input"),D=p("a-form-item"),S=p("a-textarea"),R=p("a-form"),z=p("a-upload"),A=p("a-modal"),j=p("a-avatar"),O=p("a-spin");return u(),_(G,null,[i(I,{title:"",style:{width:"100%"}},{default:a(()=>[t[20]||(t[20]=e("h2",{class:"fw-bold mb-3"},"Mẫu Văn Bản",-1)),e("div",ve,[e("div",he,[e("div",ye,[e("div",ge,[i(V,{placeholder:"Tìm kiếm","allow-clear":"","enter-button":"",class:"w-100"})]),e("div",_e,[e("div",be,[e("div",we,[i(C,{value:s.status_id,"onUpdate:value":t[0]||(t[0]=n=>s.status_id=n),"show-search":"",placeholder:"Trạng thái",options:s.documents_status,"filter-option":s.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",ke,[i(C,{value:s.type_id,"onUpdate:value":t[1]||(t[1]=n=>s.type_id=n),"show-search":"",placeholder:"Loại văn bản",options:s.documents_type,"filter-option":s.filterOption,"allow-clear":"",class:"w-100"},null,8,["value","options","filter-option"])]),e("div",Te,[i(f,{type:"primary",class:"w-100 w-md-auto"},{default:a(()=>t[13]||(t[13]=[e("i",{class:"fa-solid fa-filter"},null,-1)])),_:1})]),e("div",Ce,[i(f,{type:"default",class:"w-100 w-md-auto",onClick:s.onRefresh},{default:a(()=>t[14]||(t[14]=[e("i",{class:"fa-solid fa-rotate"},null,-1)])),_:1},8,["onClick"])])])])])])]),e("div",Fe,[e("div",De,[i(f,{type:"primary",class:"w-100 w-md-auto",onClick:s.showModalAddTemplate},{default:a(()=>t[15]||(t[15]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),r(" Thêm mẫu mới ")])),_:1},8,["onClick"])])]),e("div",Ue,[e("div",Me,[i(F,{dataSource:s.document_templates,columns:s.columns,scroll:{x:576},bordered:"",customRow:s.customRow},{bodyCell:a(({column:n,index:M,record:c})=>[n.key==="type"?(u(),T(v,{key:0},{title:a(()=>[e("span",Le,d(c.document_type.description),1)]),default:a(()=>[e("span",null,d(c.document_type.name),1)]),_:2},1024)):B("",!0),n.key==="status"?(u(),_(G,{key:1},[c.status==="active"?(u(),T(g,{key:0,color:"green"},{default:a(()=>t[16]||(t[16]=[r(d("Hoạt động"))])),_:1})):c.status==="pending"?(u(),T(g,{key:1,color:"orange"},{default:a(()=>t[17]||(t[17]=[r(d("Chờ duyệt"))])),_:1})):c.status==="inactive"?(u(),T(g,{key:2,color:"red"},{default:a(()=>t[18]||(t[18]=[r(d("Không hoạt động"))])),_:1})):c.status==="reject"?(u(),T(g,{key:3,color:"volcano"},{default:a(()=>t[19]||(t[19]=[r(d("Bị từ chối"))])),_:1})):B("",!0)],64)):n.key==="created_by"?(u(),T(v,{key:2},{title:a(()=>[e("span",$e,d(c.creator.position_title),1)]),default:a(()=>[e("span",null,d(c.creator.name),1)]),_:2},1024)):n.key==="created_at"?(u(),_("span",Ve,d(s.formatDateTime(c.created_at)),1)):B("",!0)]),_:1},8,["dataSource","columns","customRow"])])])]),_:1}),i(A,{open:s.templateModalVisible,"onUpdate:open":t[7]||(t[7]=n=>s.templateModalVisible=n),width:"500px",centered:"","z-index":1003},{title:a(()=>t[21]||(t[21]=[e("span",{class:"fw-bold"},"Thêm mẫu mới",-1)])),footer:a(()=>[e("div",Re,[i(f,{type:"primary",class:"col-3",onClick:s.handleAddTemplate,loading:s.loading},{default:a(()=>t[22]||(t[22]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),r(" Thêm mới ")])),_:1},8,["onClick","loading"]),i(f,{type:"default",class:"col-2",onClick:t[2]||(t[2]=n=>s.templateModalVisible=!1)},{default:a(()=>t[23]||(t[23]=[e("i",{class:"fa-solid fa-xmark me-2"},null,-1),r(" Đóng ")])),_:1})])]),default:a(()=>[e("div",Ae,[e("div",Be,[i(R,{ref:"formRef",model:s.formData,rules:s.rules,layout:"vertical"},{default:a(()=>[i(D,{label:"Tên mẫu văn bản",name:"name","has-feedback":""},{default:a(()=>[i(N,{value:s.formData.name,"onUpdate:value":t[3]||(t[3]=n=>s.formData.name=n),"allow-clear":"",placeholder:"Nhập tên mẫu văn bản"},null,8,["value"])]),_:1}),i(D,{label:"Loại văn bản",name:"document_type_id","has-feedback":""},{default:a(()=>[i(C,{value:s.formData.document_type_id,"onUpdate:value":t[4]||(t[4]=n=>s.formData.document_type_id=n),"show-search":"",placeholder:"Chọn loại văn bản",options:s.document_types,"filter-option":s.filterOption,"allow-clear":"","list-height":200,"dropdown-style":{position:"fixed",zIndex:1e4,background:"white",border:"1px solid #ccc"}},null,8,["value","options","filter-option"])]),_:1}),i(D,{label:"Mô tả",name:"description"},{default:a(()=>[i(S,{value:s.formData.description,"onUpdate:value":t[5]||(t[5]=n=>s.formData.description=n),rows:"4",placeholder:"Nhập mô tả cho mẫu văn bản"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])])]),e("div",Ie,[e("div",Ne,[t[25]||(t[25]=e("h6",null,"Tệp tin đính kèm",-1)),i(R,{ref:"uploadFormRef",model:s.uploadData,rules:s.uploadRules},{default:a(()=>[i(D,{name:"file"},{default:a(()=>[i(z,{"file-list":s.uploadData.file,"onUpdate:fileList":t[6]||(t[6]=n=>s.uploadData.file=n),name:"file",accept:".pdf",headers:s.headers,"show-upload-list":!0,"custom-request":s.handleCustomRequest,"before-upload":s.beforeUpload,"max-count":1,onPreview:s.handlePreview,onChange:s.handleFileChange},{default:a(()=>[i(f,null,{default:a(()=>t[24]||(t[24]=[e("span",null,[e("i",{class:"bi bi-upload me-2"}),r("Chọn file PDF ")],-1)])),_:1})]),_:1},8,["file-list","headers","custom-request","before-upload","onPreview","onChange"])]),_:1})]),_:1},8,["model","rules"])])])]),_:1},8,["open"]),i(A,{open:s.detailModalVisible,"onUpdate:open":t[12]||(t[12]=n=>s.detailModalVisible=n),width:"600px",centered:"","z-index":1003},{title:a(()=>t[26]||(t[26]=[e("span",{class:"fw-bold"},"Chi tiết mẫu văn bản",-1)])),footer:a(()=>[e("div",Se,[s.selectedTemplate.status==="active"?(u(),_("div",ze,[s.selectedTemplate.userHasLike?(u(),T(f,{key:1,type:"primary",class:"col-3",style:{"background-color":"rgba(247, 82, 123, 0.3)",color:"#f7527b"},onClick:t[9]||(t[9]=n=>s.handleUnikeTemplate(s.selectedTemplate))},{default:a(()=>t[28]||(t[28]=[e("i",{class:"fas fa-heart me-2"},null,-1),r("Bỏ thích ")])),_:1})):(u(),T(f,{key:0,type:"primary",class:"col-3",style:{"background-color":"rgba(247, 82, 123, 0.3)"},onClick:t[8]||(t[8]=n=>s.handleLikeTemplate(s.selectedTemplate))},{default:a(()=>t[27]||(t[27]=[e("i",{class:"fa-regular fa-heart me-2"},null,-1),r("Thích ")])),_:1}))])):B("",!0),i(f,{type:"primary",class:"col-3",onClick:t[10]||(t[10]=n=>s.detailModalVisible=!1)},{default:a(()=>t[29]||(t[29]=[e("i",{class:"fa-solid fa-check me-2"},null,-1),r(" Đóng ")])),_:1})])]),default:a(()=>{var n,M,c,U;return[s.selectedTemplate?(u(),_("div",je,[e("div",Oe,[e("div",Ke,[e("h5",qe,[t[30]||(t[30]=e("i",{class:"fa-solid fa-file-text me-2"},null,-1)),r(" "+d(s.selectedTemplate.name),1)])])]),e("div",Ee,[e("div",He,[e("div",Pe,[t[31]||(t[31]=e("label",{class:"fw-bold text-muted"},"Loại văn bản:",-1)),e("div",Ge,[i(g,{class:"px-2 py-1"},{default:a(()=>{var b;return[r(d((b=s.selectedTemplate.document_type)==null?void 0:b.name),1)]}),_:1})])])]),e("div",Je,[e("div",Xe,[t[32]||(t[32]=e("label",{class:"fw-bold text-muted"},"Trạng thái:",-1)),e("div",Qe,[i(g,{color:s.getStatusColor(s.selectedTemplate.status),class:"px-2 py-1"},{default:a(()=>[r(d(s.getStatusText(s.selectedTemplate.status)),1)]),_:1},8,["color"])])])])]),e("div",We,[e("div",Ye,[e("div",Ze,[t[34]||(t[34]=e("label",{class:"fw-bold text-muted"},"Mô tả:",-1)),e("div",xe,[s.selectedTemplate.description?(u(),_("p",et,d(s.selectedTemplate.description),1)):(u(),_("p",tt,t[33]||(t[33]=[e("i",null,"Chưa có mô tả",-1)])))])])])]),e("div",st,[e("div",ot,[e("div",lt,[t[38]||(t[38]=e("label",{class:"fw-bold text-muted"},"File đính kèm:",-1)),e("div",at,[s.selectedTemplate.file_path?(u(),_("div",nt,[e("div",it,[t[35]||(t[35]=e("i",{class:"fa-solid fa-file-pdf text-danger me-2 fs-4"},null,-1)),e("div",null,[e("div",dt,d(s.getFileName(s.selectedTemplate.file_path)),1),e("small",rt,d(s.formatFileSize(s.selectedTemplate.file_size)),1)])]),e("div",ut,[i(f,{type:"link",size:"small",onClick:t[11]||(t[11]=b=>s.previewFile(s.selectedTemplate)),class:"me-2"},{default:a(()=>t[36]||(t[36]=[e("i",{class:"fa-solid fa-eye me-1"},null,-1),r(" Xem ")])),_:1})])])):(u(),_("div",ct,t[37]||(t[37]=[e("i",{class:"fa-solid fa-file-slash me-2"},null,-1),r(" Không có file đính kèm ")])))])])])]),e("div",mt,[e("div",pt,[e("div",ft,[e("div",vt,d(s.selectedTemplate.downloaded||0),1),t[39]||(t[39]=e("div",{class:"stat-label text-muted"},[e("span",{class:"text-primary"},[e("i",{class:"fa-solid fa-eye me-1"}),r(" Lượt xem ")])],-1))])]),e("div",ht,[e("div",yt,[e("div",gt,d(s.selectedTemplate.liked||0),1),t[40]||(t[40]=e("div",{class:"stat-label text-muted"},[e("span",{style:{color:"#f7527b"}},[e("i",{class:"fa-solid fa-heart me-1"}),r(" Lượt thích ")])],-1))])])]),e("div",_t,[e("div",bt,[e("div",wt,[e("div",kt,[e("div",Tt,[i(j,{src:s.getAvatarUrl((n=s.selectedTemplate.creator)==null?void 0:n.avatar,(M=s.selectedTemplate.creator)==null?void 0:M.id),size:40,class:"me-3"},{default:a(()=>{var b,L;return[r(d((L=(b=s.selectedTemplate.creator)==null?void 0:b.name)==null?void 0:L.charAt(0)),1)]}),_:1},8,["src"])]),e("div",Ct,[e("div",Ft,[e("span",null,d((c=s.selectedTemplate.creator)==null?void 0:c.name)+" - "+d((U=s.selectedTemplate.creator)==null?void 0:U.full_name_with_role),1)]),e("small",Dt," Tạo lúc: "+d(s.formatDateTime(s.selectedTemplate.created_at)),1)])])])])])])):(u(),_("div",Ut,[i(O,{size:"large"}),t[41]||(t[41]=e("div",{class:"mt-3 text-muted"},"Đang tải thông tin...",-1))]))]}),_:1},8,["open"])],64)}const Bt=de(fe,[["render",Mt]]);export{Bt as default};
