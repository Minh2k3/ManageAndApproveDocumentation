import{u as tt}from"./use-menu-DW2wxuke.js";import{_ as et,e as st,c as p,a as t,b as i,d as a,r as f,I as v,N as U,x as b,q as u,F as M,T as J,g as d,a2 as nt,z as ot,s as lt,C as at,i as it,U as dt,t as rt,k as ct,m as ut,H as D,G as mt,M as pt,D as vt,o as l,u as ft}from"./index-DelqX8ny.js";import{u as _t}from"./certificate-store-CAHJ2JJw.js";import{P as bt}from"./PDFViewer-DeO5X2qv.js";import{N as ht,r as yt}from"./ProgressDocument-5njSt4zg.js";const gt=st({components:{PDFViewer:bt,NestedProgressSteps:ht},setup(){J.extend(yt);const s=d("document"),e=d(!1);tt().onSelectedKeys(["creator-documents-detail"]);const m=nt(),L=_t(),K=ot().user,R=dt(),I=vt(),$=d([]);let _=d([]);const j=d(""),y=d(0),w=d([]),x=d([]),N=d([]),h=lt([]),B=at(()=>h.value.length>0?h.value[0].version+1:1),k=d(!1),A=d("");it(async()=>{await m.fetchDocuments(K.id),$.value=m.documents;const o=parseInt(R.params.id);_.value=$.value.find(c=>c.id===o)||null,await m.getDocumentVersions(o),h.value=rt(m.current_document_versions);for(let c=0;c<h.value.length;c++)h.value[c].document_data=JSON.parse(h.value[c].document_data);if(console.log("Document versions: ",h.value),await m.fetchDocumentComments(o),x.value=m.document_comments,console.log(x.value),console.log(_.value),j.value=_.value.file_path,y.value=_.value.process/_.value.step_count*100,await m.fetchStepsByDocumentFlowId(_.value.document_flow_id),N.value=m.current_document_flow_steps,console.log(N.value),N.value.is_completed){const c=await m.createCertificate(o);console.log("Certificate response message:",c.message),c.message&&(k.value=!0,_.value.certificate_path=c.certificate_path);const g=await L.findCertificateByDocumentId(o);console.log("Certificate found:",g),A.value=g?g.file_path:""}await m.fetchDocumentTypes(),w.value=m.document_types,console.log(w.value)});const S=d(""),n="http://localhost:8000",P=o=>o?`${n}/images/avatars/${o}`:null,r=d(null),C=d("Nhận xét"),G=async()=>{e.value=!e.value,s.value!=="comment"?(s.value="comment",C.value="Văn bản",await ut(),r.value.focus()):(s.value="document",C.value="Nhận xét")};ct(s,o=>{o!=="comment"?(e.value=!1,C.value="Nhận xét"):(e.value=!0,C.value="Văn bản")});const F=d(!1),X=(o,c=null)=>{try{F.value=!0;const g=`http://localhost:8000/documents/${o}`,V=document.createElement("a");V.href=g,V.download=c||o.split("/").pop(),V.style.display="none",document.body.appendChild(V),V.click(),document.body.removeChild(V),D.success("Đang tải file..."),setTimeout(()=>{F.value=!1},2e3)}catch(g){console.error("Error downloading file:",g),D.error("Có lỗi xảy ra khi tải file!"),F.value=!1}},z=d(!1),Q=async()=>{if(S.value===""){D.error("Vui lòng nhập bình luận");return}z.value=!0;try{const o=parseInt(R.params.id);await mt.post(`/api/documents/${o}/comments`,{comment:S.value}),D.success("Nhận xét gửi thành công"),await m.fetchDocumentComments(o),x.value=m.document_comments,S.value=""}catch(o){D.error("Có lỗi xảy ra khi gửi nhận xét"),console.error("Error sending comment:",o)}},W=o=>o>100||o==null?"https://avatar.iran.liara.run/public":`https://avatar.iran.liara.run/public/${o}`,Y=async()=>{r.value.focus()},Z=[{title:"Bản",dataIndex:"version",key:"version",width:60,customRender:({version:o})=>o+1,align:"center"},{title:"Tên văn bản",dataIndex:"title",key:"title",width:200,customHeaderCell:()=>({style:{textAlign:"center"}})},{title:"Loại văn bản",dataIndex:"type",key:"type",width:150,align:"center",responsive:["xxl"]},{title:"Trạng thái",dataIndex:"status",key:"status",width:100,align:"center"},{title:"Ngày tạo",dataIndex:"created_at",key:"created_at",width:150,align:"center"},{title:"Thao tác",key:"action",width:150,align:"center",fixed:"right"}],E=o=>{const c=w.value.find(g=>g.value===o);return c?c.label:"Không xác định"},T=d([]),H=d({visible:!1,title:"",description:"",type:"",version:0,file_path:""}),O=o=>{console.log("Changing version to:",o),T.value=JSON.parse(JSON.stringify(o.document_data)),console.log("Version data:",T.value),H.value={visible:!0,title:T.value.title,description:T.value.description,type:E(T.value.document_type_id),version:o.version,file_path:T.value.file_path}};return{user:K,document:_,pdfUrl:j,process_of_document:y,activeKey:s,commentSection:e,comment:S,document_comments:x,dayjs:J,btnCommentText:C,commentTextarea:r,isDownloading:F,document_flow_steps:N,document_versions:h,version_columns:Z,max_version:B,detailVersion:H,show_certificate:k,certificate_file_path:A,getAvatarUrl:P,randomAvatar:W,handleClickComment:G,handleClickDownload:X,handleSendComment:Q,handleFocusCommentInput:Y,customRow:o=>({onClick:()=>{O(o)},style:{cursor:"pointer"}}),mapTypeIdToName:E,changeVersion:O,createNewVersion:o=>{pt.confirm({title:"Tạo phiên bản mới",content:"Bạn có chắc chắn muốn tạo phiên bản mới từ phiên bản này?",okText:"Tạo mới",cancelText:"Hủy",onOk:()=>{try{console.log(o.document_data),o.document_data.version=o.status==="draft"?0:o.version,m.setCurrentDocumentData(o.document_data),I.push({name:"creator-documents-create"})}catch(c){console.error("Error creating new version:",c),D.error("Có lỗi xảy ra khi tạo phiên bản mới")}},onCancel:()=>{console.log("Create new version cancelled")}})}}}}),wt={class:"container-fluid"},kt={class:"container py-1"},Ct={class:"row justify-content-between gap-3"},xt={class:"col-xl-7"},Nt={class:"row"},St={class:"col text-end mb-2 mb-xl-0 align-self-top ps-3 pt-1"},Tt=["href"],Vt={key:0,class:"row"},Dt={class:"col text-end mb-2 mb-xl-0 align-self-top ps-3 pt-1"},It=["href"],$t={key:1,class:"row"},Ut={class:"col text-end mb-2 mb-xl-0 align-self-top ps-3 pt-1"},Rt=["href"],jt={class:"col"},Bt={class:"row mb-3"},At={class:"d-flex justify-content-center"},Pt={class:"fs-5 fw-bold fst-italic"},Ft={class:"row mb-3 border-1 border border-dark rounded-3 bg-light py-1"},Kt={class:"col align-self-center"},Mt={class:"col-10"},Lt={class:"row"},Et={class:"fw-bold"},Ht={class:"row"},Ot={class:"text-muted"},Jt={class:"row text-end"},qt={class:"text-muted"},Gt={key:1,class:"row mb-3"},Xt={class:"col d-flex justify-content-center"},zt={class:"row mb-3"},Qt={key:0},Wt={class:""},Yt={class:""},Zt={key:2,class:""},te={class:"col-xl"},ee={key:0,class:"row border-1 rounded-3 p-4 mb-4 bg-light"},se={class:"col"},ne={class:"row mb-3"},oe={class:"col"},le={class:"row mb-3"},ae={class:"col"},ie=["disabled"],de={key:0},re={key:1},ce={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},ue={class:"col"},me={class:"row mt-3"},pe={class:"col-8"},ve={class:"row mt-3"},fe={class:"col-8"},_e={class:"row mt-3"},be={class:"col-8"},he={class:"d-flex"},ye={class:"row mt-3"},ge={class:"col-12 mt-1"},we={class:"row mt-3"},ke={class:"col-8"},Ce={class:"row border-1 rounded-3 p-4 mb-4 bg-light"},xe={class:"col"},Ne={class:"row mb-3"},Se={class:"text-center"},Te={key:0,class:"fst-italic text-success"},Ve={key:1,class:"fst-italic text-danger"},De={key:2,class:"fst-italic text-secondary"},Ie={class:"modal-content"},$e={class:"modal-body"},Ue={class:"info-grid"},Re={class:"info-item"},je={class:"info-value"},Be={class:"info-item"},Ae={class:"info-value"},Pe={class:"info-row"},Fe={class:"info-item half"},Ke={class:"info-value"},Me={class:"document-type-badge"},Le={class:"info-item half"},Ee={class:"info-value"},He={class:"version-badge"},Oe={class:"info-item"},Je={class:"info-value"},qe=["href"],Ge={class:"modal-footer"};function Xe(s,e,m,L,q,K){const R=f("PDFViewer"),I=f("a-tab-pane"),$=f("a-avatar"),_=f("a-button"),j=f("a-empty"),y=f("a-tooltip"),w=f("a-tag"),x=f("a-space"),N=f("a-table"),h=f("a-tabs"),B=f("a-textarea"),k=f("a-input"),A=f("NestedProgressSteps"),S=f("a-modal");return l(),p(M,null,[t("div",wt,[e[36]||(e[36]=t("h2",{class:"fw-bold mb-3"},"Chi tiết văn bản",-1)),t("div",null,[t("div",kt,[t("div",Ct,[t("div",xt,[i(h,{activeKey:s.activeKey,"onUpdate:activeKey":e[0]||(e[0]=n=>s.activeKey=n),type:"card",class:"row border-1 rounded-3 p-4 mb-2 bg-light"},{default:a(()=>[i(I,{key:"document",tab:"Văn bản"},{default:a(()=>[t("div",Nt,[t("div",St,[t("label",null,[t("a",{href:`http://localhost:8000/documents/${s.document.file_path}`,target:"_blank",class:"text-decoration-none fst-italic"}," Mở tệp trong tab mới ",8,Tt)])])]),s.show_certificate?(l(),p("div",Vt,[t("div",Dt,[t("label",null,[t("a",{href:`http://localhost:8000/documents/certificates/${s.document.certificate_path}`,target:"_blank",class:"text-decoration-none fst-italic"}," Chứng chỉ số ",8,It)])])])):v("",!0),s.show_certificate?(l(),p("div",$t,[t("div",Ut,[t("label",null,[t("a",{href:`http://localhost:8000/documents/certificates/${s.certificate_file_path}`,target:"_blank",class:"text-decoration-none fst-italic"}," Văn bản đã ký số ",8,Rt)])])])):v("",!0),t("div",null,[t("div",jt,[t("div",Bt,[t("div",At,[e[10]||(e[10]=t("span",{class:"fs-5 fw-bold"},"Tên tài liệu:",-1)),e[11]||(e[11]=U("   ")),t("span",Pt,u(s.document.title),1)])])]),t("div",null,[i(R,{"pdf-url":s.pdfUrl},null,8,["pdf-url"])])])]),_:1}),i(I,{key:"comment",tab:`Nhận xét (${s.document_comments.total_current_comments})`,"force-render":""},{default:a(()=>[s.document_comments.total_current_comments>0?(l(!0),p(M,{key:0},ft(s.document_comments.current_comments,(n,P)=>(l(),p("div",{key:P},[t("div",Ft,[t("div",Kt,[n.user.avatar?(l(),b($,{key:0,class:"",src:s.getAvatarUrl(n.user.avatar)},null,8,["src"])):(l(),b($,{key:1,class:"",src:s.randomAvatar(n.user.id),alt:"Random Avatar"},null,8,["src"]))]),t("div",Mt,[t("div",Lt,[t("span",Et,u(n.user.id===s.user.id?`Tôi (${n.user.name})`:n.user.name),1)]),t("div",Ht,[t("span",Ot,u(n.content),1)]),t("div",Jt,[t("span",qt,u(n.commented_at),1)])])])]))),128)):(l(),p("div",Gt,[t("div",Xt,[i(j,{image:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNvPNFo6a-PV4l-vMo8Hcsoj5rRr2I5XIJUQ&s","image-style":{height:"50px"}},{description:a(()=>e[12]||(e[12]=[t("span",{class:"fw-bold fs-5"},"Chưa có bình luận nào",-1),t("br",null,null,-1),t("span",null,"Hãy là người đầu tiên chia sẻ ý kiến về văn bản này",-1)])),default:a(()=>[i(_,{type:"primary",onClick:s.handleFocusCommentInput},{default:a(()=>e[13]||(e[13]=[U("Nhận xét ngay")])),_:1},8,["onClick"])]),_:1})])]))]),_:1},8,["tab"]),i(I,{key:"versions",tab:`Phiên bản (${s.document.version_count})`},{default:a(()=>[e[22]||(e[22]=t("div",{class:"row mb-3"},[t("h4",{class:"fw-bold"},"Các phiên bản")],-1)),t("div",zt,[i(N,{dataSource:s.document_versions,columns:s.version_columns,scroll:{x:576},bordered:"",customRow:s.customRow,showSorterTooltip:!1,locale:{triggerDesc:"Nhấn để sắp xếp giảm dần",triggerAsc:"Nhấn để sắp xếp tăng dần",cancelSort:"Nhấn để hủy sắp xếp"}},{headerCell:a(({column:n})=>[n.key==="title"?(l(),b(y,{key:0,title:"Sắp xếp theo tên văn bản"},{default:a(()=>[t("span",null,u(n.title),1)]),_:2},1024)):n.key==="status"?(l(),b(y,{key:1,title:"Sắp xếp theo trạng thái"},{default:a(()=>[t("span",null,u(n.title),1)]),_:2},1024)):n.key==="created_at"?(l(),b(y,{key:2,title:"Sắp xếp theo ngày tạo"},{default:a(()=>[t("span",null,u(n.title),1)]),_:2},1024)):v("",!0)]),bodyCell:a(({column:n,index:P,record:r})=>[n.key==="version"?(l(),p("span",Qt,u(r.version),1)):v("",!0),n.key==="title"?(l(),b(y,{key:1},{title:a(()=>[t("span",Wt,u(r.document_data.description),1)]),default:a(()=>[t("span",Yt,u(r.document_data.title),1)]),_:2},1024)):v("",!0),n.key==="type"?(l(),p("span",Zt,u(s.mapTypeIdToName(r.document_data.document_type_id)),1)):v("",!0),n.key==="status"?(l(),p(M,{key:3},[r.status==="approved"?(l(),b(w,{key:0,color:"green"},{default:a(()=>e[14]||(e[14]=[t("span",null,"Đã duyệt",-1)])),_:1})):v("",!0),r.status==="in_review"?(l(),b(w,{key:1,color:"orange"},{default:a(()=>e[15]||(e[15]=[t("span",null,"Chờ duyệt",-1)])),_:1})):v("",!0),r.status==="rejected"?(l(),b(w,{key:2,color:"red"},{default:a(()=>e[16]||(e[16]=[t("span",null,"Bị từ chối",-1)])),_:1})):v("",!0),r.status==="draft"?(l(),b(w,{key:3,color:"blue"},{default:a(()=>e[17]||(e[17]=[t("span",null,"Bản nháp",-1)])),_:1})):v("",!0)],64)):v("",!0),n.key==="action"?(l(),b(x,{key:4,class:"d-flex justify-content-center gap-3"},{default:a(()=>[i(y,null,{title:a(()=>e[18]||(e[18]=[t("span",{class:""},"Xem chi tiết",-1)])),default:a(()=>[i(_,{onClick:C=>s.changeVersion(r),class:"bg-primary text-white"},{default:a(()=>e[19]||(e[19]=[t("i",{class:"bi bi-eye"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024),r.status==="rejected"&&r.version===s.max_version||r.status==="draft"?(l(),b(y,{key:0},{title:a(()=>e[20]||(e[20]=[t("span",{class:""},"Tạo phiên bản mới",-1)])),default:a(()=>[i(_,{onClick:C=>s.createNewVersion(r),class:"bg-success text-white"},{default:a(()=>e[21]||(e[21]=[t("i",{class:"bi bi-plus-circle"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024)):v("",!0)]),_:2},1024)):v("",!0)]),_:1},8,["dataSource","columns","customRow"])])]),_:1},8,["tab"])]),_:1},8,["activeKey"])]),t("div",te,[s.commentSection?(l(),p("div",ee,[t("div",se,[e[25]||(e[25]=t("div",{class:"row mb-3"},[t("div",{class:"col d-flex justify-content-center"},[t("span",{class:"fs-5 fw-bold"},"Nhận xét")])],-1)),t("div",ne,[t("div",oe,[i(B,{placeholder:"Nhập nhận xét của bạn",value:s.comment,"onUpdate:value":e[1]||(e[1]=n=>s.comment=n),"show-count":"",maxlength:1e3,ref:"commentTextarea"},null,8,["value"])])]),t("div",le,[t("div",ae,[t("button",{class:"border border-2 rounded-2 w-100 py-2 bg-secondary text-white button-click-effect",style:{"--bs-bg-opacity":".9"},onClick:e[2]||(e[2]=(...n)=>s.handleSendComment&&s.handleSendComment(...n)),disabled:s.loadingSendComment},[s.loadingSendComment?(l(),p("span",de,e[23]||(e[23]=[t("i",{class:"spinner-border spinner-border-sm me-2"},null,-1),U(" Đang gửi nhận xét... ")]))):(l(),p("span",re,e[24]||(e[24]=[t("i",{class:"bi bi-chat-square-dots me-2"},null,-1),U("Gửi nhận xét ")])))],8,ie)])])])])):v("",!0),t("div",ce,[t("div",ue,[e[33]||(e[33]=t("div",{class:"row mb-3"},[t("div",{class:"col d-flex justify-content-center"},[t("span",{class:"fs-5 fw-bold"},"Thông tin văn bản")])],-1)),t("div",me,[e[27]||(e[27]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Người tạo:")])],-1)),t("div",pe,[i(k,{value:s.document.creator_name,"onUpdate:value":e[3]||(e[3]=n=>s.document.creator_name=n),placeholder:"Văn bản số 1",disabled:""},null,8,["value"]),e[26]||(e[26]=t("div",{class:"w-100"},null,-1))])]),t("div",ve,[e[29]||(e[29]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Tên văn bản:")])],-1)),t("div",fe,[i(k,{value:s.document.title,"onUpdate:value":e[4]||(e[4]=n=>s.document.title=n),placeholder:"Văn bản số 1",disabled:""},null,8,["value"]),e[28]||(e[28]=t("div",{class:"w-100"},null,-1))])]),t("div",_e,[e[30]||(e[30]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Loại văn bản:")])],-1)),t("div",be,[t("div",he,[i(k,{value:s.document.type,"onUpdate:value":e[5]||(e[5]=n=>s.document.type=n),placeholder:"Love",disabled:""},null,8,["value"])])])]),t("div",ye,[e[31]||(e[31]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Mô tả:")])],-1)),t("div",ge,[i(B,{placeholder:"Mô tả đơn giản",value:s.document.description,"onUpdate:value":e[6]||(e[6]=n=>s.document.description=n),"show-count":"",maxlength:1e3,disabled:""},null,8,["value"])])]),t("div",we,[e[32]||(e[32]=t("div",{class:"col text-start mb-2 mb-xl-0 align-self-center ps-3"},[t("label",null,[t("span",null,"Ngày tạo:")])],-1)),t("div",ke,[i(k,{value:s.document.created_at,"onUpdate:value":e[7]||(e[7]=n=>s.document.created_at=n),placeholder:"Ngày chờ, tháng nhớ, năm mong",disabled:""},null,8,["value"])])])])]),t("div",Ce,[t("div",xe,[t("div",Ne,[t("div",Se,[e[34]||(e[34]=t("span",{class:"fs-5 fw-bold"},"Luồng phê duyệt",-1)),e[35]||(e[35]=t("br",null,null,-1)),s.document.status==="approved"?(l(),p("span",Te,"Đã được duyệt")):s.document.status==="rejected"?(l(),p("span",Ve,"Bị từ chối")):(l(),p("span",De,"Tiến độ: "+u(s.document_flow_steps.progress_percentage)+"%",1))]),s.document_flow_steps&&Object.keys(s.document_flow_steps).length>0?(l(),b(A,{key:0,steps:s.document_flow_steps},null,8,["steps"])):v("",!0)])])])])])])])]),i(S,{open:s.detailVersion.visible,"onUpdate:open":e[9]||(e[9]=n=>s.detailVersion.visible=n),width:"480px",zIndex:1e4,footer:null,centered:"",class:"document-modal"},{default:a(()=>[t("div",Ie,[e[43]||(e[43]=t("div",{class:"modal-header"},[t("div",{class:"header-content"},[t("span",{class:"header-icon"},"📄"),t("h3",{class:"modal-title"},"Thông tin văn bản")])],-1)),t("div",$e,[t("div",Ue,[t("div",Re,[e[37]||(e[37]=t("div",{class:"info-label"},"📝 Tiêu đề",-1)),t("div",je,u(s.detailVersion.title),1)]),t("div",Be,[e[38]||(e[38]=t("div",{class:"info-label"},"📋 Mô tả",-1)),t("div",Ae,u(s.detailVersion.description??"Không có mô tả"),1)]),t("div",Pe,[t("div",Fe,[e[39]||(e[39]=t("div",{class:"info-label"},"🏷️ Loại văn bản",-1)),t("div",Ke,[t("span",Me,u(s.detailVersion.type),1)])]),t("div",Le,[e[40]||(e[40]=t("div",{class:"info-label"},"🔢 Phiên bản",-1)),t("div",Ee,[t("span",He,"v"+u(s.detailVersion.version),1)])])]),t("div",Oe,[e[41]||(e[41]=t("div",{class:"info-label"},"📎 Tệp đính kèm",-1)),t("div",Je,[t("a",{href:`http://localhost:8000/documents/${s.detailVersion.file_path}`,target:"_blank",class:"file-link"}," 📂 Xem tệp 🔗 ",8,qe)])])])]),t("div",Ge,[i(_,{type:"primary",onClick:e[8]||(e[8]=n=>s.detailVersion.visible=!1),class:"close-button"},{default:a(()=>e[42]||(e[42]=[U(" Đóng ")])),_:1})])])]),_:1},8,["open"])],64)}const ss=et(gt,[["render",Xe],["__scopeId","data-v-a3bc5a4b"]]);export{ss as default};
