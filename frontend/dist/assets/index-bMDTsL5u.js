import{u as me}from"./use-menu-vCLX-e5I.js";import{u as ve}from"./certificate-store-DCrxrgux.js";import{_ as W,e as Z,c as x,o as b,a as l,b as i,N as o,d as a,r as d,I as H,x as j,q as h,n as B,F as he,u as we,z as ye,g,i as J,C as E,B as X,H as q}from"./index-qeq2zkB_.js";const be=Z({name:"CertificateUser",setup(){const t=ve(),e=ye(),M=g(!1),T=g(""),N=g(""),w=g([]),p=g(!1),S=g(!1),k=g(!1),m=g(!1),P=g(),c=g(),r=g([]),C=g(null);J(async()=>{await t.fetchCertificates(!1,e.user.id),r.value=t.certificates.map(n=>({id:n.id,name:n.user.name,status:n.status,issueDate:n.issued_at,expiryDate:n.expires_at,public_key:n.public_key,certificate:n.certificate,private_key:n.private_key,used_count:n.used_count,user:n.user})),C.value=r.value[0]||null});const z=E(()=>{const n=r.value.length,u=r.value.filter(v=>v.status==="active").length,$=r.value.filter(v=>v.status==="revoked").length,I=r.value.filter(v=>v.status==="request_new").length,U=r.value.filter(v=>v.status==="request_renewal").length,L=r.value.filter(v=>v.status==="expiring").length,fe=r.value.filter(v=>v.status==="expired").length;return{total:n,active:u,expiring:L,expired:fe,revoked:$,requestNew:I,requestRenewal:U}}),K=[{title:"STT",dataIndex:"id",key:"id",sorter:!0,width:50,align:"center"},{title:"Trạng thái",key:"status",dataIndex:"status",align:"center",width:150},{title:"Ngày cấp",dataIndex:"issueDate",key:"issueDate",render:n=>F(n),align:"center",width:180},{title:"Ngày hết hạn",key:"expiryDate",dataIndex:"expiryDate",render:n=>F(n),align:"center",width:180},{title:"Thao tác",key:"actions",width:150,align:"center"}],D=X({current:1,pageSize:10,total:0,showSizeChanger:!0,showQuickJumper:!0}),O={selectedRowKeys:w,onChange:n=>{w.value=n}},y=X({name:"",type:"",validityPeriod:1,description:""}),V=X({extensionPeriod:1}),R={name:[{required:!0,message:"Vui lòng nhập tên chữ ký",trigger:"blur"}],validityPeriod:[{required:!0,message:"Vui lòng chọn thời hạn",trigger:"change"}]},s={extensionPeriod:[{required:!0,message:"Vui lòng chọn thời gian gia hạn",trigger:"change"}]},f=E(()=>{let n=r.value;return N.value&&(n=n.filter(u=>u.status===N.value)),T.value&&(n=n.filter(u=>u.name.toLowerCase().includes(T.value.toLowerCase())||u.serialNumber.toLowerCase().includes(T.value.toLowerCase()))),D.total=n.length,n}),_=E(()=>r.value.filter(n=>w.value.includes(n.id))),F=n=>new Date(n).toLocaleDateString("vi-VN"),ee=n=>({active:"green",expiring:"orange",expired:"red",revoked:"grey",request_renewal:"blue",request_new:"purple"})[n]||"default",te=n=>({active:"bi bi-check-circle",expiring:"bi bi-exclamation-triangle",expired:"bi bi-x-circle",revoked:"bi bi-trash",request_renewal:"bi bi-arrow-repeat",request_new:"bi bi-plus-circle"})[n]||"bi bi-question-circle",ne=n=>({active:"Hoạt động",expiring:"Sắp hết hạn",revoked:"Bị thu hồi",expired:"Đã hết hạn",request_renewal:"Yêu cầu gia hạn",request_new:"Yêu cầu cấp mới"})[n]||"Không xác định",ae=async n=>{const u=new Date,I=new Date(n)-u,U=Math.ceil(I/(1e3*60*60*24));return U<0?(C.status!=="expired"&&(await t.changeStatus(C.id,"expired"),r.value=r.value.map(L=>(L.id===C.id&&(L.status="expired"),L))),"text-danger"):U<=30?(C.status!=="expiring"&&await t.changeStatus(C.id,"expiring"),"text-warning"):"text-success"},ie=()=>{D.current=1},le=()=>{D.current=1},se=n=>{D.current=n.current,D.pageSize=n.pageSize},G=()=>{M.value=!0,setTimeout(()=>{M.value=!1,q.success("Dữ liệu đã được cập nhật")},1e3)},oe=()=>{p.value=!0},Q=()=>{if(w.value.length===0){q.warning("Vui lòng chọn ít nhất một chữ ký để gia hạn");return}S.value=!0},re=async()=>{try{await P.value.validate(),k.value=!0,setTimeout(()=>{const n={id:Date.now(),name:y.name,serialNumber:`CKS${Date.now()}`,type:y.type,status:"active",issueDate:new Date().toISOString().split("T")[0],expiryDate:new Date(Date.now()+y.validityPeriod*365*24*60*60*1e3).toISOString().split("T")[0],description:y.description};r.value.unshift(n),p.value=!1,k.value=!1,Object.keys(y).forEach(u=>{y[u]=u==="validityPeriod"?1:""}),q.success("Tạo chữ ký số thành công!")},2e3)}catch(n){console.log("Validation failed:",n)}},ue=async()=>{try{await c.value.validate(),m.value=!0,setTimeout(()=>{w.value.forEach(n=>{const u=r.value.find($=>$.id===n);if(u){const $=new Date(u.expiryDate),I=new Date($.getTime()+V.extensionPeriod*365*24*60*60*1e3);u.expiryDate=I.toISOString().split("T")[0],u.status="active"}}),S.value=!1,m.value=!1,w.value=[],V.extensionPeriod=1,q.success("Gia hạn chữ ký số thành công!")},2e3)}catch(n){console.log("Validation failed:",n)}},Y=g(!1),A=g(null),de=n=>{Y.value=!0,A.value=n},pe=n=>{q.success(`Tải xuống chứng thư: ${n.name}`)},ge=n=>{w.value=[n.id],Q()},ce=n=>{n.status="expired",q.success(`Đã thu hồi chữ ký: ${n.name}`)};return J(()=>{G()}),{loading:M,searchText:T,filterStatus:N,selectedSignatures:w,signatures:r,statistics:z,columns:K,pagination:D,rowSelection:O,createModalVisible:p,renewModalVisible:S,modalDetailVisible:Y,selectedSignature:A,createLoading:k,renewLoading:m,createFormRef:P,renewFormRef:c,createForm:y,renewForm:V,createFormRules:R,renewFormRules:s,filteredSignatures:f,selectedSignatureDetails:_,formatDate:F,getStatusColor:ee,getStatusIcon:te,getStatusText:ne,getExpiryClass:ae,handleFilterChange:ie,handleSearch:le,handleTableChange:se,refreshData:G,showCreateModal:oe,showRenewModal:Q,handleCreateSignature:re,handleRenewSignature:ue,viewDetails:de,downloadCertificate:pe,renewSignature:ge,revokeSignature:ce}}}),Se={class:"digital-signature-manager"},ke={class:"d-flex justify-content-between align-items-center mb-4"},Ce={class:"mb-3"},De={key:0},xe={class:"mb-3"},Te={key:0},Ve={key:1};function Fe(t,e,M,T,N,w){const p=d("a-button"),S=d("a-statistic"),k=d("a-card"),m=d("a-col"),P=d("a-row"),c=d("a-select-option"),r=d("a-select"),C=d("a-input-search"),z=d("a-tag"),K=d("a-popconfirm"),D=d("a-space"),O=d("a-table"),y=d("a-form-item"),V=d("a-form"),R=d("a-modal");return b(),x("div",Se,[l("div",ke,[e[11]||(e[11]=l("h2",{class:"mb-0"},[l("i",{class:"bi bi-shield-check me-2"}),o(" Quản lý chữ ký số ")],-1)),l("div",null,[i(p,{type:"primary",onClick:t.showCreateModal,class:"me-2"},{default:a(()=>e[10]||(e[10]=[l("i",{class:"bi bi-plus-circle me-1"},null,-1),o(" Xin cấp mới chữ ký ")])),_:1},8,["onClick"])])]),i(P,{gutter:16,class:"mb-4"},{default:a(()=>[i(m,{span:6},{default:a(()=>[i(k,null,{default:a(()=>[i(S,{title:"Tổng Chữ Ký",value:t.statistics.total,"prefix-icon":"bi bi-file-earmark-text"},{prefix:a(()=>e[12]||(e[12]=[l("i",{class:"bi bi-file-earmark-text text-primary"},null,-1)])),_:1},8,["value"])]),_:1})]),_:1}),i(m,{span:6},{default:a(()=>[i(k,null,{default:a(()=>[i(S,{title:"Đang Hoạt Động",value:t.statistics.active,"value-style":"color: #3f8600"},{prefix:a(()=>e[13]||(e[13]=[l("i",{class:"bi bi-check-circle text-success"},null,-1)])),_:1},8,["value"])]),_:1})]),_:1}),i(m,{span:6},{default:a(()=>[i(k,null,{default:a(()=>[i(S,{title:"Sắp Hết Hạn",value:t.statistics.expiring,"value-style":"color: #cf1322"},{prefix:a(()=>e[14]||(e[14]=[l("i",{class:"bi bi-exclamation-triangle text-warning"},null,-1)])),_:1},8,["value"])]),_:1})]),_:1}),i(m,{span:6},{default:a(()=>[i(k,null,{default:a(()=>[i(S,{title:"Đã Hết Hạn",value:t.statistics.expired,"value-style":"color: #8c8c8c"},{prefix:a(()=>e[15]||(e[15]=[l("i",{class:"bi bi-x-circle text-danger"},null,-1)])),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),l("div",Ce,[i(P,{gutter:16,align:"middle"},{default:a(()=>[i(m,{span:6},{default:a(()=>[i(r,{value:t.filterStatus,"onUpdate:value":e[0]||(e[0]=s=>t.filterStatus=s),placeholder:"Lọc theo trạng thái",style:{width:"100%"},onChange:t.handleFilterChange},{default:a(()=>[i(c,{value:""},{default:a(()=>e[16]||(e[16]=[o("Tất cả")])),_:1}),i(c,{value:"active"},{default:a(()=>e[17]||(e[17]=[o("Hoạt động")])),_:1}),i(c,{value:"expiring"},{default:a(()=>e[18]||(e[18]=[o("Sắp hết hạn")])),_:1}),i(c,{value:"expired"},{default:a(()=>e[19]||(e[19]=[o("Đã hết hạn")])),_:1})]),_:1},8,["value","onChange"])]),_:1}),i(m,{span:8},{default:a(()=>[i(C,{value:t.searchText,"onUpdate:value":e[1]||(e[1]=s=>t.searchText=s),placeholder:"Tìm kiếm theo tên hoặc serial",onSearch:t.handleSearch,"allow-clear":""},null,8,["value","onSearch"])]),_:1}),i(m,{span:4},{default:a(()=>[i(p,{onClick:t.refreshData},{default:a(()=>e[20]||(e[20]=[l("i",{class:"bi bi-arrow-clockwise me-1"},null,-1),o(" Làm mới ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),i(O,{columns:t.columns,"data-source":t.filteredSignatures,loading:t.loading,pagination:t.pagination,"row-selection":t.rowSelection,"row-key":"id",onChange:t.handleTableChange},{bodyCell:a(({column:s,record:f,index:_})=>[s.key==="id"?(b(),x("span",De,h(_+1),1)):H("",!0),s.key==="status"?(b(),j(z,{key:1,color:t.getStatusColor(f.status)},{default:a(()=>[l("i",{class:B([t.getStatusIcon(f.status),"me-1"])},null,2),o(" "+h(t.getStatusText(f.status)),1)]),_:2},1032,["color"])):H("",!0),s.key==="expiryDate"?(b(),x("span",{key:2,class:B(t.getExpiryClass(f.expiryDate))},h(f.expiryDate),3)):H("",!0),s.key==="actions"?(b(),j(D,{key:3},{default:a(()=>[i(p,{type:"link",size:"small",onClick:F=>t.viewDetails(f)},{default:a(()=>e[21]||(e[21]=[l("i",{class:"bi bi-eye"},null,-1)])),_:2},1032,["onClick"]),i(p,{type:"link",size:"small",onClick:F=>t.renewSignature(f),disabled:f.status==="active"},{default:a(()=>e[22]||(e[22]=[l("i",{class:"bi bi-arrow-repeat"},null,-1)])),_:2},1032,["onClick","disabled"]),i(K,{title:"Bạn có chắc chắn muốn thu hồi chữ ký này?",onConfirm:F=>t.revokeSignature(f),placement:"topRight"},{default:a(()=>[i(p,{type:"link",size:"small",danger:"",disabled:f.status==="expired"},{default:a(()=>e[23]||(e[23]=[l("i",{class:"bi bi-trash"},null,-1)])),_:2},1032,["disabled"])]),_:2},1032,["onConfirm"])]),_:2},1024)):H("",!0)]),_:1},8,["columns","data-source","loading","pagination","row-selection","onChange"]),i(R,{open:t.createModalVisible,"onUpdate:open":e[4]||(e[4]=s=>t.createModalVisible=s),title:"Xin Cấp Mới Chữ Ký Số",width:"350px",onOk:t.handleCreateSignature,"confirm-loading":t.createLoading,"z-index":"10000"},{footer:a(()=>[i(p,{onClick:e[3]||(e[3]=s=>t.createModalVisible=!1)},{default:a(()=>e[27]||(e[27]=[o("Đóng")])),_:1}),i(p,{type:"primary",onClick:t.handleCreateSignature,loading:t.createLoading},{default:a(()=>e[28]||(e[28]=[o(" Xin Cấp Mới ")])),_:1},8,["onClick","loading"])]),default:a(()=>[i(V,{ref:"createFormRef",model:t.createForm,rules:t.createFormRules,layout:"vertical"},{default:a(()=>[i(y,{label:"Thời hạn (năm)",name:"validityPeriod"},{default:a(()=>[i(r,{value:t.createForm.validityPeriod,"onUpdate:value":e[2]||(e[2]=s=>t.createForm.validityPeriod=s),placeholder:"Chọn thời hạn","dropdown-style":{position:"absolute",zIndex:1e4,background:"white",border:"1px solid #ccc"}},{default:a(()=>[i(c,{value:1},{default:a(()=>e[24]||(e[24]=[o("1 năm")])),_:1}),i(c,{value:2},{default:a(()=>e[25]||(e[25]=[o("2 năm")])),_:1}),i(c,{value:3},{default:a(()=>e[26]||(e[26]=[o("3 năm")])),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","onOk","confirm-loading"]),i(R,{open:t.renewModalVisible,"onUpdate:open":e[6]||(e[6]=s=>t.renewModalVisible=s),title:"Gia Hạn Chữ Ký Số",width:"500px",onOk:t.handleRenewSignature,"confirm-loading":t.renewLoading},{default:a(()=>[l("div",xe,[e[29]||(e[29]=l("p",null,[l("strong",null,"Chữ ký được chọn:")],-1)),l("ul",null,[(b(!0),x(he,null,we(t.selectedSignatureDetails,s=>(b(),x("li",{key:s.id},h(s.name)+" - "+h(s.serialNumber),1))),128))])]),i(V,{ref:"renewFormRef",model:t.renewForm,rules:t.renewFormRules,layout:"vertical"},{default:a(()=>[i(y,{label:"Thời gian gia hạn (năm)",name:"extensionPeriod"},{default:a(()=>[i(r,{value:t.renewForm.extensionPeriod,"onUpdate:value":e[5]||(e[5]=s=>t.renewForm.extensionPeriod=s),placeholder:"Chọn thời gian gia hạn"},{default:a(()=>[i(c,{value:1},{default:a(()=>e[30]||(e[30]=[o("1 năm")])),_:1}),i(c,{value:2},{default:a(()=>e[31]||(e[31]=[o("2 năm")])),_:1}),i(c,{value:3},{default:a(()=>e[32]||(e[32]=[o("3 năm")])),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","onOk","confirm-loading"]),i(R,{open:t.modalDetailVisible,"onUpdate:open":e[8]||(e[8]=s=>t.modalDetailVisible=s),title:"Chi Tiết Chữ Ký Số",width:"600px",onCancel:e[9]||(e[9]=s=>t.modalDetailVisible=!1),"z-index":"10000"},{footer:a(()=>[i(p,{type:"primary",onClick:e[7]||(e[7]=s=>t.modalDetailVisible=!1)},{default:a(()=>e[39]||(e[39]=[o("Đóng")])),_:1})]),default:a(()=>[t.selectedSignature?(b(),x("div",Te,[l("p",null,[e[33]||(e[33]=l("strong",null,"Người sở hữu:",-1)),o(" "+h(t.selectedSignature.user.name)+" - "+h(t.selectedSignature.user.position_title),1)]),l("p",null,[e[34]||(e[34]=l("strong",null,"Trạng thái: ",-1)),i(z,{color:t.getStatusColor(t.selectedSignature.status)},{default:a(()=>[l("i",{class:B([t.getStatusIcon(t.selectedSignature.status),"me-1"])},null,2),o(" "+h(t.getStatusText(t.selectedSignature.status)),1)]),_:1},8,["color"])]),l("p",null,[e[35]||(e[35]=l("strong",null,"Số lượt ký:",-1)),o(" "+h(t.selectedSignature.used_count),1)]),l("p",null,[e[36]||(e[36]=l("strong",null,"Ngày cấp:",-1)),o(" "+h(t.selectedSignature.issueDate),1)]),l("p",null,[e[37]||(e[37]=l("strong",null,"Ngày hết hạn:",-1)),o(" "+h(t.selectedSignature.expiryDate),1)])])):(b(),x("div",Ve,e[38]||(e[38]=[l("p",null,"Không có thông tin chi tiết.",-1)])))]),_:1},8,["open"])])}const $e=W(be,[["render",Fe],["__scopeId","data-v-e356a7a4"]]),qe=Z({components:{CertificateUser:$e},setup(){me().onSelectedKeys(["creator-signatures"])}});function Me(t,e,M,T,N,w){const p=d("CertificateUser");return b(),j(p)}const Ie=W(qe,[["render",Me]]);export{Ie as default};
